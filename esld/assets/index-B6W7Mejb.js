var Z=Object.defineProperty;var tt=(c,t,e)=>t in c?Z(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var l=(c,t,e)=>tt(c,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class et{constructor(){l(this,"listeners",{})}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}off(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(i=>i!==e))}emit(t,e){this.listeners[t]&&this.listeners[t].forEach(i=>i(e))}}const m=new et;class it{constructor(){l(this,"activeTool",null);l(this,"tools",new Map)}registerTool(t){this.tools.set(t.name,t)}getTool(t){return this.tools.get(t)}getActiveToolName(){var t;return(t=this.activeTool)==null?void 0:t.name}activateTool(t){const e=this.tools.get(t);if(!e){console.warn(`Tool ${t} not found`);return}this.activeTool&&this.activeTool.deactivate(),this.activeTool=e,this.activeTool.activate(),m.emit("tool:activated",t),console.log(`Switched to tool: ${t}`)}onMouseDown(t){var e;(e=this.activeTool)==null||e.onMouseDown(t)}onMouseMove(t){var e;(e=this.activeTool)==null||e.onMouseMove(t)}onMouseUp(t){var e;(e=this.activeTool)==null||e.onMouseUp(t)}}var u=(c=>(c.Bus="BusElement",c.Breaker="BreakerElement",c.Generator="GeneratorElement",c.Wire="WireElement",c.Transformer="TransformerElement",c.Load="LoadElement",c.Junction="JunctionElement",c))(u||{}),p=(c=>(c.Top="top",c.Bottom="bottom",c.Left="left",c.Right="right",c))(p||{});class k{constructor(t){l(this,"id");l(this,"x");l(this,"y");l(this,"rotation");l(this,"name");l(this,"description");l(this,"isEnergized",!1);this.id=t.id||crypto.randomUUID(),this.x=t.x,this.y=t.y,this.rotation=t.rotation||0,this.name=t.name||"Element",this.description=t.description||""}getTransformedPoint(t,e){const i=this.rotation*Math.PI/180,s=Math.cos(i),o=Math.sin(i),n=t*s-e*o,r=t*o+e*s;return{x:this.x+n,y:this.y+r}}getPortDirection(t){const e=[p.Top,p.Right,p.Bottom,p.Left],i=e.indexOf(t);if(i===-1)return t;const s=Math.round(this.rotation/90)%4,o=(i+s)%4;return e[o]}toJSON(){return{id:this.id,x:this.x,y:this.y,rotation:this.rotation,name:this.name,description:this.description,type:this.type}}}class E extends k{constructor(e){super(e);l(this,"type",u.Wire);l(this,"x2");l(this,"y2");l(this,"points",[]);l(this,"sourcePortId",null);l(this,"targetPortId",null);l(this,"sourceDirection",null);l(this,"targetDirection",null);this.x2=e.x2,this.y2=e.y2,this.sourcePortId=e.sourcePortId||null,this.targetPortId=e.targetPortId||null,this.sourceDirection=e.sourceDirection||null,this.targetDirection=e.targetDirection||null}setEnd(e,i,s){this.x2=e,this.y2=i,s?this.targetDirection=s:this.targetDirection=null}getPorts(){return[]}toJSON(){return{...super.toJSON(),type:u.Wire,x2:this.x2,y2:this.y2,sourcePortId:this.sourcePortId,targetPortId:this.targetPortId,sourceDirection:this.sourceDirection,targetDirection:this.targetDirection}}}class O extends k{constructor(e){super(e);l(this,"type",u.Generator);l(this,"isOn",!0);this.isOn=e.isOn??!0}getPorts(){const i=this.getTransformedPoint(0,20);return[{id:`${this.id}:bottom`,elementId:this.id,x:i.x,y:i.y,direction:this.getPortDirection(p.Bottom)}]}toJSON(){return{...super.toJSON(),type:u.Generator,isOn:this.isOn}}}class W extends k{constructor(e){super(e);l(this,"type",u.Breaker);l(this,"isOpen",!1);this.isOpen=e.isOpen??!1}getPorts(){const i=this.getTransformedPoint(0,-10),s=this.getTransformedPoint(0,20/2);return[{id:`${this.id}:top`,elementId:this.id,x:i.x,y:i.y,direction:this.getPortDirection(p.Top)},{id:`${this.id}:bottom`,elementId:this.id,x:s.x,y:s.y,direction:this.getPortDirection(p.Bottom)}]}toJSON(){return{...super.toJSON(),type:u.Breaker,isOpen:this.isOpen}}}class st{static run(t){const e=new Set,i=new Set,s=[],o=new Map;for(t.forEach(a=>{o.has(a.id)||o.set(a.id,[])}),t.filter(a=>a instanceof E).forEach(a=>{if(a.sourcePortId&&a.targetPortId){const d=a.sourcePortId.split(":")[0],h=a.targetPortId.split(":")[0];o.has(d)&&o.has(h)&&(o.get(d).push(h),o.get(h).push(d),o.get(d).push(a.id),o.get(h).push(a.id),o.has(a.id)||o.set(a.id,[]),o.get(a.id).push(d),o.get(a.id).push(h))}}),t.filter(a=>a instanceof O&&a.isOn).forEach(a=>{s.push(a),i.add(a.id),e.add(a.id)});s.length>0;){const a=s.shift();let d=!0;if(a instanceof W&&a.isOpen&&(d=!1),!d)continue;const h=o.get(a.id)||[];for(const g of h)if(!i.has(g)){const f=t.find(v=>v.id===g);f&&(i.add(g),e.add(g),s.push(f))}}return e}}class A extends k{constructor(e){super(e);l(this,"type",u.Bus);l(this,"length");this.length=e.length||100}getPorts(){const e=[],i=this.length/2,s=20,o=(r,a,d)=>{const h=this.getTransformedPoint(a,0);e.push({id:`${this.id}:${r}`,elementId:this.id,x:h.x,y:h.y,direction:d?this.getPortDirection(d):void 0})};o(p.Left,-i,p.Left),o("center",0),o(p.Right,i,p.Right);const n=Math.floor((i-1)/s);for(let r=1;r<=n;r++)o(`${r*s}`,r*s),o(`${-r*s}`,-r*s);return e}getPreferredPortDirection(e,i){const o=this.getPorts().find(a=>a.id===e);if(!o)return;if(o.direction)return o.direction;const n=(this.rotation%360+360)%360;return n>=45&&n<135||n>=225&&n<315?i.x<o.x?p.Left:p.Right:i.y<o.y?p.Top:p.Bottom}toJSON(){return{...super.toJSON(),type:u.Bus,length:this.length}}}class _ extends k{constructor(e){super(e);l(this,"type",u.Transformer)}getPorts(){const i=this.getTransformedPoint(0,-30),s=this.getTransformedPoint(0,15*2);return[{id:`${this.id}:top`,elementId:this.id,x:i.x,y:i.y,direction:this.getPortDirection(p.Top)},{id:`${this.id}:bottom`,elementId:this.id,x:s.x,y:s.y,direction:this.getPortDirection(p.Bottom)}]}toJSON(){return{...super.toJSON(),type:u.Transformer}}}class F extends k{constructor(e){super(e);l(this,"type",u.Load)}getPorts(){const e=this.getTransformedPoint(0,-15);return[{id:`${this.id}:top`,elementId:this.id,x:e.x,y:e.y,direction:this.getPortDirection(p.Top)}]}toJSON(){return{...super.toJSON(),type:u.Load}}}class K extends k{constructor(e){super(e);l(this,"type",u.Junction)}getPorts(){return[{id:`${this.id}:center`,elementId:this.id,x:this.x,y:this.y}]}toJSON(){return{...super.toJSON(),type:u.Junction}}}class j{static create(t){let e=null;switch(t.type){case u.Bus:e=new A({id:t.id,x:t.x,y:t.y,length:t.length});break;case u.Breaker:e=new W({id:t.id,x:t.x,y:t.y,isOpen:t.isOpen});break;case u.Transformer:e=new _({id:t.id,x:t.x,y:t.y});break;case u.Generator:e=new O({id:t.id,x:t.x,y:t.y,isOn:t.isOn});break;case u.Load:e=new F({id:t.id,x:t.x,y:t.y});break;case u.Junction:e=new K({id:t.id,x:t.x,y:t.y});break;case u.Wire:e=new E({id:t.id,x:t.x,y:t.y,x2:t.x2,y2:t.y2,sourcePortId:t.sourcePortId||void 0,targetPortId:t.targetPortId||void 0,sourceDirection:t.sourceDirection||void 0,targetDirection:t.targetDirection||void 0});break}return e&&(e.rotation=t.rotation||0,e.name=t.name||"Element",e.description=t.description||""),e}static createDefault(t,e,i){return this.create({type:t,x:e,y:i})}}class nt{constructor(){l(this,"elements",new Map);l(this,"isSimulationMode",!1)}startSimulation(){this.isSimulationMode=!0,this.runSimulation(),this.notifyAllElements()}stopSimulation(){this.isSimulationMode=!1,this.notifyAllElements()}notifyAllElements(){this.elements.forEach(t=>{m.emit("element:modified",t)})}runSimulation(){const t=st.run(Array.from(this.elements.values()));this.elements.forEach(e=>{const i=e.isEnergized;e.isEnergized=t.has(e.id),i!==e.isEnergized&&m.emit("element:modified",e)}),m.emit("simulation:updated",void 0)}addElement(t){this.elements.set(t.id,t),m.emit("element:added",t)}removeElement(t){const e=this.elements.get(t);e&&(this.elements.delete(t),m.emit("element:removed",e))}getElement(t){return this.elements.get(t)}getAllElements(){return Array.from(this.elements.values())}save(){const t=Array.from(this.elements.values()).map(e=>e.toJSON());return JSON.stringify(t,null,2)}load(t){this.elements.clear(),m.emit("project:cleared",void 0);try{const e=JSON.parse(t);if(!Array.isArray(e))throw new Error("Invalid format");e.forEach(i=>{const s=j.create(i);s&&this.addElement(s)}),console.log("Project loaded successfully")}catch(e){console.error("Failed to load project",e)}}}const y=new nt;class ot{constructor(){l(this,"undoStack",[]);l(this,"redoStack",[])}execute(t){t.execute(),this.undoStack.push(t),this.redoStack=[],console.log("Command executed. Undo stack:",this.undoStack.length),m.emit("history:changed",void 0)}undo(){const t=this.undoStack.pop();t&&(t.undo(),this.redoStack.push(t),console.log("Undone"),m.emit("history:changed",void 0))}redo(){const t=this.redoStack.pop();t&&(t.execute(),this.undoStack.push(t),console.log("Redone"),m.emit("history:changed",void 0))}}const C=new ot;class rt{constructor(t,e){l(this,"element");l(this,"secondaryElements");this.element=t,this.secondaryElements=e}execute(){this.remove(this.element),this.secondaryElements.forEach(t=>this.remove(t))}undo(){this.restore(this.element),this.secondaryElements.forEach(t=>this.restore(t))}remove(t){y.removeElement(t.id),m.emit("element:removed",t)}restore(t){y.addElement(t),m.emit("element:added",t)}}class at{constructor(t,e,i,s,o){l(this,"element");l(this,"oldX");l(this,"oldY");l(this,"newX");l(this,"newY");this.element=t,this.oldX=e,this.oldY=i,this.newX=s,this.newY=o}execute(){this.element.x=this.newX,this.element.y=this.newY,m.emit("element:modified",this.element),this.updateConnectedWires()}undo(){this.element.x=this.oldX,this.element.y=this.oldY,m.emit("element:modified",this.element),this.updateConnectedWires()}updateConnectedWires(){const t=y.getAllElements().filter(n=>n instanceof E),e=n=>n&&n.startsWith(`${this.element.id}:`),i=this.element.getPorts(),s=new Map(i.map(n=>[n.id,n])),o=this.element instanceof A;t.forEach(n=>{let r=!1;if(e(n.sourcePortId)){const a=s.get(n.sourcePortId);if(a){n.x=a.x,n.y=a.y;let d=a.direction;if(!d&&o&&(d=this.element.getPreferredPortDirection(a.id,{x:n.x2,y:n.y2})),n.sourceDirection=d||null,r=!0,n.targetPortId){const h=n.targetPortId.split(":")[0],g=y.getElement(h);if(g&&g instanceof A){const f=g.getPreferredPortDirection(n.targetPortId,{x:n.x,y:n.y});f&&(n.targetDirection=f,r=!0)}}}}if(e(n.targetPortId)){const a=s.get(n.targetPortId);if(a){let d=a.direction;if(!d&&o&&(d=this.element.getPreferredPortDirection(a.id,{x:n.x,y:n.y})),n.setEnd(a.x,a.y,d),r=!0,n.sourcePortId){const h=n.sourcePortId.split(":")[0],g=y.getElement(h);if(g&&g instanceof A){const f=g.getPreferredPortDirection(n.sourcePortId,{x:n.x2,y:n.y2});f&&(n.sourceDirection=f,r=!0)}}}}r&&m.emit("element:modified",n)})}}class ct{constructor(t){l(this,"elements");this.elements=t}execute(){this.elements.forEach(t=>{y.addElement(t)})}undo(){this.elements.forEach(t=>{y.removeElement(t.id)})}}class R{static copy(t){if(t.length===0){this.buffer=null;return}const e=t.map(i=>i.toJSON());this.buffer=JSON.stringify(e),console.log(`Copied ${t.length} elements to clipboard`)}static paste(){if(!this.buffer)return[];try{const t=JSON.parse(this.buffer);if(!Array.isArray(t))return[];const e=new Map,i=[];return t.forEach(s=>{const o=s.id,n=j.create(s);if(n){const r=crypto.randomUUID();n.id=r,n.x+=this.pasteOffset,n.y+=this.pasteOffset,o&&e.set(o,r),i.push(n)}}),i.forEach(s=>{if(s instanceof E){if(s.sourcePortId){const[o,n]=this.parsePortId(s.sourcePortId);if(e.has(o)){const r=e.get(o);s.sourcePortId=n?`${r}:${n}`:r}}if(s.targetPortId){const[o,n]=this.parsePortId(s.targetPortId);if(e.has(o)){const r=e.get(o);s.targetPortId=n?`${r}:${n}`:r}}}}),this.pasteOffset+=20,this.pasteOffset>100&&(this.pasteOffset=20),i}catch(t){return console.error("Failed to paste from clipboard",t),[]}}static parsePortId(t){const e=t.split(":");return e.length>1?[e[0],e.slice(1).join(":")]:[t,null]}}l(R,"buffer",null),l(R,"pasteOffset",20);class lt{constructor(t,e,i,s,o,n,r){l(this,"element");l(this,"oldX");l(this,"oldY");l(this,"oldLength");l(this,"newX");l(this,"newY");l(this,"newLength");this.element=t,this.oldX=e,this.oldY=i,this.oldLength=s,this.newX=o,this.newY=n,this.newLength=r}execute(){this.update(this.newX,this.newY,this.newLength)}undo(){this.update(this.oldX,this.oldY,this.oldLength)}update(t,e,i){this.element.x=t,this.element.y=e,this.element.length=i,m.emit("element:modified",this.element),this.updateConnectedWires()}updateConnectedWires(){const t=y.getAllElements().filter(o=>o instanceof E),e=o=>o&&o.startsWith(`${this.element.id}:`),i=this.element.getPorts(),s=new Map(i.map(o=>[o.id,o]));t.forEach(o=>{let n=!1;if(e(o.sourcePortId)){const r=s.get(o.sourcePortId);if(r){o.x=r.x,o.y=r.y;let a=r.direction;if(a||(a=this.element.getPreferredPortDirection(r.id,{x:o.x2,y:o.y2})),o.sourceDirection=a||null,n=!0,o.targetPortId){const d=o.targetPortId.split(":")[0],h=y.getElement(d);if(h&&h instanceof A){const g=h.getPreferredPortDirection(o.targetPortId,{x:o.x,y:o.y});g&&(o.targetDirection=g,n=!0)}}}}if(e(o.targetPortId)){const r=s.get(o.targetPortId);if(r){let a=r.direction;if(a||(a=this.element.getPreferredPortDirection(r.id,{x:o.x,y:o.y})),o.setEnd(r.x,r.y,a),n=!0,o.sourcePortId){const d=o.sourcePortId.split(":")[0],h=y.getElement(d);if(h&&h instanceof A){const g=h.getPreferredPortDirection(o.sourcePortId,{x:o.x2,y:o.y2});g&&(o.sourceDirection=g,n=!0)}}}}n&&m.emit("element:modified",o)})}}class dt{constructor(t){l(this,"name","select");l(this,"isPanning",!1);l(this,"panStartX",0);l(this,"panStartY",0);l(this,"selectedElements",[]);l(this,"isDragging",!1);l(this,"dragStartX",0);l(this,"dragStartY",0);l(this,"elementStartPositions",new Map);l(this,"svg");l(this,"interactionGroup");l(this,"highlightGroup");l(this,"view");l(this,"updateFn");l(this,"projectRenderer");l(this,"isSelecting",!1);l(this,"selectionStartX",0);l(this,"selectionStartY",0);l(this,"selectionBox");l(this,"resizeHandles",[]);l(this,"activeHandle",null);l(this,"initialLength",0);l(this,"initialX",0);l(this,"initialY",0);l(this,"onElementModified",t=>{this.selectedElements.some(e=>e.id===t.id)&&this.updateHighlights()});l(this,"onKeyDown",t=>{var i;const e=(i=document.activeElement)==null?void 0:i.tagName.toLowerCase();if(!(e==="input"||e==="textarea")&&((t.key==="Delete"||t.key==="Backspace")&&this.deleteSelection(),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="c"&&(t.preventDefault(),R.copy(this.selectedElements)),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="v")){t.preventDefault();const s=R.paste();if(s.length>0){const o=new ct(s);C.execute(o),this.selectedElements=s,this.updateHighlights(),m.emit("selection:changed",this.selectedElements)}}});this.svg=t.getSvg(),this.interactionGroup=t.getInteractionGroup(),this.view=t.getView(),this.updateFn=()=>t.updateView(),this.projectRenderer=t.getProjectRenderer(),this.highlightGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.interactionGroup.appendChild(this.highlightGroup),this.selectionBox=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.selectionBox.setAttribute("fill","rgba(0, 120, 215, 0.1)"),this.selectionBox.setAttribute("stroke","rgba(0, 120, 215, 0.5)"),this.selectionBox.setAttribute("stroke-width","1"),this.selectionBox.setAttribute("display","none"),this.interactionGroup.appendChild(this.selectionBox);for(let e=0;e<2;e++){const i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("width","10"),i.setAttribute("height","10"),i.setAttribute("fill","white"),i.setAttribute("stroke","#0078d7"),i.setAttribute("stroke-width","1"),i.setAttribute("display","none"),i.style.cursor="ew-resize",i.style.pointerEvents="all",this.interactionGroup.appendChild(i),this.resizeHandles.push(i)}}activate(){this.svg.style.cursor="default",window.addEventListener("keydown",this.onKeyDown),m.on("element:modified",this.onElementModified)}deactivate(){this.isPanning=!1,this.isDragging=!1,this.isSelecting=!1,this.clearSelection(),window.removeEventListener("keydown",this.onKeyDown),m.off("element:modified",this.onElementModified)}deleteSelection(){if(this.selectedElements.length===0)return;[...this.selectedElements].forEach(e=>{const i=[];e instanceof E||y.getAllElements().filter(n=>n instanceof E).forEach(n=>{e.getPorts().some(r=>n.sourcePortId===r.id||n.targetPortId===r.id)&&i.push(n)});const s=new rt(e,i);C.execute(s)}),this.selectedElements=[],this.updateHighlights(),m.emit("selection:changed",[]),console.log("Deleted elements")}clearSelection(){this.selectedElements=[],this.updateHighlights(),m.emit("selection:changed",[])}updateHighlights(){if(this.highlightGroup.innerHTML="",this.resizeHandles.forEach(t=>t.setAttribute("display","none")),this.selectedElements.forEach(t=>{const e=this.projectRenderer.getView(t.id);if(!e)return;const i=e.getBBox(),s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x",`${i.x-5}`),s.setAttribute("y",`${i.y-5}`),s.setAttribute("width",`${i.width+10}`),s.setAttribute("height",`${i.height+10}`),s.setAttribute("fill","rgba(0, 120, 215, 0.1)"),s.setAttribute("stroke","#0078d7"),s.setAttribute("stroke-width","2"),s.setAttribute("stroke-dasharray","4"),s.style.pointerEvents="none",s.setAttribute("transform",`translate(${t.x}, ${t.y}) rotate(${t.rotation})`),this.highlightGroup.appendChild(s)}),this.selectedElements.length===1&&this.selectedElements[0]instanceof A){const e=this.selectedElements[0].getPorts(),i=e.find(o=>o.id.endsWith(`:${p.Left}`)),s=e.find(o=>o.id.endsWith(`:${p.Right}`));if(i&&s){const o=10/this.view.scale,n=o/2,r=(a,d,h)=>{a.setAttribute("width",`${o}`),a.setAttribute("height",`${o}`),a.setAttribute("x",`${d-n}`),a.setAttribute("y",`${h-n}`),a.setAttribute("display","block")};r(this.resizeHandles[0],i.x,i.y),r(this.resizeHandles[1],s.x,s.y)}}}findElementFromTarget(t){if(!(t instanceof Element))return null;let e=t;for(;e&&e!==this.svg;){if(e.tagName==="g"&&e.hasAttribute("id")){const i=e.getAttribute("id");if(i)return y.getElement(i)||null}e=e.parentElement}return null}getWorldPosition(t){const e=this.svg.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top;return{x:(i-this.view.x)/this.view.scale,y:(s-this.view.y)/this.view.scale}}selectElements(t){const e=t.map(i=>y.getElement(i)).filter(i=>!!i);e.length>0&&(this.selectedElements=e,this.updateHighlights(),m.emit("selection:changed",this.selectedElements))}onMouseDown(t){if(t.button===1){this.startPan(t);return}if(t.button===0){if(this.resizeHandles.includes(t.target)){const i=this.resizeHandles.indexOf(t.target);if(this.activeHandle=i===0?"left":"right",this.selectedElements.length===1&&this.selectedElements[0]instanceof A){const s=this.selectedElements[0];this.initialLength=s.length,this.initialX=s.x,this.initialY=s.y}return}const e=this.findElementFromTarget(t.target);if(e){t.shiftKey?(this.selectedElements.includes(e)?this.selectedElements=this.selectedElements.filter(s=>s!==e):this.selectedElements.push(e),this.updateHighlights(),m.emit("selection:changed",this.selectedElements)):this.selectedElements.includes(e)||(this.selectedElements=[e],this.updateHighlights(),m.emit("selection:changed",this.selectedElements)),this.isDragging=!0;const i=this.getWorldPosition(t);this.dragStartX=i.x,this.dragStartY=i.y,this.elementStartPositions.clear(),this.selectedElements.forEach(s=>{this.elementStartPositions.set(s.id,{x:s.x,y:s.y})})}else{t.shiftKey||this.clearSelection(),this.isSelecting=!0;const i=this.getWorldPosition(t);this.selectionStartX=i.x,this.selectionStartY=i.y,this.selectionBox.setAttribute("x",`${i.x}`),this.selectionBox.setAttribute("y",`${i.y}`),this.selectionBox.setAttribute("width","0"),this.selectionBox.setAttribute("height","0"),this.selectionBox.setAttribute("display","block")}}}startPan(t){this.isPanning=!0,this.panStartX=t.clientX,this.panStartY=t.clientY,this.svg.style.cursor="grabbing"}onMouseMove(t){if(this.isPanning){const e=t.clientX-this.panStartX,i=t.clientY-this.panStartY;this.view.x+=e,this.view.y+=i,this.panStartX=t.clientX,this.panStartY=t.clientY,this.updateFn();return}if(this.activeHandle){const e=this.getWorldPosition(t);if(this.selectedElements.length===1&&this.selectedElements[0]instanceof A){const i=this.selectedElements[0],s=i.length,o=i.rotation*Math.PI/180,n=Math.cos(o),r=Math.sin(o),a=s/2;let d=s,h=i.x,g=i.y;if(this.activeHandle==="right"){const f=i.x-a*n,v=i.y-a*r,b=e.x-f,S=e.y-v,w=b*n+S*r,x=Math.max(20,Math.round(w/20)*20);x!==s&&(d=x,h=f+d/2*n,g=v+d/2*r)}else{const f=i.x+a*n,v=i.y+a*r,b=f-e.x,S=v-e.y,w=b*n+S*r,x=Math.max(20,Math.round(w/20)*20);x!==s&&(d=x,h=f-d/2*n,g=v-d/2*r)}(d!==i.length||h!==i.x||g!==i.y)&&(i.length=d,i.x=h,i.y=g,m.emit("element:modified",i),this.updateConnectedWires(i),this.updateHighlights())}return}if(this.isSelecting){const e=this.getWorldPosition(t),i=Math.min(this.selectionStartX,e.x),s=Math.min(this.selectionStartY,e.y),o=Math.abs(e.x-this.selectionStartX),n=Math.abs(e.y-this.selectionStartY);this.selectionBox.setAttribute("x",`${i}`),this.selectionBox.setAttribute("y",`${s}`),this.selectionBox.setAttribute("width",`${o}`),this.selectionBox.setAttribute("height",`${n}`);return}if(this.isDragging&&this.selectedElements.length>0){const e=this.getWorldPosition(t),i=e.x-this.dragStartX,s=e.y-this.dragStartY;this.selectedElements.forEach(o=>{if(o instanceof E)return;const n=this.elementStartPositions.get(o.id);if(!n)return;let r=n.x+i,a=n.y+s;r=Math.round(r/20)*20,a=Math.round(a/20)*20,(r!==o.x||a!==o.y)&&(o.x=r,o.y=a,this.projectRenderer.updateViewTransform(o.id,`translate(${o.x}, ${o.y}) rotate(${o.rotation})`),m.emit("element:modified",o),this.updateConnectedWires(o),this.updateHighlights())})}}updateConnectedWires(t){const e=y.getAllElements().filter(r=>r instanceof E),i=r=>r&&r.startsWith(`${t.id}:`),s=t.getPorts(),o=new Map(s.map(r=>[r.id,r])),n=t instanceof A;e.forEach(r=>{let a=!1;if(i(r.sourcePortId)){const d=o.get(r.sourcePortId);if(d){r.x=d.x,r.y=d.y;let h=d.direction;if(!h&&n&&(h=t.getPreferredPortDirection(d.id,{x:r.x2,y:r.y2})),r.sourceDirection=h||null,a=!0,r.targetPortId){const g=r.targetPortId.split(":")[0],f=y.getElement(g);if(f&&f instanceof A){const v=f.getPreferredPortDirection(r.targetPortId,{x:r.x,y:r.y});v&&(r.targetDirection=v,a=!0)}}}}if(i(r.targetPortId)){const d=o.get(r.targetPortId);if(d){let h=d.direction;if(!h&&n&&(h=t.getPreferredPortDirection(d.id,{x:r.x,y:r.y})),r.setEnd(d.x,d.y,h),a=!0,r.sourcePortId){const g=r.sourcePortId.split(":")[0],f=y.getElement(g);if(f&&f instanceof A){const v=f.getPreferredPortDirection(r.sourcePortId,{x:r.x2,y:r.y2});v&&(r.sourceDirection=v,a=!0)}}}}a&&m.emit("element:modified",r)})}onMouseUp(t){if(this.activeHandle){if(this.activeHandle=null,this.svg.style.cursor="default",this.selectedElements.length===1&&this.selectedElements[0]instanceof A){const e=this.selectedElements[0];if(e.length!==this.initialLength||e.x!==this.initialX||e.y!==this.initialY){const i=new lt(e,this.initialX,this.initialY,this.initialLength,e.x,e.y,e.length);C.execute(i),console.log("Resize recorded")}}this.updateHighlights();return}if(this.isSelecting){this.isSelecting=!1,this.selectionBox.setAttribute("display","none");const e=parseFloat(this.selectionBox.getAttribute("x")||"0"),i=parseFloat(this.selectionBox.getAttribute("y")||"0"),s=parseFloat(this.selectionBox.getAttribute("width")||"0"),o=parseFloat(this.selectionBox.getAttribute("height")||"0"),n=y.getAllElements().filter(r=>{if(r instanceof E){const a=(r.x+r.x2)/2,d=(r.y+r.y2)/2;return a>=e&&a<=e+s&&d>=i&&d<=i+o}return r.x>=e&&r.x<=e+s&&r.y>=i&&r.y<=i+o});t.shiftKey?n.forEach(r=>{this.selectedElements.includes(r)||this.selectedElements.push(r)}):this.selectedElements=n,this.updateHighlights(),m.emit("selection:changed",this.selectedElements)}if(this.isDragging){this.isDragging=!1;let e=!1;this.selectedElements.forEach(i=>{const s=this.elementStartPositions.get(i.id);s&&(i.x!==s.x||i.y!==s.y)&&(e=!0)}),e&&this.selectedElements.forEach(i=>{const s=this.elementStartPositions.get(i.id);if(s&&(i.x!==s.x||i.y!==s.y)){const o=new at(i,s.x,s.y,i.x,i.y);C.execute(o)}})}this.isPanning=!1,this.svg.style.cursor="default"}}class q{constructor(t){l(this,"element");this.element=t}execute(){y.addElement(this.element)}undo(){y.removeElement(this.element.id)}}class ht{constructor(){l(this,"connectionRules",[]);l(this,"projectRules",[])}addRule(t){this.connectionRules.push(t)}addProjectRule(t){this.projectRules.push(t)}validate(t,e,i){for(const s of this.connectionRules){const o=s.validate(t,e,i);if(!o.isValid)return o}return{isValid:!0}}validateProject(t){let e=[];for(const i of this.projectRules)e=e.concat(i.validate(t));return e}}const I=new ht,Y="http://www.w3.org/2000/svg";function Q(c){const t=document.createElementNS(Y,"g"),e=20,i=[];i.push({x:0,y:0});let s={x:0,y:0};if(c.sourceDirection){const x=c.sourceDirection===p.Left?-e:c.sourceDirection===p.Right?e:0,P=c.sourceDirection===p.Top?-e:c.sourceDirection===p.Bottom?e:0;s={x:s.x+x,y:s.y+P},i.push(s)}const o={x:c.x2-c.x,y:c.y2-c.y};let n={...o};if(c.targetDirection){const x=c.targetDirection===p.Left?-e:c.targetDirection===p.Right?e:0,P=c.targetDirection===p.Top?-e:c.targetDirection===p.Bottom?e:0;n={x:n.x+x,y:n.y+P}}const r=x=>x===p.Left||x===p.Right,a=c.sourceDirection?r(c.sourceDirection):!1;let d=!0;c.sourceDirection?d=!a:c.targetDirection&&(r(c.targetDirection)?d=!0:d=!1);const h=40,g=40,f=20;if(d){let x=n.y;(s.y>0&&n.y<0||s.y<0&&n.y>0)&&(x=s.y+(s.y>0?f:-f));const z=c.targetDirection===p.Top||c.targetDirection===p.Bottom;let $=!1;if(z&&(c.targetDirection===p.Top&&x>n.y&&($=!0),c.targetDirection===p.Bottom&&x<n.y&&($=!0)),$){i.push({x:s.x,y:x});const H=Math.abs(s.x-n.x)<h;let M=s.x;H?M=Math.max(s.x,n.x)+g:M=(s.x+n.x)/2,i.push({x:M,y:x});const L=n.y+(c.targetDirection===p.Top?-f:f);i.push({x:M,y:L}),i.push({x:n.x,y:L}),i.push({x:n.x,y:n.y})}else i.push({x:s.x,y:x}),i.push({x:n.x,y:x}),i.push({x:n.x,y:n.y})}else{let x=n.x;(s.x>0&&n.x<0||s.x<0&&n.x>0)&&(x=s.x+(s.x>0?f:-f));const z=c.targetDirection===p.Left||c.targetDirection===p.Right;let $=!1;if(z&&(c.targetDirection===p.Left&&x>n.x&&($=!0),c.targetDirection===p.Right&&x<n.x&&($=!0)),$){i.push({x,y:s.y});const H=Math.abs(s.y-n.y)<h;let M=s.y;H?M=Math.max(s.y,n.y)+g:M=(s.y+n.y)/2,i.push({x,y:M});const L=n.x+(c.targetDirection===p.Left?-f:f);i.push({x:L,y:M}),i.push({x:L,y:n.y}),i.push({x:n.x,y:n.y})}else i.push({x,y:s.y}),i.push({x,y:n.y}),i.push({x:n.x,y:n.y})}i.push(o);const v=i.map((x,P)=>`${P===0?"M":"L"} ${x.x} ${x.y}`).join(" "),b=document.createElementNS(Y,"path");b.setAttribute("d",v);let S="#333";y.isSimulationMode&&(S=c.isEnergized?"#4caf50":"#f44336"),b.setAttribute("stroke",S),b.setAttribute("stroke-width","1.5"),b.setAttribute("fill","none"),b.setAttribute("stroke-linejoin","round");const w=document.createElementNS(Y,"path");return w.setAttribute("d",v),w.setAttribute("stroke","white"),w.setAttribute("stroke-opacity","0"),w.setAttribute("stroke-width","10"),w.setAttribute("fill","none"),w.setAttribute("cursor","pointer"),t.appendChild(b),t.appendChild(w),t}class ut{constructor(){l(this,"container");this.container=document.createElement("div"),this.container.className="notification-container",document.body.appendChild(this.container)}show(t,e="info",i=3e3){const s=document.createElement("div");s.className=`notification-toast ${e}`;const o=this.getIcon(e),n=document.createElement("span");n.textContent=t,s.innerHTML=`${o}`,s.appendChild(n);const r=document.createElement("button");r.className="notification-close",r.innerHTML="&times;",r.onclick=()=>{this.dismiss(s)},s.appendChild(r),this.container.appendChild(s),requestAnimationFrame(()=>{s.classList.add("show")}),i>0&&setTimeout(()=>{this.dismiss(s)},i)}dismiss(t){t.classList.remove("show"),t.addEventListener("transitionend",()=>{t.parentElement&&t.parentElement.removeChild(t)})}getIcon(t){switch(t){case"success":return'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';case"error":return'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';case"warning":return'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';case"info":default:return'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'}}}const G=new ut,gt="http://www.w3.org/2000/svg";class ft{constructor(t){l(this,"name","wire");l(this,"svg");l(this,"sceneGroup");l(this,"getView");l(this,"isDrawing",!1);l(this,"activeWire",null);l(this,"activeView",null);l(this,"startPort",null);l(this,"highlightCircle");this.svg=t.getSvg(),this.sceneGroup=t.getSceneGroup(),this.getView=()=>t.getView(),this.highlightCircle=document.createElementNS(gt,"circle"),this.highlightCircle.setAttribute("r","5"),this.highlightCircle.setAttribute("fill","rgba(0, 255, 0, 0.5)"),this.highlightCircle.setAttribute("stroke","green"),this.highlightCircle.setAttribute("stroke-width","1"),this.highlightCircle.style.display="none",this.highlightCircle.style.pointerEvents="none"}activate(){this.svg.style.cursor="crosshair",this.svg.appendChild(this.highlightCircle)}deactivate(){this.isDrawing&&this.activeView&&(this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null,this.activeWire=null,this.isDrawing=!1),this.highlightCircle.parentElement&&this.highlightCircle.parentElement.removeChild(this.highlightCircle)}getWorldPosition(t){const e=this.getView(),i=this.svg.getBoundingClientRect(),s=t.clientX-i.left,o=t.clientY-i.top;return{x:(s-e.x)/e.scale,y:(o-e.y)/e.scale}}findNearestPort(t,e){let s=null,o=15;for(const n of y.getAllElements())if(!(n instanceof E))for(const r of n.getPorts()){const a=r.x-t,d=r.y-e,h=Math.sqrt(a*a+d*d);h<o&&(o=h,s=r)}return s}updateHighlight(t){t?(this.highlightCircle.style.display="block",this.highlightCircle.parentElement!==this.sceneGroup&&this.sceneGroup.appendChild(this.highlightCircle),this.highlightCircle.setAttribute("cx",`${t.x}`),this.highlightCircle.setAttribute("cy",`${t.y}`)):this.highlightCircle.style.display="none"}updateActiveView(){this.activeWire&&(this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=Q(this.activeWire),this.activeView.setAttribute("transform",`translate(${this.activeWire.x}, ${this.activeWire.y}) rotate(${this.activeWire.rotation})`),this.activeView.style.pointerEvents="none",this.sceneGroup.appendChild(this.activeView))}onMouseDown(t){if(t.button!==0)return;const e=this.getWorldPosition(t),i=this.findNearestPort(e.x,e.y);i&&(this.isDrawing=!0,this.startPort=i,document.body.classList.add("no-select"),this.activeWire=new E({x:i.x,y:i.y,x2:i.x,y2:i.y,sourcePortId:i.id,sourceDirection:i.direction}),this.updateActiveView())}getBusPortDirection(t,e){const i=y.getElement(t.elementId);if(i&&i instanceof A)return i.getPreferredPortDirection(t.id,e)}onMouseMove(t){const e=this.getWorldPosition(t),i=this.findNearestPort(e.x,e.y);if(this.updateHighlight(i),this.isDrawing&&this.activeWire){let s=e.x,o=e.y,n;if(this.startPort&&!this.startPort.direction){const r=this.getBusPortDirection(this.startPort,{x:s,y:o});r&&(this.activeWire.sourceDirection=r)}i&&(s=i.x,o=i.y,n=i.direction,n||(n=this.getBusPortDirection(i,{x:this.activeWire.x,y:this.activeWire.y}))),this.activeWire.setEnd(s,o,n),this.updateActiveView()}}onMouseUp(t){if(!this.isDrawing)return;const e=this.getWorldPosition(t),i=this.findNearestPort(e.x,e.y);if(i&&this.activeWire&&this.startPort&&i.id!==this.startPort.id){const s=I.validate(this.startPort,i,y);if(!s.isValid){const r=s.message||"Invalid connection";console.warn(r),G.show(r,"error"),this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null,this.activeWire=null,this.isDrawing=!1,this.startPort=null,document.body.classList.remove("no-select");return}this.activeWire.targetPortId=i.id;let o=i.direction;o||(o=this.getBusPortDirection(i,{x:this.activeWire.x,y:this.activeWire.y})),this.activeWire.setEnd(i.x,i.y,o),this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null;const n=new q(this.activeWire);C.execute(n),console.log(`Connected ${this.startPort.id} to ${i.id}`)}else this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null;this.activeWire=null,this.isDrawing=!1,this.startPort=null,document.body.classList.remove("no-select")}}class mt{constructor(t){l(this,"name","simulation");l(this,"isPanning",!1);l(this,"panStartX",0);l(this,"panStartY",0);l(this,"svg");l(this,"view");l(this,"updateFn");this.svg=t.getSvg(),this.view=t.getView(),this.updateFn=()=>t.updateView()}activate(){this.svg.style.cursor="pointer",y.startSimulation()}deactivate(){this.isPanning=!1,this.svg.style.cursor="default",y.stopSimulation()}findElementFromTarget(t){if(!(t instanceof Element))return null;let e=t;for(;e&&e!==this.svg;){if(e.tagName==="g"&&e.hasAttribute("id")){const i=e.getAttribute("id");if(i)return y.getElement(i)||null}e=e.parentElement}return null}onMouseDown(t){if(t.button===1){this.startPan(t);return}if(t.button===0){const e=this.findElementFromTarget(t.target);if(e){let i=!1;e instanceof W?(e.isOpen=!e.isOpen,i=!0):e instanceof O&&(e.isOn=!e.isOn,i=!0),i&&(m.emit("element:modified",e),y.runSimulation())}}}startPan(t){this.isPanning=!0,this.panStartX=t.clientX,this.panStartY=t.clientY,this.svg.style.cursor="grabbing"}onMouseMove(t){if(this.isPanning){const e=t.clientX-this.panStartX,i=t.clientY-this.panStartY;this.view.x+=e,this.view.y+=i,this.panStartX=t.clientX,this.panStartY=t.clientY,this.updateFn();return}}onMouseUp(){this.isPanning=!1,this.svg.style.cursor="pointer"}}class J{constructor(t,e){l(this,"element");l(this,"oldRotation");l(this,"newRotation");this.element=t,this.oldRotation=t.rotation,this.newRotation=e}execute(){this.element.rotation=this.newRotation,m.emit("element:modified",this.element),this.updateConnectedWires()}undo(){this.element.rotation=this.oldRotation,m.emit("element:modified",this.element),this.updateConnectedWires()}updateConnectedWires(){const t=y.getAllElements().filter(n=>n instanceof E),e=n=>n&&n.startsWith(`${this.element.id}:`),i=this.element.getPorts(),s=new Map(i.map(n=>[n.id,n])),o=this.element instanceof A;t.forEach(n=>{let r=!1;if(e(n.sourcePortId)){const a=s.get(n.sourcePortId);if(a){n.x=a.x,n.y=a.y;let d=a.direction;if(!d&&o&&(d=this.element.getPreferredPortDirection(a.id,{x:n.x2,y:n.y2})),n.sourceDirection=d||null,r=!0,n.targetPortId){const h=n.targetPortId.split(":")[0],g=y.getElement(h);if(g&&g instanceof A){const f=g.getPreferredPortDirection(n.targetPortId,{x:n.x,y:n.y});f&&(n.targetDirection=f,r=!0)}}}}if(e(n.targetPortId)){const a=s.get(n.targetPortId);if(a){let d=a.direction;if(!d&&o&&(d=this.element.getPreferredPortDirection(a.id,{x:n.x,y:n.y})),n.setEnd(a.x,a.y,d),r=!0,n.sourcePortId){const h=n.sourcePortId.split(":")[0],g=y.getElement(h);if(g&&g instanceof A){const f=g.getPreferredPortDirection(n.sourcePortId,{x:n.x2,y:n.y2});f&&(n.sourceDirection=f,r=!0)}}}}r&&m.emit("element:modified",n)})}}class pt{constructor(t,e,i,s,o){l(this,"element");l(this,"oldName");l(this,"newName");l(this,"oldDesc");l(this,"newDesc");this.element=t,this.oldName=e,this.newName=i,this.oldDesc=s,this.newDesc=o}execute(){this.element.name=this.newName,this.element.description=this.newDesc,m.emit("element:modified",this.element)}undo(){this.element.name=this.oldName,this.element.description=this.oldDesc,m.emit("element:modified",this.element)}}class yt{constructor(t){l(this,"container");l(this,"items",[]);l(this,"elementMap",new Map);const e=document.getElementById(t);if(!e)throw new Error(`Toolbar container ${t} not found`);this.container=e,this.container.innerHTML=""}addItem(t){this.items.push(t)}addSeparator(){this.items.push({id:`sep-${Math.random()}`,label:"",type:"action",onClick:()=>{},group:"__separator__"})}render(){this.container.innerHTML="",this.elementMap.clear();let t=null;this.items.forEach((e,i)=>{if(e.group==="__separator__"){const n=document.createElement("div");n.className="separator",this.container.appendChild(n),t=null;return}t||(t=document.createElement("div"),t.className="toolbar-group",this.container.appendChild(t));const s=document.createElement("button");s.id=e.id,s.className="tool-btn",e.title?s.title=e.title:e.label&&(s.title=e.label),e.icon?(e.icon.includes("<svg")?s.innerHTML=e.icon:s.textContent=e.icon,s.classList.add("icon-btn")):(s.textContent=e.label,s.classList.add("text-btn")),e.draggable&&(s.draggable=!0,s.addEventListener("dragstart",n=>{n.dataTransfer&&(n.dataTransfer.setData("application/esld-tool",e.id),n.dataTransfer.effectAllowed="copy")})),s.addEventListener("click",()=>{e.onClick(),this.updateActiveState()}),this.elementMap.set(e.id,s),t.appendChild(s);const o=this.items[i+1];o&&o.group==="__separator__"&&(t=null)}),this.updateActiveState()}setActive(t){this.elementMap.forEach(i=>i.classList.remove("active"));const e=this.elementMap.get(t);e&&e.classList.add("active")}updateItem(t,e){const i=this.items.findIndex(n=>n.id===t);if(i===-1)return;const s=this.items[i];Object.assign(s,e);const o=this.elementMap.get(t);o&&(e.title&&(o.title=e.title),e.label&&!s.icon&&(o.textContent=e.label),e.icon&&(e.icon.includes("<svg")?o.innerHTML=e.icon:o.textContent=e.icon))}updateActiveState(){this.items.forEach(t=>{t.isActive&&t.isActive()&&this.setActive(t.id)})}}class xt{constructor(t){l(this,"container");l(this,"items",[]);const e=document.getElementById(t);if(!e)throw new Error(`Library container ${t} not found`);this.container=e}addItem(t){this.items.push(t)}render(){this.container.innerHTML="";const t=new Map,e="General";this.items.forEach(i=>{const s=i.category||e;t.has(s)||t.set(s,[]),t.get(s).push(i)}),t.forEach((i,s)=>{const o=document.createElement("div");o.className="library-category",o.textContent=s,this.container.appendChild(o);const n=document.createElement("div");n.className="library-grid",i.forEach(r=>{const a=document.createElement("div");a.className="library-item",a.draggable=!0,a.innerHTML=`
                    ${r.icon}
                    <span>${r.label}</span>
                `,a.addEventListener("dragstart",d=>{d.dataTransfer&&(d.dataTransfer.setData("application/esld-tool",r.id),d.dataTransfer.effectAllowed="copy")}),n.appendChild(a)}),this.container.appendChild(n)})}}class vt{constructor(){l(this,"name","Single Connection Check")}validate(t,e,i){const s=i.getAllElements().filter(o=>o instanceof E);for(const o of s){if(o.sourcePortId===t.id)return{isValid:!1,message:"Source port is already connected."};if(o.targetPortId===t.id)return{isValid:!1,message:"Source port is already connected."};if(o.sourcePortId===e.id)return{isValid:!1,message:"Target port is already connected."};if(o.targetPortId===e.id)return{isValid:!1,message:"Target port is already connected."}}return{isValid:!0}}}class bt{constructor(){l(this,"name","Component Compatibility");l(this,"allowedConnections",{[u.Bus]:[u.Breaker,u.Generator,u.Load,u.Transformer,u.Junction],[u.Breaker]:[u.Bus,u.Junction,u.Transformer,u.Generator,u.Load],[u.Generator]:[u.Bus,u.Transformer,u.Breaker],[u.Load]:[u.Bus,u.Breaker,u.Transformer],[u.Transformer]:[u.Bus,u.Breaker,u.Generator,u.Load,u.Junction],[u.Junction]:[u.Bus,u.Breaker,u.Transformer,u.Generator,u.Load,u.Junction]})}validate(t,e,i){const s=i.getElement(t.elementId),o=i.getElement(e.elementId);if(!s||!o)return{isValid:!1,message:"Element not found."};const n=s.type,r=o.type,a=this.allowedConnections[r];if(a&&a.includes(n))return{isValid:!0};const d=this.allowedConnections[n];return d&&d.includes(r)?{isValid:!0}:{isValid:!1,message:`Cannot connect ${n} to ${r}.`}}}class wt{constructor(){l(this,"name","Self-Connection Check")}validate(t,e,i){return t.elementId===e.elementId?{isValid:!1,message:"Cannot connect a component to itself."}:{isValid:!0}}}class Et{constructor(){l(this,"name","Topology Restrictions")}validate(t,e,i){const s=i.getElement(t.elementId),o=i.getElement(e.elementId);if(!s||!o)return{isValid:!1};const n=s.type,r=o.type;return n===u.Generator&&r===u.Generator?{isValid:!1,message:"Direct Generator-to-Generator connections are not allowed. Use a Bus or Synchronizer."}:n===u.Load&&r===u.Load?{isValid:!1,message:"Direct Load-to-Load connections are not allowed. Connect them to a common Bus."}:{isValid:!0}}}class At{constructor(){l(this,"name","Isolated Element Check")}validate(t){const e=[],i=t.getAllElements(),s=i.filter(n=>n instanceof E),o=new Set;s.forEach(n=>{n.sourcePortId&&o.add(n.sourcePortId),n.targetPortId&&o.add(n.targetPortId)});for(const n of i){if(n instanceof E)continue;const r=n.getPorts();if(r.length===0)continue;let a=!1;for(const d of r)if(o.has(d.id)){a=!0;break}a||e.push({elementId:n.id,severity:"warning",message:`Element '${n.type}' is isolated (no connections).`})}return e}}class Pt{constructor(){l(this,"name","Dangling Wire Check")}validate(t){const e=[],i=t.getAllElements().filter(s=>s instanceof E);for(const s of i)(!s.sourcePortId||!s.targetPortId)&&e.push({elementId:s.id,severity:"warning",message:"Wire is not fully connected."});return e}}class St{constructor(){l(this,"container");l(this,"listElement");var t;this.container=document.createElement("div"),this.container.id="validation-panel",this.container.style.display="none",this.container.innerHTML=`
            <div class="validation-header">
                <h3>Design Issues</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="validation-list"></div>
        `,document.body.appendChild(this.container),this.listElement=this.container.querySelector(".validation-list"),(t=this.container.querySelector(".close-btn"))==null||t.addEventListener("click",()=>{this.hide()})}show(t){if(this.listElement.innerHTML="",this.container.style.display="block",t.length===0){this.listElement.innerHTML='<div class="no-issues">No issues found. Great job!</div>';return}t.forEach(e=>{const i=document.createElement("div");i.className=`validation-item ${e.severity}`,i.innerHTML=`
                <div class="icon"></div>
                <div class="content">
                    <span class="message">${e.message}</span>
                </div>
            `,i.addEventListener("click",()=>{e.elementId&&y.getElement(e.elementId)&&(console.log(`Selecting element ${e.elementId}`),m.emit("request:selection",[e.elementId]))}),this.listElement.appendChild(i)})}hide(){this.container.style.display="none"}}const Ct=new St,N="http://www.w3.org/2000/svg";function Mt(c){const t=document.createElementNS(N,"g"),e=20,i=40,s=document.createElementNS(N,"rect");s.setAttribute("x",`${-i/2}`),s.setAttribute("y",`${-i/2}`),s.setAttribute("width",`${i}`),s.setAttribute("height",`${i}`),s.setAttribute("fill","white"),s.setAttribute("fill-opacity","0"),s.setAttribute("cursor","pointer"),t.appendChild(s);const o=document.createElementNS(N,"rect");o.setAttribute("x",`${-e/2}`),o.setAttribute("y",`${-e/2}`),o.setAttribute("width",`${e}`),o.setAttribute("height",`${e}`),c.isOpen?o.setAttribute("fill","white"):y.isSimulationMode?o.setAttribute("fill",c.isEnergized?"#4caf50":"#f44336"):o.setAttribute("fill","#333"),o.setAttribute("stroke","black"),o.setAttribute("stroke-width","2");const n=document.createElementNS(N,"text"),r=(c.rotation||0)*(Math.PI/180),h=e/2*(Math.abs(Math.cos(r))+Math.abs(Math.sin(r)))+15,g=h*Math.sin(r),f=h*Math.cos(r);return n.setAttribute("x",`${g}`),n.setAttribute("y",`${f}`),n.setAttribute("transform",`rotate(${-(c.rotation||0)} ${g} ${f})`),n.setAttribute("text-anchor","middle"),n.setAttribute("font-size","12"),n.setAttribute("fill","#666"),n.textContent=c.name,t.appendChild(o),t.appendChild(n),t}const V="http://www.w3.org/2000/svg";function It(c){const t=document.createElementNS(V,"g"),e=document.createElementNS(V,"line");e.setAttribute("x1",`${-c.length/2}`),e.setAttribute("y1","0"),e.setAttribute("x2",`${c.length/2}`),e.setAttribute("y2","0");let i="#333";y.isSimulationMode&&(i=c.isEnergized?"#4caf50":"#f44336"),e.setAttribute("stroke",i),e.setAttribute("stroke-width","4"),e.setAttribute("stroke-linecap","square");const s=document.createElementNS(V,"line");s.setAttribute("x1",`${-c.length/2}`),s.setAttribute("y1","0"),s.setAttribute("x2",`${c.length/2}`),s.setAttribute("y2","0"),s.setAttribute("stroke","white"),s.setAttribute("stroke-opacity","0"),s.setAttribute("stroke-width","10"),s.setAttribute("cursor","pointer");const o=document.createElementNS(V,"text"),n=(c.rotation||0)*(Math.PI/180),h=c.length/2*Math.abs(Math.sin(n))+2*Math.abs(Math.cos(n))+15,g=h*Math.sin(n),f=h*Math.cos(n);return o.setAttribute("x",`${g}`),o.setAttribute("y",`${f}`),o.setAttribute("transform",`rotate(${-(c.rotation||0)} ${g} ${f})`),o.setAttribute("text-anchor","middle"),o.setAttribute("font-size","12"),o.setAttribute("fill","#666"),o.textContent=c.name,t.appendChild(e),t.appendChild(s),t.appendChild(o),t}const T="http://www.w3.org/2000/svg";function $t(c){const t=document.createElementNS(T,"g"),e=20,i=document.createElementNS(T,"rect"),s=e*2+10;i.setAttribute("x",`${-s/2}`),i.setAttribute("y",`${-s/2}`),i.setAttribute("width",`${s}`),i.setAttribute("height",`${s}`),i.setAttribute("fill","white"),i.setAttribute("fill-opacity","0"),i.setAttribute("cursor","pointer"),t.appendChild(i);const o=document.createElementNS(T,"circle");if(o.setAttribute("cx","0"),o.setAttribute("cy","0"),o.setAttribute("r",`${e}`),!c.isOn)o.setAttribute("fill","#eeeeee"),o.setAttribute("stroke","#999999");else{o.setAttribute("fill","white");let f="black";y.isSimulationMode&&(f=c.isEnergized?"#4caf50":"black"),o.setAttribute("stroke",f)}o.setAttribute("stroke-width","2");const n=document.createElementNS(T,"text");n.setAttribute("x","0"),n.setAttribute("y","5"),n.setAttribute("text-anchor","middle"),n.setAttribute("font-size","20"),n.setAttribute("font-weight","bold"),n.setAttribute("fill","black"),n.textContent="G";const r=document.createElementNS(T,"text"),a=e+15,d=(c.rotation||0)*(Math.PI/180),h=a*Math.sin(d),g=a*Math.cos(d);return r.setAttribute("x",`${h}`),r.setAttribute("y",`${g}`),r.setAttribute("transform",`rotate(${-(c.rotation||0)} ${h} ${g})`),r.setAttribute("text-anchor","middle"),r.setAttribute("font-size","12"),r.setAttribute("fill","#666"),r.textContent=c.name,t.appendChild(o),t.appendChild(n),t.appendChild(r),t}const X="http://www.w3.org/2000/svg";function Dt(c){const t=document.createElementNS(X,"g"),e=4,i=document.createElementNS(X,"circle");i.setAttribute("cx","0"),i.setAttribute("cy","0"),i.setAttribute("r",`${e}`);let s="#333";y.isSimulationMode&&(s=c.isEnergized?"#4caf50":"#f44336"),i.setAttribute("fill",s);const o=document.createElementNS(X,"circle");return o.setAttribute("cx","0"),o.setAttribute("cy","0"),o.setAttribute("r","10"),o.setAttribute("fill","white"),o.setAttribute("fill-opacity","0"),o.setAttribute("cursor","pointer"),t.appendChild(i),t.appendChild(o),t}const B="http://www.w3.org/2000/svg";function kt(c){const t=document.createElementNS(B,"g"),e=30,i=e/2,s=document.createElementNS(B,"rect"),o=e+10;s.setAttribute("x",`${-o/2}`),s.setAttribute("y",`${-o/2}`),s.setAttribute("width",`${o}`),s.setAttribute("height",`${o}`),s.setAttribute("fill","white"),s.setAttribute("fill-opacity","0"),s.setAttribute("cursor","pointer"),t.appendChild(s);let n="#333",r="#333";y.isSimulationMode&&(n=c.isEnergized?"#4caf50":"#f44336",r=c.isEnergized?"#4caf50":"#f44336");const a=document.createElementNS(B,"line");a.setAttribute("x1","0"),a.setAttribute("y1",`${-i}`),a.setAttribute("x2","0"),a.setAttribute("y2",`${i}`),a.setAttribute("stroke",n),a.setAttribute("stroke-width","2");const d=document.createElementNS(B,"polygon"),h=10,g=10,f=`${-h/2},${i-g} ${h/2},${i-g} 0,${i}`;d.setAttribute("points",f),d.setAttribute("fill",r);const v=document.createElementNS(B,"text"),b=(c.rotation||0)*(Math.PI/180),w=15*Math.abs(Math.cos(b))+5*Math.abs(Math.sin(b))+15,x=w*Math.sin(b),P=w*Math.cos(b);return v.setAttribute("x",`${x}`),v.setAttribute("y",`${P}`),v.setAttribute("transform",`rotate(${-(c.rotation||0)} ${x} ${P})`),v.setAttribute("text-anchor","middle"),v.setAttribute("font-size","12"),v.setAttribute("fill","#666"),v.textContent=c.name,t.appendChild(a),t.appendChild(d),t.appendChild(v),t}const D="http://www.w3.org/2000/svg";function Lt(c){const t=document.createElementNS(D,"g"),e=15,i=document.createElementNS(D,"rect"),s=e*2*2+10,o=e*2+10;i.setAttribute("x",`${-o/2}`),i.setAttribute("y",`${-s/2}`),i.setAttribute("width",`${o}`),i.setAttribute("height",`${s}`),i.setAttribute("fill","white"),i.setAttribute("fill-opacity","0"),i.setAttribute("cursor","pointer"),t.appendChild(i);let n="#333";y.isSimulationMode&&(n=c.isEnergized?"#4caf50":"#f44336");const r=document.createElementNS(D,"line");r.setAttribute("x1","0"),r.setAttribute("y1",`${-e*2}`),r.setAttribute("x2","0"),r.setAttribute("y2",`${-e/1.5-e}`),r.setAttribute("stroke",n),r.setAttribute("stroke-width","2");const a=document.createElementNS(D,"line");a.setAttribute("x1","0"),a.setAttribute("y1",`${e*2}`),a.setAttribute("x2","0"),a.setAttribute("y2",`${e/1.5+e}`),a.setAttribute("stroke",n),a.setAttribute("stroke-width","2");const d=document.createElementNS(D,"circle");d.setAttribute("cx","0"),d.setAttribute("cy",`${-e/1.5}`),d.setAttribute("r",`${e}`),d.setAttribute("fill","none"),d.setAttribute("stroke",n),d.setAttribute("stroke-width","2");const h=document.createElementNS(D,"circle");h.setAttribute("cx","0"),h.setAttribute("cy",`${e/1.5}`),h.setAttribute("r",`${e}`),h.setAttribute("fill","none"),h.setAttribute("stroke",n),h.setAttribute("stroke-width","2");const g=document.createElementNS(D,"text"),f=(c.rotation||0)*(Math.PI/180),b=e*2*Math.abs(Math.cos(f))+e*Math.abs(Math.sin(f))+15,S=b*Math.sin(f),w=b*Math.cos(f);return g.setAttribute("x",`${S}`),g.setAttribute("y",`${w}`),g.setAttribute("transform",`rotate(${-(c.rotation||0)} ${S} ${w})`),g.setAttribute("text-anchor","middle"),g.setAttribute("font-size","12"),g.setAttribute("fill","#666"),g.textContent=c.name,t.appendChild(r),t.appendChild(a),t.appendChild(d),t.appendChild(h),t.appendChild(g),t}function U(c){return c instanceof W?Mt:c instanceof A?It:c instanceof O?$t:c instanceof K?Dt:c instanceof F?kt:c instanceof _?Lt:c instanceof E?Q:null}class Tt{constructor(t){l(this,"sceneGroup");l(this,"elementViews",new Map);this.sceneGroup=t,this.bindEvents()}bindEvents(){m.on("element:added",t=>{this.renderElement(t)}),m.on("element:removed",t=>{this.removeElement(t)}),m.on("element:modified",t=>{this.updateElement(t)}),m.on("project:cleared",()=>{this.clearScene()})}renderElement(t){const e=U(t);if(!e)return;const i=e(t);i.setAttribute("id",t.id),this.applyTransform(i,t),this.sceneGroup.appendChild(i),this.elementViews.set(t.id,i)}updateElement(t){let e=this.elementViews.get(t.id);if(!e){this.renderElement(t);return}const i=U(t);if(!i)return;const s=i(t);s.setAttribute("id",t.id),this.applyTransform(s,t),this.sceneGroup.replaceChild(s,e),this.elementViews.set(t.id,s)}applyTransform(t,e){t.setAttribute("transform",`translate(${e.x}, ${e.y}) rotate(${e.rotation})`)}removeElement(t){const e=this.elementViews.get(t.id);e&&e.parentElement&&e.parentElement.removeChild(e),this.elementViews.delete(t.id)}clearScene(){for(;this.sceneGroup.firstChild;)this.sceneGroup.removeChild(this.sceneGroup.firstChild);this.elementViews.clear()}getView(t){return this.elementViews.get(t)}updateViewTransform(t,e){const i=this.elementViews.get(t);i&&i.setAttribute("transform",e)}}class Bt{static exportToPng(t,e=800,i=600){const s=t.getBBox(),o=50,n=s.width+o*2||e,r=s.height+o*2||i,a=s.x-o||0,d=s.y-o||0,h=t.cloneNode(!0);h.removeAttribute("transform");const g=`
    <svg xmlns="http://www.w3.org/2000/svg" width="${n}" height="${r}" viewBox="${a} ${d} ${n} ${r}">
        <style>
            text { font-family: sans-serif; }
        </style>
        <rect x="${a}" y="${d}" width="${n}" height="${r}" fill="white"/>
        ${h.outerHTML}
    </svg>`,f=new Blob([g],{type:"image/svg+xml;charset=utf-8"}),v=URL.createObjectURL(f),b=new Image;b.onload=()=>{const S=document.createElement("canvas");S.width=n,S.height=r;const w=S.getContext("2d");if(w){w.drawImage(b,0,0);const x=S.toDataURL("image/png"),P=document.createElement("a");P.href=x,P.download="diagram.png",document.body.appendChild(P),P.click(),document.body.removeChild(P)}URL.revokeObjectURL(v)},b.src=v}}class Nt{constructor(t){l(this,"svg");l(this,"sceneGroup");l(this,"interactionGroup");l(this,"gridPattern");l(this,"toolManager");l(this,"projectRenderer");l(this,"toolbar");l(this,"library");l(this,"view",{x:0,y:0,scale:1});l(this,"selectedElement",null);const e=document.getElementById(t);if(!e)throw new Error(`SVG element with id '${t}' not found`);this.svg=e,this.toolManager=new it,this.initializeSVG(),this.setupValidationRules(),this.setupUI(),this.bindEvents(),this.toolManager.activateTool("select")}getSvg(){return this.svg}getInteractionGroup(){return this.interactionGroup}getView(){return this.view}getProjectRenderer(){return this.projectRenderer}getSceneGroup(){return this.sceneGroup}updateView(){this.updateTransform()}initializeSVG(){const t="http://www.w3.org/2000/svg",e=document.createElementNS(t,"defs");this.gridPattern=document.createElementNS(t,"pattern"),this.gridPattern.setAttribute("id","grid-pattern"),this.gridPattern.setAttribute("width","20"),this.gridPattern.setAttribute("height","20"),this.gridPattern.setAttribute("patternUnits","userSpaceOnUse");const i=document.createElementNS(t,"path");i.setAttribute("d","M 20 0 L 0 0 0 20"),i.setAttribute("fill","none"),i.setAttribute("stroke","#e0e0e0"),i.setAttribute("stroke-width","1"),this.gridPattern.appendChild(i),e.appendChild(this.gridPattern),this.svg.appendChild(e);const s=document.createElementNS(t,"rect");s.setAttribute("width","100%"),s.setAttribute("height","100%"),s.setAttribute("fill","url(#grid-pattern)"),s.style.cursor="grab",this.svg.appendChild(s),this.sceneGroup=document.createElementNS(t,"g"),this.sceneGroup.setAttribute("id","scene-layer"),this.svg.appendChild(this.sceneGroup),this.interactionGroup=document.createElementNS(t,"g"),this.interactionGroup.setAttribute("id","interaction-layer"),this.interactionGroup.style.pointerEvents="none",this.svg.appendChild(this.interactionGroup),this.projectRenderer=new Tt(this.sceneGroup),this.toolManager.registerTool(new dt(this)),this.toolManager.registerTool(new ft(this)),this.toolManager.registerTool(new mt(this))}setupValidationRules(){I.addRule(new vt),I.addRule(new bt),I.addRule(new wt),I.addRule(new Et),I.addProjectRule(new At),I.addProjectRule(new Pt)}setupUI(){this.toolbar=new yt("toolbar"),this.toolbar.addItem({id:"btn-select",label:"Select",title:"Select Tool",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z'/></svg>",onClick:()=>this.toolManager.activateTool("select")}),this.toolbar.addItem({id:"btn-wire",label:"Wire",title:"Wire Tool",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M4 4h16v2H4zm0 7h16v2H4zm0 7h16v2H4z'/></svg>",onClick:()=>this.toolManager.activateTool("wire")}),this.toolbar.addItem({id:"btn-sim",label:"Simulate",title:"Simulation Mode",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M8 5v14l11-7z'/></svg>",onClick:()=>{this.toolManager.activateTool("simulation")}}),this.toolbar.addItem({id:"btn-validate",label:"Validate",title:"Validate Design",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/></svg>",onClick:()=>{const t=I.validateProject(y);Ct.show(t)}}),this.toolbar.addSeparator(),this.toolbar.addItem({id:"btn-save",label:"Save",title:"Save Project",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z'/></svg>",onClick:()=>{const t=y.save();localStorage.setItem("esld_project",t),G.show("Project Saved to LocalStorage!","success")}}),this.toolbar.addItem({id:"btn-load",label:"Load",title:"Load Project",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z'/></svg>",onClick:()=>{const t=localStorage.getItem("esld_project");t?(y.load(t),G.show("Project Loaded Successfully!","success")):G.show("No saved project found!","warning")}}),this.toolbar.addItem({id:"btn-export",label:"Export",title:"Export as PNG",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z'/></svg>",onClick:()=>Bt.exportToPng(this.sceneGroup)}),this.toolbar.addSeparator(),this.toolbar.addItem({id:"btn-undo",label:"Undo",title:"Undo Last Action",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z'/></svg>",onClick:()=>C.undo()}),this.toolbar.addItem({id:"btn-redo",label:"Redo",title:"Redo Last Action",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z'/></svg>",onClick:()=>C.redo()}),this.toolbar.render(),this.library=new xt("library-content"),this.library.addItem({id:u.Bus,label:"Busbar",category:"Conducting",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='4' y='10' width='16' height='4' rx='1' fill='currentColor'/></svg>"}),this.library.addItem({id:u.Junction,label:"Junction",category:"Conducting",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><circle cx='12' cy='12' r='4' fill='currentColor'/></svg>"}),this.library.addItem({id:u.Generator,label:"Generator",category:"Sources",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><circle cx='12' cy='12' r='9'/><text x='12' y='16' text-anchor='middle' font-size='12' font-weight='bold' style='fill:currentColor;stroke:none'>G</text></svg>"}),this.library.addItem({id:u.Load,label:"Load",category:"Loads",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M12 3v16m-5-5l5 5 5-5'/></svg>"}),this.library.addItem({id:u.Breaker,label:"Breaker",category:"Protection",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><rect x='5' y='5' width='14' height='14'/></svg>"}),this.library.addItem({id:u.Transformer,label:"Transformer",category:"Equipment",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><circle cx='12' cy='9' r='5'/><circle cx='12' cy='15' r='5'/><line x1='12' y1='4' x2='12' y2='9'/><line x1='12' y1='15' x2='12' y2='20'/></svg>"}),this.library.render(),this.setupPropertyPanel()}setupPropertyPanel(){var n,r;const t=document.getElementById("prop-form"),e=document.querySelector(".empty-state"),i=document.getElementById("prop-name"),s=document.getElementById("prop-desc"),o=()=>{if(!this.selectedElement||this.selectedElement.name===i.value&&this.selectedElement.description===s.value)return;const a=new pt(this.selectedElement,this.selectedElement.name,i.value,this.selectedElement.description,s.value);C.execute(a)};i==null||i.addEventListener("change",o),s==null||s.addEventListener("change",o),(n=document.getElementById("btn-rotate-cw"))==null||n.addEventListener("click",()=>{if(!this.selectedElement||this.selectedElement instanceof E)return;const a=(this.selectedElement.rotation+90)%360,d=new J(this.selectedElement,a);C.execute(d)}),(r=document.getElementById("btn-rotate-ccw"))==null||r.addEventListener("click",()=>{if(!this.selectedElement||this.selectedElement instanceof E)return;let a=(this.selectedElement.rotation-90)%360;a<0&&(a+=360);const d=new J(this.selectedElement,a);C.execute(d)}),m.on("selection:changed",a=>{a.length>0?(this.selectedElement=a[0],t.style.display="block",e.style.display="none",i.value=this.selectedElement.name,s.value=this.selectedElement.description):(this.selectedElement=null,t.style.display="none",e.style.display="block")}),m.on("history:changed",()=>{this.selectedElement&&(i.value=this.selectedElement.name,s.value=this.selectedElement.description)})}bindEvents(){this.svg.addEventListener("mousedown",e=>this.toolManager.onMouseDown(e)),window.addEventListener("mousemove",e=>this.toolManager.onMouseMove(e)),window.addEventListener("mouseup",e=>this.toolManager.onMouseUp(e)),this.svg.addEventListener("wheel",this.onWheel.bind(this),{passive:!1}),this.svg.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"}),this.svg.addEventListener("drop",e=>{e.preventDefault();const i=e.dataTransfer.getData("application/esld-tool");if(!i)return;const{x:s,y:o}=this.getSnappedWorldPosition(e.clientX,e.clientY),n=j.createDefault(i,s,o);if(n){const r=new q(n);C.execute(r)}}),window.addEventListener("keydown",e=>{var s;const i=(s=document.activeElement)==null?void 0:s.tagName.toLowerCase();i==="input"||i==="textarea"||((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="z"?e.shiftKey?(e.preventDefault(),C.redo()):(e.preventDefault(),C.undo()):(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="y"&&(e.preventDefault(),C.redo()))}),m.on("request:selection",e=>{this.toolManager.activateTool("select");const i=this.toolManager.getTool("select");i&&i.selectElements(e)});const t={select:"btn-select",wire:"btn-wire",simulation:"btn-sim"};m.on("tool:activated",e=>{const i=t[e];i&&this.toolbar.setActive(i),e==="simulation"?this.toolbar.updateItem("btn-sim",{label:"Stop",title:"Stop Simulation",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M6 6h12v12H6z'/></svg>"}):this.toolbar.updateItem("btn-sim",{label:"Simulate",title:"Start Simulation",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M8 5v14l11-7z'/></svg>"})})}updateTransform(){const t=`translate(${this.view.x}, ${this.view.y}) scale(${this.view.scale})`;this.sceneGroup.setAttribute("transform",t),this.interactionGroup.setAttribute("transform",t),this.gridPattern.setAttribute("patternTransform",`translate(${this.view.x%(20*this.view.scale)}, ${this.view.y%(20*this.view.scale)}) scale(${this.view.scale})`)}onWheel(t){t.preventDefault();const e=.1,i=t.deltaY<0?1:-1,s=Math.exp(i*e),o=this.svg.getBoundingClientRect(),n=t.clientX-o.left,r=t.clientY-o.top,a=this.view.scale*s;a<.1||a>10||(this.view.x=n-(n-this.view.x)*s,this.view.y=r-(r-this.view.y)*s,this.view.scale=a,this.updateTransform())}getSnappedWorldPosition(t,e){const i=this.svg.getBoundingClientRect(),s=t-i.left,o=e-i.top,n=(s-this.view.x)/this.view.scale,r=(o-this.view.y)/this.view.scale;return{x:Math.round(n/20)*20,y:Math.round(r/20)*20}}}new Nt("main-svg");
