var rt=Object.defineProperty;var ct=(c,t,e)=>t in c?rt(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var d=(c,t,e)=>ct(c,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class at{constructor(){d(this,"listeners",{})}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}off(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(i=>i!==e))}emit(t,e){this.listeners[t]&&this.listeners[t].forEach(i=>i(e))}}const p=new at;class lt{constructor(){d(this,"activeTool",null);d(this,"tools",new Map)}registerTool(t){this.tools.set(t.name,t)}getActiveToolName(){var t;return(t=this.activeTool)==null?void 0:t.name}activateTool(t){const e=this.tools.get(t);if(!e){console.warn(`Tool ${t} not found`);return}this.activeTool&&this.activeTool.deactivate(),this.activeTool=e,this.activeTool.activate(),p.emit("tool:activated",t),console.log(`Switched to tool: ${t}`)}onMouseDown(t){var e;(e=this.activeTool)==null||e.onMouseDown(t)}onMouseMove(t){var e;(e=this.activeTool)==null||e.onMouseMove(t)}onMouseUp(t){var e;(e=this.activeTool)==null||e.onMouseUp(t)}}class B{constructor(t){d(this,"id");d(this,"x");d(this,"y");d(this,"rotation");d(this,"name");d(this,"description");d(this,"isEnergized",!1);this.id=t.id||crypto.randomUUID(),this.x=t.x,this.y=t.y,this.rotation=t.rotation||0,this.name=t.name||"Element",this.description=t.description||""}getTransformedPoint(t,e){const i=this.rotation*Math.PI/180,s=Math.cos(i),o=Math.sin(i),n=t*s-e*o,r=t*o+e*s;return{x:this.x+n,y:this.y+r}}getPortDirection(t){const e=["top","right","bottom","left"],i=e.indexOf(t);if(i===-1)return t;const s=Math.round(this.rotation/90)%4,o=(i+s)%4;return e[o]}toJSON(){return{id:this.id,x:this.x,y:this.y,rotation:this.rotation,name:this.name,description:this.description,type:this.type}}}class w extends B{constructor(e){super(e);d(this,"type","WireElement");d(this,"x2");d(this,"y2");d(this,"points",[]);d(this,"sourcePortId",null);d(this,"targetPortId",null);d(this,"sourceDirection",null);d(this,"targetDirection",null);this.x2=e.x2,this.y2=e.y2,this.sourcePortId=e.sourcePortId||null,this.targetPortId=e.targetPortId||null,this.sourceDirection=e.sourceDirection||null,this.targetDirection=e.targetDirection||null}setEnd(e,i,s){this.x2=e,this.y2=i,s?this.targetDirection=s:this.targetDirection=null}getPorts(){return[]}toJSON(){return{...super.toJSON(),x2:this.x2,y2:this.y2,sourcePortId:this.sourcePortId,targetPortId:this.targetPortId,sourceDirection:this.sourceDirection,targetDirection:this.targetDirection}}}class J extends B{constructor(e){super(e);d(this,"type","GeneratorElement");d(this,"isOn",!0);this.isOn=e.isOn??!0}getPorts(){const i=this.getTransformedPoint(0,20);return[{id:`${this.id}:bottom`,elementId:this.id,x:i.x,y:i.y,direction:this.getPortDirection("bottom")}]}toJSON(){return{...super.toJSON(),isOn:this.isOn}}}class U extends B{constructor(e){super(e);d(this,"type","BreakerElement");d(this,"isOpen",!1);this.isOpen=e.isOpen??!1}getPorts(){const i=this.getTransformedPoint(0,-10),s=this.getTransformedPoint(0,20/2);return[{id:`${this.id}:top`,elementId:this.id,x:i.x,y:i.y,direction:this.getPortDirection("top")},{id:`${this.id}:bottom`,elementId:this.id,x:s.x,y:s.y,direction:this.getPortDirection("bottom")}]}toJSON(){return{...super.toJSON(),isOpen:this.isOpen}}}class dt{static run(t){const e=new Set,i=new Set,s=[],o=new Map;for(t.forEach(a=>{o.has(a.id)||o.set(a.id,[])}),t.filter(a=>a instanceof w).forEach(a=>{if(a.sourcePortId&&a.targetPortId){const l=a.sourcePortId.split(":")[0],u=a.targetPortId.split(":")[0];o.has(l)&&o.has(u)&&(o.get(l).push(u),o.get(u).push(l),o.get(l).push(a.id),o.get(u).push(a.id),o.has(a.id)||o.set(a.id,[]),o.get(a.id).push(l),o.get(a.id).push(u))}}),t.filter(a=>a instanceof J&&a.isOn).forEach(a=>{s.push(a),i.add(a.id),e.add(a.id)});s.length>0;){const a=s.shift();let l=!0;if(a instanceof U&&a.isOpen&&(l=!1),!l)continue;const u=o.get(a.id)||[];for(const h of u)if(!i.has(h)){const g=t.find(x=>x.id===h);g&&(i.add(h),e.add(h),s.push(g))}}return e}}class E extends B{constructor(e){super(e);d(this,"type","BusElement");d(this,"length");this.length=e.length||100}getPorts(){const e=[],i=this.length/2,s=20,o=(r,a,l)=>{const u=this.getTransformedPoint(a,0);e.push({id:`${this.id}:${r}`,elementId:this.id,x:u.x,y:u.y,direction:l?this.getPortDirection(l):void 0})};o("left",-i,"left"),o("center",0),o("right",i,"right");const n=Math.floor((i-1)/s);for(let r=1;r<=n;r++)o(`${r*s}`,r*s),o(`${-r*s}`,-r*s);return e}getPreferredPortDirection(e,i){const o=this.getPorts().find(a=>a.id===e);if(!o)return;if(o.direction)return o.direction;const n=(this.rotation%360+360)%360;return n>=45&&n<135||n>=225&&n<315?i.x<o.x?"left":"right":i.y<o.y?"top":"bottom"}toJSON(){return{...super.toJSON(),length:this.length}}}class et extends B{constructor(e){super(e);d(this,"type","TransformerElement")}getPorts(){const i=this.getTransformedPoint(0,-30),s=this.getTransformedPoint(0,15*2);return[{id:`${this.id}:top`,elementId:this.id,x:i.x,y:i.y,direction:this.getPortDirection("top")},{id:`${this.id}:bottom`,elementId:this.id,x:s.x,y:s.y,direction:this.getPortDirection("bottom")}]}}class it extends B{constructor(e){super(e);d(this,"type","LoadElement")}getPorts(){const e=this.getTransformedPoint(0,-15);return[{id:`${this.id}:top`,elementId:this.id,x:e.x,y:e.y,direction:this.getPortDirection("top")}]}}class st extends B{constructor(e){super(e);d(this,"type","JunctionElement")}getPorts(){return[{id:`${this.id}:center`,elementId:this.id,x:this.x,y:this.y}]}}class k{static create(t){let e=null;switch(t.type){case"BusElement":e=new E({id:t.id,x:t.x,y:t.y,length:t.length});break;case"BreakerElement":e=new U({id:t.id,x:t.x,y:t.y,isOpen:t.isOpen});break;case"TransformerElement":e=new et({id:t.id,x:t.x,y:t.y});break;case"GeneratorElement":e=new J({id:t.id,x:t.x,y:t.y,isOn:t.isOn});break;case"LoadElement":e=new it({id:t.id,x:t.x,y:t.y});break;case"JunctionElement":e=new st({id:t.id,x:t.x,y:t.y});break;case"WireElement":e=new w({id:t.id,x:t.x,y:t.y,x2:t.x2,y2:t.y2,sourcePortId:t.sourcePortId,targetPortId:t.targetPortId});break}return e&&(e.rotation=t.rotation||0,e.name=t.name||"Element",e.description=t.description||""),e}}class ht{constructor(){d(this,"elements",new Map);d(this,"isSimulationMode",!1)}startSimulation(){this.isSimulationMode=!0,this.runSimulation(),this.notifyAllElements()}stopSimulation(){this.isSimulationMode=!1,this.notifyAllElements()}notifyAllElements(){this.elements.forEach(t=>{p.emit("element:modified",t)})}runSimulation(){const t=dt.run(Array.from(this.elements.values()));this.elements.forEach(e=>{const i=e.isEnergized;e.isEnergized=t.has(e.id),i!==e.isEnergized&&p.emit("element:modified",e)}),p.emit("simulation:updated",void 0)}addElement(t){this.elements.set(t.id,t),p.emit("element:added",t)}removeElement(t){const e=this.elements.get(t);e&&(this.elements.delete(t),p.emit("element:removed",e))}getElement(t){return this.elements.get(t)}getAllElements(){return Array.from(this.elements.values())}save(){const t=Array.from(this.elements.values()).map(e=>e.toJSON());return JSON.stringify(t,null,2)}load(t){this.elements.clear(),p.emit("project:cleared",void 0);try{const e=JSON.parse(t);if(!Array.isArray(e))throw new Error("Invalid format");e.forEach(i=>{const s=k.create(i);s&&this.addElement(s)}),console.log("Project loaded successfully")}catch(e){console.error("Failed to load project",e)}}}const y=new ht;class ut{constructor(){d(this,"undoStack",[]);d(this,"redoStack",[])}execute(t){t.execute(),this.undoStack.push(t),this.redoStack=[],console.log("Command executed. Undo stack:",this.undoStack.length),p.emit("history:changed",void 0)}undo(){const t=this.undoStack.pop();t&&(t.undo(),this.redoStack.push(t),console.log("Undone"),p.emit("history:changed",void 0))}redo(){const t=this.redoStack.pop();t&&(t.execute(),this.undoStack.push(t),console.log("Redone"),p.emit("history:changed",void 0))}}const S=new ut;class gt{constructor(t,e){d(this,"element");d(this,"secondaryElements");this.element=t,this.secondaryElements=e}execute(){this.remove(this.element),this.secondaryElements.forEach(t=>this.remove(t))}undo(){this.restore(this.element),this.secondaryElements.forEach(t=>this.restore(t))}remove(t){y.removeElement(t.id),p.emit("element:removed",t)}restore(t){y.addElement(t),p.emit("element:added",t)}}class ft{constructor(t,e,i,s,o){d(this,"element");d(this,"oldX");d(this,"oldY");d(this,"newX");d(this,"newY");this.element=t,this.oldX=e,this.oldY=i,this.newX=s,this.newY=o}execute(){this.element.x=this.newX,this.element.y=this.newY,p.emit("element:modified",this.element),this.updateConnectedWires()}undo(){this.element.x=this.oldX,this.element.y=this.oldY,p.emit("element:modified",this.element),this.updateConnectedWires()}updateConnectedWires(){const t=y.getAllElements().filter(n=>n instanceof w),e=n=>n&&n.startsWith(`${this.element.id}:`),i=this.element.getPorts(),s=new Map(i.map(n=>[n.id,n])),o=this.element instanceof E;t.forEach(n=>{let r=!1;if(e(n.sourcePortId)){const a=s.get(n.sourcePortId);if(a){n.x=a.x,n.y=a.y;let l=a.direction;if(!l&&o&&(l=this.element.getPreferredPortDirection(a.id,{x:n.x2,y:n.y2})),n.sourceDirection=l||null,r=!0,n.targetPortId){const u=n.targetPortId.split(":")[0],h=y.getElement(u);if(h&&h instanceof E){const g=h.getPreferredPortDirection(n.targetPortId,{x:n.x,y:n.y});g&&(n.targetDirection=g,r=!0)}}}}if(e(n.targetPortId)){const a=s.get(n.targetPortId);if(a){let l=a.direction;if(!l&&o&&(l=this.element.getPreferredPortDirection(a.id,{x:n.x,y:n.y})),n.setEnd(a.x,a.y,l),r=!0,n.sourcePortId){const u=n.sourcePortId.split(":")[0],h=y.getElement(u);if(h&&h instanceof E){const g=h.getPreferredPortDirection(n.sourcePortId,{x:n.x2,y:n.y2});g&&(n.sourceDirection=g,r=!0)}}}}r&&p.emit("element:modified",n)})}}class mt{constructor(t){d(this,"elements");this.elements=t}execute(){this.elements.forEach(t=>{y.addElement(t)})}undo(){this.elements.forEach(t=>{y.removeElement(t.id)})}}class _{static copy(t){if(t.length===0){this.buffer=null;return}const e=t.map(i=>i.toJSON());this.buffer=JSON.stringify(e),console.log(`Copied ${t.length} elements to clipboard`)}static paste(){if(!this.buffer)return[];try{const t=JSON.parse(this.buffer);if(!Array.isArray(t))return[];const e=new Map,i=[];return t.forEach(s=>{const o=s.id,n=k.create(s);if(n){const r=crypto.randomUUID();n.id=r,n.x+=this.pasteOffset,n.y+=this.pasteOffset,e.set(o,r),i.push(n)}}),i.forEach(s=>{if(s instanceof w){if(s.sourcePortId){const[o,n]=this.parsePortId(s.sourcePortId);if(e.has(o)){const r=e.get(o);s.sourcePortId=n?`${r}:${n}`:r}}if(s.targetPortId){const[o,n]=this.parsePortId(s.targetPortId);if(e.has(o)){const r=e.get(o);s.targetPortId=n?`${r}:${n}`:r}}}}),this.pasteOffset+=20,this.pasteOffset>100&&(this.pasteOffset=20),i}catch(t){return console.error("Failed to paste from clipboard",t),[]}}static parsePortId(t){const e=t.split(":");return e.length>1?[e[0],e.slice(1).join(":")]:[t,null]}}d(_,"buffer",null),d(_,"pasteOffset",20);class pt{constructor(t,e,i,s,o,n,r){d(this,"element");d(this,"oldX");d(this,"oldY");d(this,"oldLength");d(this,"newX");d(this,"newY");d(this,"newLength");this.element=t,this.oldX=e,this.oldY=i,this.oldLength=s,this.newX=o,this.newY=n,this.newLength=r}execute(){this.update(this.newX,this.newY,this.newLength)}undo(){this.update(this.oldX,this.oldY,this.oldLength)}update(t,e,i){this.element.x=t,this.element.y=e,this.element.length=i,p.emit("element:modified",this.element),this.updateConnectedWires()}updateConnectedWires(){const t=y.getAllElements().filter(o=>o instanceof w),e=o=>o&&o.startsWith(`${this.element.id}:`),i=this.element.getPorts(),s=new Map(i.map(o=>[o.id,o]));t.forEach(o=>{let n=!1;if(e(o.sourcePortId)){const r=s.get(o.sourcePortId);if(r){o.x=r.x,o.y=r.y;let a=r.direction;if(a||(a=this.element.getPreferredPortDirection(r.id,{x:o.x2,y:o.y2})),o.sourceDirection=a||null,n=!0,o.targetPortId){const l=o.targetPortId.split(":")[0],u=y.getElement(l);if(u&&u instanceof E){const h=u.getPreferredPortDirection(o.targetPortId,{x:o.x,y:o.y});h&&(o.targetDirection=h,n=!0)}}}}if(e(o.targetPortId)){const r=s.get(o.targetPortId);if(r){let a=r.direction;if(a||(a=this.element.getPreferredPortDirection(r.id,{x:o.x,y:o.y})),o.setEnd(r.x,r.y,a),n=!0,o.sourcePortId){const l=o.sourcePortId.split(":")[0],u=y.getElement(l);if(u&&u instanceof E){const h=u.getPreferredPortDirection(o.sourcePortId,{x:o.x2,y:o.y2});h&&(o.sourceDirection=h,n=!0)}}}}n&&p.emit("element:modified",o)})}}class yt{constructor(t,e,i,s,o){d(this,"name","select");d(this,"isPanning",!1);d(this,"panStartX",0);d(this,"panStartY",0);d(this,"selectedElements",[]);d(this,"isDragging",!1);d(this,"dragStartX",0);d(this,"dragStartY",0);d(this,"elementStartPositions",new Map);d(this,"svg");d(this,"interactionGroup");d(this,"highlightGroup");d(this,"view");d(this,"updateFn");d(this,"projectRenderer");d(this,"isSelecting",!1);d(this,"selectionStartX",0);d(this,"selectionStartY",0);d(this,"selectionBox");d(this,"resizeHandles",[]);d(this,"activeHandle",null);d(this,"initialLength",0);d(this,"initialX",0);d(this,"initialY",0);d(this,"onElementModified",t=>{this.selectedElements.some(e=>e.id===t.id)&&this.updateHighlights()});d(this,"onKeyDown",t=>{var i;const e=(i=document.activeElement)==null?void 0:i.tagName.toLowerCase();if(!(e==="input"||e==="textarea")&&((t.key==="Delete"||t.key==="Backspace")&&this.deleteSelection(),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="c"&&(t.preventDefault(),_.copy(this.selectedElements)),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="v")){t.preventDefault();const s=_.paste();if(s.length>0){const o=new mt(s);S.execute(o),this.selectedElements=s,this.updateHighlights(),p.emit("selection:changed",this.selectedElements)}}});this.svg=t,this.interactionGroup=e,this.view=i,this.updateFn=s,this.projectRenderer=o,this.highlightGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.interactionGroup.appendChild(this.highlightGroup),this.selectionBox=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.selectionBox.setAttribute("fill","rgba(0, 120, 215, 0.1)"),this.selectionBox.setAttribute("stroke","rgba(0, 120, 215, 0.5)"),this.selectionBox.setAttribute("stroke-width","1"),this.selectionBox.setAttribute("display","none"),this.interactionGroup.appendChild(this.selectionBox);for(let n=0;n<2;n++){const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("width","10"),r.setAttribute("height","10"),r.setAttribute("fill","white"),r.setAttribute("stroke","#0078d7"),r.setAttribute("stroke-width","1"),r.setAttribute("display","none"),r.style.cursor="ew-resize",r.style.pointerEvents="all",this.interactionGroup.appendChild(r),this.resizeHandles.push(r)}}activate(){this.svg.style.cursor="default",window.addEventListener("keydown",this.onKeyDown),p.on("element:modified",this.onElementModified)}deactivate(){this.isPanning=!1,this.isDragging=!1,this.isSelecting=!1,this.clearSelection(),window.removeEventListener("keydown",this.onKeyDown),p.off("element:modified",this.onElementModified)}deleteSelection(){if(this.selectedElements.length===0)return;[...this.selectedElements].forEach(e=>{const i=[];e instanceof w||y.getAllElements().filter(n=>n instanceof w).forEach(n=>{e.getPorts().some(r=>n.sourcePortId===r.id||n.targetPortId===r.id)&&i.push(n)});const s=new gt(e,i);S.execute(s)}),this.selectedElements=[],this.updateHighlights(),p.emit("selection:changed",[]),console.log("Deleted elements")}clearSelection(){this.selectedElements=[],this.updateHighlights(),p.emit("selection:changed",[])}updateHighlights(){if(this.highlightGroup.innerHTML="",this.resizeHandles.forEach(t=>t.setAttribute("display","none")),this.selectedElements.forEach(t=>{const e=this.projectRenderer.getView(t.id);if(!e)return;const i=e.getBBox(),s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x",`${i.x-5}`),s.setAttribute("y",`${i.y-5}`),s.setAttribute("width",`${i.width+10}`),s.setAttribute("height",`${i.height+10}`),s.setAttribute("fill","rgba(0, 120, 215, 0.1)"),s.setAttribute("stroke","#0078d7"),s.setAttribute("stroke-width","2"),s.setAttribute("stroke-dasharray","4"),s.style.pointerEvents="none",s.setAttribute("transform",`translate(${t.x}, ${t.y}) rotate(${t.rotation})`),this.highlightGroup.appendChild(s)}),this.selectedElements.length===1&&this.selectedElements[0]instanceof E){const e=this.selectedElements[0].getPorts(),i=e.find(o=>o.id.endsWith(":left")),s=e.find(o=>o.id.endsWith(":right"));if(i&&s){const o=10/this.view.scale,n=o/2,r=(a,l,u)=>{a.setAttribute("width",`${o}`),a.setAttribute("height",`${o}`),a.setAttribute("x",`${l-n}`),a.setAttribute("y",`${u-n}`),a.setAttribute("display","block")};r(this.resizeHandles[0],i.x,i.y),r(this.resizeHandles[1],s.x,s.y)}}}findElementFromTarget(t){if(!(t instanceof Element))return null;let e=t;for(;e&&e!==this.svg;){if(e.tagName==="g"&&e.hasAttribute("id")){const i=e.getAttribute("id");if(i)return y.getElement(i)||null}e=e.parentElement}return null}getWorldPosition(t){const e=this.svg.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top;return{x:(i-this.view.x)/this.view.scale,y:(s-this.view.y)/this.view.scale}}onMouseDown(t){if(t.button===1){this.startPan(t);return}if(t.button===0){if(this.resizeHandles.includes(t.target)){const i=this.resizeHandles.indexOf(t.target);if(this.activeHandle=i===0?"left":"right",this.selectedElements.length===1&&this.selectedElements[0]instanceof E){const s=this.selectedElements[0];this.initialLength=s.length,this.initialX=s.x,this.initialY=s.y}return}const e=this.findElementFromTarget(t.target);if(e){t.shiftKey?(this.selectedElements.includes(e)?this.selectedElements=this.selectedElements.filter(s=>s!==e):this.selectedElements.push(e),this.updateHighlights(),p.emit("selection:changed",this.selectedElements)):this.selectedElements.includes(e)||(this.selectedElements=[e],this.updateHighlights(),p.emit("selection:changed",this.selectedElements)),this.isDragging=!0;const i=this.getWorldPosition(t);this.dragStartX=i.x,this.dragStartY=i.y,this.elementStartPositions.clear(),this.selectedElements.forEach(s=>{this.elementStartPositions.set(s.id,{x:s.x,y:s.y})})}else{t.shiftKey||this.clearSelection(),this.isSelecting=!0;const i=this.getWorldPosition(t);this.selectionStartX=i.x,this.selectionStartY=i.y,this.selectionBox.setAttribute("x",`${i.x}`),this.selectionBox.setAttribute("y",`${i.y}`),this.selectionBox.setAttribute("width","0"),this.selectionBox.setAttribute("height","0"),this.selectionBox.setAttribute("display","block")}}}startPan(t){this.isPanning=!0,this.panStartX=t.clientX,this.panStartY=t.clientY,this.svg.style.cursor="grabbing"}onMouseMove(t){if(this.isPanning){const e=t.clientX-this.panStartX,i=t.clientY-this.panStartY;this.view.x+=e,this.view.y+=i,this.panStartX=t.clientX,this.panStartY=t.clientY,this.updateFn();return}if(this.activeHandle){const e=this.getWorldPosition(t);if(this.selectedElements.length===1&&this.selectedElements[0]instanceof E){const i=this.selectedElements[0],s=i.length,o=i.rotation*Math.PI/180,n=Math.cos(o),r=Math.sin(o),a=s/2;let l=s,u=i.x,h=i.y;if(this.activeHandle==="right"){const g=i.x-a*n,x=i.y-a*r,b=e.x-g,C=e.y-x,f=b*n+C*r,m=Math.max(20,Math.round(f/20)*20);m!==s&&(l=m,u=g+l/2*n,h=x+l/2*r)}else{const g=i.x+a*n,x=i.y+a*r,b=g-e.x,C=x-e.y,f=b*n+C*r,m=Math.max(20,Math.round(f/20)*20);m!==s&&(l=m,u=g-l/2*n,h=x-l/2*r)}(l!==i.length||u!==i.x||h!==i.y)&&(i.length=l,i.x=u,i.y=h,p.emit("element:modified",i),this.updateConnectedWires(i),this.updateHighlights())}return}if(this.isSelecting){const e=this.getWorldPosition(t),i=Math.min(this.selectionStartX,e.x),s=Math.min(this.selectionStartY,e.y),o=Math.abs(e.x-this.selectionStartX),n=Math.abs(e.y-this.selectionStartY);this.selectionBox.setAttribute("x",`${i}`),this.selectionBox.setAttribute("y",`${s}`),this.selectionBox.setAttribute("width",`${o}`),this.selectionBox.setAttribute("height",`${n}`);return}if(this.isDragging&&this.selectedElements.length>0){const e=this.getWorldPosition(t),i=e.x-this.dragStartX,s=e.y-this.dragStartY;this.selectedElements.forEach(o=>{if(o instanceof w)return;const n=this.elementStartPositions.get(o.id);if(!n)return;let r=n.x+i,a=n.y+s;r=Math.round(r/20)*20,a=Math.round(a/20)*20,(r!==o.x||a!==o.y)&&(o.x=r,o.y=a,this.projectRenderer.updateViewTransform(o.id,`translate(${o.x}, ${o.y}) rotate(${o.rotation})`),p.emit("element:modified",o),this.updateConnectedWires(o),this.updateHighlights())})}}updateConnectedWires(t){const e=y.getAllElements().filter(r=>r instanceof w),i=r=>r&&r.startsWith(`${t.id}:`),s=t.getPorts(),o=new Map(s.map(r=>[r.id,r])),n=t instanceof E;e.forEach(r=>{let a=!1;if(i(r.sourcePortId)){const l=o.get(r.sourcePortId);if(l){r.x=l.x,r.y=l.y;let u=l.direction;if(!u&&n&&(u=t.getPreferredPortDirection(l.id,{x:r.x2,y:r.y2})),r.sourceDirection=u||null,a=!0,r.targetPortId){const h=r.targetPortId.split(":")[0],g=y.getElement(h);if(g&&g instanceof E){const x=g.getPreferredPortDirection(r.targetPortId,{x:r.x,y:r.y});x&&(r.targetDirection=x,a=!0)}}}}if(i(r.targetPortId)){const l=o.get(r.targetPortId);if(l){let u=l.direction;if(!u&&n&&(u=t.getPreferredPortDirection(l.id,{x:r.x,y:r.y})),r.setEnd(l.x,l.y,u),a=!0,r.sourcePortId){const h=r.sourcePortId.split(":")[0],g=y.getElement(h);if(g&&g instanceof E){const x=g.getPreferredPortDirection(r.sourcePortId,{x:r.x2,y:r.y2});x&&(r.sourceDirection=x,a=!0)}}}}a&&p.emit("element:modified",r)})}onMouseUp(t){if(this.activeHandle){if(this.activeHandle=null,this.svg.style.cursor="default",this.selectedElements.length===1&&this.selectedElements[0]instanceof E){const e=this.selectedElements[0];if(e.length!==this.initialLength||e.x!==this.initialX||e.y!==this.initialY){const i=new pt(e,this.initialX,this.initialY,this.initialLength,e.x,e.y,e.length);S.execute(i),console.log("Resize recorded")}}this.updateHighlights();return}if(this.isSelecting){this.isSelecting=!1,this.selectionBox.setAttribute("display","none");const e=parseFloat(this.selectionBox.getAttribute("x")||"0"),i=parseFloat(this.selectionBox.getAttribute("y")||"0"),s=parseFloat(this.selectionBox.getAttribute("width")||"0"),o=parseFloat(this.selectionBox.getAttribute("height")||"0"),n=y.getAllElements().filter(r=>{if(r instanceof w){const a=(r.x+r.x2)/2,l=(r.y+r.y2)/2;return a>=e&&a<=e+s&&l>=i&&l<=i+o}return r.x>=e&&r.x<=e+s&&r.y>=i&&r.y<=i+o});t.shiftKey?n.forEach(r=>{this.selectedElements.includes(r)||this.selectedElements.push(r)}):this.selectedElements=n,this.updateHighlights(),p.emit("selection:changed",this.selectedElements)}if(this.isDragging){this.isDragging=!1;let e=!1;this.selectedElements.forEach(i=>{const s=this.elementStartPositions.get(i.id);s&&(i.x!==s.x||i.y!==s.y)&&(e=!0)}),e&&this.selectedElements.forEach(i=>{const s=this.elementStartPositions.get(i.id);if(s&&(i.x!==s.x||i.y!==s.y)){const o=new ft(i,s.x,s.y,i.x,i.y);S.execute(o)}})}this.isPanning=!1,this.svg.style.cursor="default"}}class nt{constructor(t){d(this,"element");this.element=t}execute(){y.addElement(this.element)}undo(){y.removeElement(this.element.id)}}class xt{constructor(){d(this,"rules",[])}addRule(t){this.rules.push(t)}validate(t,e,i){for(const s of this.rules){const o=s.validate(t,e,i);if(!o.isValid)return o}return{isValid:!0}}}const X=new xt,F="http://www.w3.org/2000/svg";function ot(c){const t=document.createElementNS(F,"g"),e=20,i=[];i.push({x:0,y:0});let s={x:0,y:0};if(c.sourceDirection){const m=c.sourceDirection==="left"?-e:c.sourceDirection==="right"?e:0,A=c.sourceDirection==="top"?-e:c.sourceDirection==="bottom"?e:0;s={x:s.x+m,y:s.y+A},i.push(s)}const o={x:c.x2-c.x,y:c.y2-c.y};let n={...o};if(c.targetDirection){const m=c.targetDirection==="left"?-e:c.targetDirection==="right"?e:0,A=c.targetDirection==="top"?-e:c.targetDirection==="bottom"?e:0;n={x:n.x+m,y:n.y+A}}const r=m=>m==="left"||m==="right",a=c.sourceDirection?r(c.sourceDirection):!1;let l=!0;c.sourceDirection?l=!a:c.targetDirection&&(r(c.targetDirection)?l=!0:l=!1);const u=40,h=40,g=20;if(l){let m=n.y;(s.y>0&&n.y<0||s.y<0&&n.y>0)&&(m=s.y+(s.y>0?g:-g));const z=c.targetDirection==="top"||c.targetDirection==="bottom";let $=!1;if(z&&(c.targetDirection==="top"&&m>n.y&&($=!0),c.targetDirection==="bottom"&&m<n.y&&($=!0)),$){i.push({x:s.x,y:m});const O=Math.abs(s.x-n.x)<u;let I=s.x;O?I=Math.max(s.x,n.x)+h:I=(s.x+n.x)/2,i.push({x:I,y:m});const W=n.y+(c.targetDirection==="top"?-g:g);i.push({x:I,y:W}),i.push({x:n.x,y:W}),i.push({x:n.x,y:n.y})}else i.push({x:s.x,y:m}),i.push({x:n.x,y:m}),i.push({x:n.x,y:n.y})}else{let m=n.x;(s.x>0&&n.x<0||s.x<0&&n.x>0)&&(m=s.x+(s.x>0?g:-g));const z=c.targetDirection==="left"||c.targetDirection==="right";let $=!1;if(z&&(c.targetDirection==="left"&&m>n.x&&($=!0),c.targetDirection==="right"&&m<n.x&&($=!0)),$){i.push({x:m,y:s.y});const O=Math.abs(s.y-n.y)<u;let I=s.y;O?I=Math.max(s.y,n.y)+h:I=(s.y+n.y)/2,i.push({x:m,y:I});const W=n.x+(c.targetDirection==="left"?-g:g);i.push({x:W,y:I}),i.push({x:W,y:n.y}),i.push({x:n.x,y:n.y})}else i.push({x:m,y:s.y}),i.push({x:m,y:n.y}),i.push({x:n.x,y:n.y})}i.push(o);const x=i.map((m,A)=>`${A===0?"M":"L"} ${m.x} ${m.y}`).join(" "),b=document.createElementNS(F,"path");b.setAttribute("d",x);let C="#333";y.isSimulationMode&&(C=c.isEnergized?"#4caf50":"#f44336"),b.setAttribute("stroke",C),b.setAttribute("stroke-width","1.5"),b.setAttribute("fill","none"),b.setAttribute("stroke-linejoin","round");const f=document.createElementNS(F,"path");return f.setAttribute("d",x),f.setAttribute("stroke","white"),f.setAttribute("stroke-opacity","0"),f.setAttribute("stroke-width","10"),f.setAttribute("fill","none"),f.setAttribute("cursor","pointer"),t.appendChild(b),t.appendChild(f),t}class bt{constructor(){d(this,"container");this.container=document.createElement("div"),this.container.className="notification-container",document.body.appendChild(this.container)}show(t,e="info",i=3e3){const s=document.createElement("div");s.className=`notification-toast ${e}`;const o=this.getIcon(e),n=document.createElement("span");n.textContent=t,s.innerHTML=`${o}`,s.appendChild(n);const r=document.createElement("button");r.className="notification-close",r.innerHTML="&times;",r.onclick=()=>{this.dismiss(s)},s.appendChild(r),this.container.appendChild(s),requestAnimationFrame(()=>{s.classList.add("show")}),i>0&&setTimeout(()=>{this.dismiss(s)},i)}dismiss(t){t.classList.remove("show"),t.addEventListener("transitionend",()=>{t.parentElement&&t.parentElement.removeChild(t)})}getIcon(t){switch(t){case"success":return'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';case"error":return'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';case"warning":return'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';case"info":default:return'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'}}}const j=new bt,vt="http://www.w3.org/2000/svg";class Et{constructor(t,e,i){d(this,"name","wire");d(this,"svg");d(this,"sceneGroup");d(this,"getView");d(this,"isDrawing",!1);d(this,"activeWire",null);d(this,"activeView",null);d(this,"startPort",null);d(this,"highlightCircle");this.svg=t,this.sceneGroup=e,this.getView=i,this.highlightCircle=document.createElementNS(vt,"circle"),this.highlightCircle.setAttribute("r","5"),this.highlightCircle.setAttribute("fill","rgba(0, 255, 0, 0.5)"),this.highlightCircle.setAttribute("stroke","green"),this.highlightCircle.setAttribute("stroke-width","1"),this.highlightCircle.style.display="none",this.highlightCircle.style.pointerEvents="none"}activate(){this.svg.style.cursor="crosshair",this.svg.appendChild(this.highlightCircle)}deactivate(){this.isDrawing&&this.activeView&&(this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null,this.activeWire=null,this.isDrawing=!1),this.highlightCircle.parentElement&&this.highlightCircle.parentElement.removeChild(this.highlightCircle)}getWorldPosition(t){const e=this.getView(),i=this.svg.getBoundingClientRect(),s=t.clientX-i.left,o=t.clientY-i.top;return{x:(s-e.x)/e.scale,y:(o-e.y)/e.scale}}findNearestPort(t,e){let s=null,o=15;for(const n of y.getAllElements())if(!(n instanceof w))for(const r of n.getPorts()){const a=r.x-t,l=r.y-e,u=Math.sqrt(a*a+l*l);u<o&&(o=u,s=r)}return s}updateHighlight(t){t?(this.highlightCircle.style.display="block",this.highlightCircle.parentElement!==this.sceneGroup&&this.sceneGroup.appendChild(this.highlightCircle),this.highlightCircle.setAttribute("cx",`${t.x}`),this.highlightCircle.setAttribute("cy",`${t.y}`)):this.highlightCircle.style.display="none"}updateActiveView(){this.activeWire&&(this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=ot(this.activeWire),this.activeView.setAttribute("transform",`translate(${this.activeWire.x}, ${this.activeWire.y}) rotate(${this.activeWire.rotation})`),this.activeView.style.pointerEvents="none",this.sceneGroup.appendChild(this.activeView))}onMouseDown(t){if(t.button!==0)return;const e=this.getWorldPosition(t),i=this.findNearestPort(e.x,e.y);i&&(this.isDrawing=!0,this.startPort=i,document.body.classList.add("no-select"),this.activeWire=new w({x:i.x,y:i.y,x2:i.x,y2:i.y,sourcePortId:i.id,sourceDirection:i.direction}),this.updateActiveView())}getBusPortDirection(t,e){const i=y.getElement(t.elementId);if(i&&i instanceof E)return i.getPreferredPortDirection(t.id,e)}onMouseMove(t){const e=this.getWorldPosition(t),i=this.findNearestPort(e.x,e.y);if(this.updateHighlight(i),this.isDrawing&&this.activeWire){let s=e.x,o=e.y,n;if(this.startPort&&!this.startPort.direction){const r=this.getBusPortDirection(this.startPort,{x:s,y:o});r&&(this.activeWire.sourceDirection=r)}i&&(s=i.x,o=i.y,n=i.direction,n||(n=this.getBusPortDirection(i,{x:this.activeWire.x,y:this.activeWire.y}))),this.activeWire.setEnd(s,o,n),this.updateActiveView()}}onMouseUp(t){if(!this.isDrawing)return;const e=this.getWorldPosition(t),i=this.findNearestPort(e.x,e.y);if(i&&this.activeWire&&this.startPort&&i.id!==this.startPort.id){const s=X.validate(this.startPort,i,y);if(!s.isValid){const r=s.message||"Invalid connection";console.warn(r),j.show(r,"error"),this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null,this.activeWire=null,this.isDrawing=!1,this.startPort=null,document.body.classList.remove("no-select");return}this.activeWire.targetPortId=i.id;let o=i.direction;o||(o=this.getBusPortDirection(i,{x:this.activeWire.x,y:this.activeWire.y})),this.activeWire.setEnd(i.x,i.y,o),this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null;const n=new nt(this.activeWire);S.execute(n),console.log(`Connected ${this.startPort.id} to ${i.id}`)}else this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null;this.activeWire=null,this.isDrawing=!1,this.startPort=null,document.body.classList.remove("no-select")}}class wt{constructor(t,e,i){d(this,"name","simulation");d(this,"isPanning",!1);d(this,"panStartX",0);d(this,"panStartY",0);d(this,"svg");d(this,"view");d(this,"updateFn");this.svg=t,this.view=e,this.updateFn=i}activate(){this.svg.style.cursor="pointer",y.startSimulation()}deactivate(){this.isPanning=!1,this.svg.style.cursor="default",y.stopSimulation()}findElementFromTarget(t){if(!(t instanceof Element))return null;let e=t;for(;e&&e!==this.svg;){if(e.tagName==="g"&&e.hasAttribute("id")){const i=e.getAttribute("id");if(i)return y.getElement(i)||null}e=e.parentElement}return null}onMouseDown(t){if(t.button===1){this.startPan(t);return}if(t.button===0){const e=this.findElementFromTarget(t.target);if(e){let i=!1;e instanceof U?(e.isOpen=!e.isOpen,i=!0):e instanceof J&&(e.isOn=!e.isOn,i=!0),i&&(p.emit("element:modified",e),y.runSimulation())}}}startPan(t){this.isPanning=!0,this.panStartX=t.clientX,this.panStartY=t.clientY,this.svg.style.cursor="grabbing"}onMouseMove(t){if(this.isPanning){const e=t.clientX-this.panStartX,i=t.clientY-this.panStartY;this.view.x+=e,this.view.y+=i,this.panStartX=t.clientX,this.panStartY=t.clientY,this.updateFn();return}}onMouseUp(){this.isPanning=!1,this.svg.style.cursor="pointer"}}class Q{constructor(t,e){d(this,"element");d(this,"oldRotation");d(this,"newRotation");this.element=t,this.oldRotation=t.rotation,this.newRotation=e}execute(){this.element.rotation=this.newRotation,p.emit("element:modified",this.element),this.updateConnectedWires()}undo(){this.element.rotation=this.oldRotation,p.emit("element:modified",this.element),this.updateConnectedWires()}updateConnectedWires(){const t=y.getAllElements().filter(n=>n instanceof w),e=n=>n&&n.startsWith(`${this.element.id}:`),i=this.element.getPorts(),s=new Map(i.map(n=>[n.id,n])),o=this.element instanceof E;t.forEach(n=>{let r=!1;if(e(n.sourcePortId)){const a=s.get(n.sourcePortId);if(a){n.x=a.x,n.y=a.y;let l=a.direction;if(!l&&o&&(l=this.element.getPreferredPortDirection(a.id,{x:n.x2,y:n.y2})),n.sourceDirection=l||null,r=!0,n.targetPortId){const u=n.targetPortId.split(":")[0],h=y.getElement(u);if(h&&h instanceof E){const g=h.getPreferredPortDirection(n.targetPortId,{x:n.x,y:n.y});g&&(n.targetDirection=g,r=!0)}}}}if(e(n.targetPortId)){const a=s.get(n.targetPortId);if(a){let l=a.direction;if(!l&&o&&(l=this.element.getPreferredPortDirection(a.id,{x:n.x,y:n.y})),n.setEnd(a.x,a.y,l),r=!0,n.sourcePortId){const u=n.sourcePortId.split(":")[0],h=y.getElement(u);if(h&&h instanceof E){const g=h.getPreferredPortDirection(n.sourcePortId,{x:n.x2,y:n.y2});g&&(n.sourceDirection=g,r=!0)}}}}r&&p.emit("element:modified",n)})}}class At{constructor(t,e,i,s,o){d(this,"element");d(this,"oldName");d(this,"newName");d(this,"oldDesc");d(this,"newDesc");this.element=t,this.oldName=e,this.newName=i,this.oldDesc=s,this.newDesc=o}execute(){this.element.name=this.newName,this.element.description=this.newDesc,p.emit("element:modified",this.element)}undo(){this.element.name=this.oldName,this.element.description=this.oldDesc,p.emit("element:modified",this.element)}}class Pt{constructor(t){d(this,"container");d(this,"items",[]);d(this,"elementMap",new Map);const e=document.getElementById(t);if(!e)throw new Error(`Toolbar container ${t} not found`);this.container=e,this.container.innerHTML=""}addItem(t){this.items.push(t)}addSeparator(){this.items.push({id:`sep-${Math.random()}`,label:"",type:"action",onClick:()=>{},group:"__separator__"})}render(){this.container.innerHTML="",this.elementMap.clear();let t=null;this.items.forEach((e,i)=>{if(e.group==="__separator__"){const n=document.createElement("div");n.className="separator",this.container.appendChild(n),t=null;return}t||(t=document.createElement("div"),t.className="toolbar-group",this.container.appendChild(t));const s=document.createElement("button");s.id=e.id,s.className="tool-btn",e.title?s.title=e.title:e.label&&(s.title=e.label),e.icon?(e.icon.includes("<svg")?s.innerHTML=e.icon:s.textContent=e.icon,s.classList.add("icon-btn")):(s.textContent=e.label,s.classList.add("text-btn")),e.draggable&&(s.draggable=!0,s.addEventListener("dragstart",n=>{n.dataTransfer&&(n.dataTransfer.setData("application/esld-tool",e.id),n.dataTransfer.effectAllowed="copy")})),s.addEventListener("click",()=>{e.onClick(),this.updateActiveState()}),this.elementMap.set(e.id,s),t.appendChild(s);const o=this.items[i+1];o&&o.group==="__separator__"&&(t=null)}),this.updateActiveState()}setActive(t){this.elementMap.forEach(i=>i.classList.remove("active"));const e=this.elementMap.get(t);e&&e.classList.add("active")}updateItem(t,e){const i=this.items.findIndex(n=>n.id===t);if(i===-1)return;const s=this.items[i];Object.assign(s,e);const o=this.elementMap.get(t);o&&(e.title&&(o.title=e.title),e.label&&!s.icon&&(o.textContent=e.label),e.icon&&(e.icon.includes("<svg")?o.innerHTML=e.icon:o.textContent=e.icon))}updateActiveState(){this.items.forEach(t=>{t.isActive&&t.isActive()&&this.setActive(t.id)})}}class St{constructor(t){d(this,"container");d(this,"items",[]);const e=document.getElementById(t);if(!e)throw new Error(`Library container ${t} not found`);this.container=e}addItem(t){this.items.push(t)}render(){this.container.innerHTML="";const t=new Map,e="General";this.items.forEach(i=>{const s=i.category||e;t.has(s)||t.set(s,[]),t.get(s).push(i)}),t.forEach((i,s)=>{const o=document.createElement("div");o.className="library-category",o.textContent=s,this.container.appendChild(o);const n=document.createElement("div");n.className="library-grid",i.forEach(r=>{const a=document.createElement("div");a.className="library-item",a.draggable=!0,a.innerHTML=`
                    ${r.icon}
                    <span>${r.label}</span>
                `,a.addEventListener("dragstart",l=>{l.dataTransfer&&(l.dataTransfer.setData("application/esld-tool",r.id),l.dataTransfer.effectAllowed="copy")}),n.appendChild(a)}),this.container.appendChild(n)})}}class Ct{constructor(){d(this,"name","Single Connection Check")}validate(t,e,i){const s=i.getAllElements().filter(o=>o instanceof w);for(const o of s){if(o.sourcePortId===t.id)return{isValid:!1,message:"Source port is already connected."};if(o.targetPortId===t.id)return{isValid:!1,message:"Source port is already connected."};if(o.sourcePortId===e.id)return{isValid:!1,message:"Target port is already connected."};if(o.targetPortId===e.id)return{isValid:!1,message:"Target port is already connected."}}return{isValid:!0}}}class Mt{constructor(){d(this,"name","Component Compatibility");d(this,"allowedConnections",{BusElement:["BreakerElement","GeneratorElement","LoadElement","TransformerElement","JunctionElement"],BreakerElement:["BusElement","JunctionElement","TransformerElement","GeneratorElement","LoadElement"],GeneratorElement:["BusElement","TransformerElement","BreakerElement"],LoadElement:["BusElement","BreakerElement","TransformerElement"],TransformerElement:["BusElement","BreakerElement","GeneratorElement","LoadElement","JunctionElement"],JunctionElement:["BusElement","BreakerElement","TransformerElement","GeneratorElement","LoadElement","JunctionElement"]})}validate(t,e,i){const s=i.getElement(t.elementId),o=i.getElement(e.elementId);if(!s||!o)return{isValid:!1,message:"Element not found."};const n=s.type,r=o.type,a=this.allowedConnections[r];if(a&&a.includes(n))return{isValid:!0};const l=this.allowedConnections[n];return l&&l.includes(r)?{isValid:!0}:{isValid:!1,message:`Cannot connect ${n} to ${r}.`}}}class $t{constructor(){d(this,"name","Self-Connection Check")}validate(t,e,i){return t.elementId===e.elementId?{isValid:!1,message:"Cannot connect a component to itself."}:{isValid:!0}}}class It{constructor(){d(this,"name","Topology Restrictions")}validate(t,e,i){const s=i.getElement(t.elementId),o=i.getElement(e.elementId);if(!s||!o)return{isValid:!1};const n=s.type,r=o.type;return n==="GeneratorElement"&&r==="GeneratorElement"?{isValid:!1,message:"Direct Generator-to-Generator connections are not allowed. Use a Bus or Synchronizer."}:n==="LoadElement"&&r==="LoadElement"?{isValid:!1,message:"Direct Load-to-Load connections are not allowed. Connect them to a common Bus."}:{isValid:!0}}}const G="http://www.w3.org/2000/svg";function Dt(c){const t=document.createElementNS(G,"g"),e=20,i=40,s=document.createElementNS(G,"rect");s.setAttribute("x",`${-i/2}`),s.setAttribute("y",`${-i/2}`),s.setAttribute("width",`${i}`),s.setAttribute("height",`${i}`),s.setAttribute("fill","white"),s.setAttribute("fill-opacity","0"),s.setAttribute("cursor","pointer"),t.appendChild(s);const o=document.createElementNS(G,"rect");o.setAttribute("x",`${-e/2}`),o.setAttribute("y",`${-e/2}`),o.setAttribute("width",`${e}`),o.setAttribute("height",`${e}`),c.isOpen?o.setAttribute("fill","white"):y.isSimulationMode?o.setAttribute("fill",c.isEnergized?"#4caf50":"#f44336"):o.setAttribute("fill","#333"),o.setAttribute("stroke","black"),o.setAttribute("stroke-width","2");const n=document.createElementNS(G,"text"),r=(c.rotation||0)*(Math.PI/180),u=e/2*(Math.abs(Math.cos(r))+Math.abs(Math.sin(r)))+15,h=u*Math.sin(r),g=u*Math.cos(r);return n.setAttribute("x",`${h}`),n.setAttribute("y",`${g}`),n.setAttribute("transform",`rotate(${-(c.rotation||0)} ${h} ${g})`),n.setAttribute("text-anchor","middle"),n.setAttribute("font-size","12"),n.setAttribute("fill","#666"),n.textContent=c.name,t.appendChild(o),t.appendChild(n),t}const R="http://www.w3.org/2000/svg";function kt(c){const t=document.createElementNS(R,"g"),e=document.createElementNS(R,"line");e.setAttribute("x1",`${-c.length/2}`),e.setAttribute("y1","0"),e.setAttribute("x2",`${c.length/2}`),e.setAttribute("y2","0");let i="#333";y.isSimulationMode&&(i=c.isEnergized?"#4caf50":"#f44336"),e.setAttribute("stroke",i),e.setAttribute("stroke-width","4"),e.setAttribute("stroke-linecap","square");const s=document.createElementNS(R,"line");s.setAttribute("x1",`${-c.length/2}`),s.setAttribute("y1","0"),s.setAttribute("x2",`${c.length/2}`),s.setAttribute("y2","0"),s.setAttribute("stroke","white"),s.setAttribute("stroke-opacity","0"),s.setAttribute("stroke-width","10"),s.setAttribute("cursor","pointer");const o=document.createElementNS(R,"text"),n=(c.rotation||0)*(Math.PI/180),u=c.length/2*Math.abs(Math.sin(n))+2*Math.abs(Math.cos(n))+15,h=u*Math.sin(n),g=u*Math.cos(n);return o.setAttribute("x",`${h}`),o.setAttribute("y",`${g}`),o.setAttribute("transform",`rotate(${-(c.rotation||0)} ${h} ${g})`),o.setAttribute("text-anchor","middle"),o.setAttribute("font-size","12"),o.setAttribute("fill","#666"),o.textContent=c.name,t.appendChild(e),t.appendChild(s),t.appendChild(o),t}const H="http://www.w3.org/2000/svg";function Lt(c){const t=document.createElementNS(H,"g"),e=20,i=document.createElementNS(H,"rect"),s=e*2+10;i.setAttribute("x",`${-s/2}`),i.setAttribute("y",`${-s/2}`),i.setAttribute("width",`${s}`),i.setAttribute("height",`${s}`),i.setAttribute("fill","white"),i.setAttribute("fill-opacity","0"),i.setAttribute("cursor","pointer"),t.appendChild(i);const o=document.createElementNS(H,"circle");if(o.setAttribute("cx","0"),o.setAttribute("cy","0"),o.setAttribute("r",`${e}`),!c.isOn)o.setAttribute("fill","#eeeeee"),o.setAttribute("stroke","#999999");else{o.setAttribute("fill","white");let g="black";y.isSimulationMode&&(g=c.isEnergized?"#4caf50":"black"),o.setAttribute("stroke",g)}o.setAttribute("stroke-width","2");const n=document.createElementNS(H,"text");n.setAttribute("x","0"),n.setAttribute("y","5"),n.setAttribute("text-anchor","middle"),n.setAttribute("font-size","20"),n.setAttribute("font-weight","bold"),n.setAttribute("fill","black"),n.textContent="G";const r=document.createElementNS(H,"text"),a=e+15,l=(c.rotation||0)*(Math.PI/180),u=a*Math.sin(l),h=a*Math.cos(l);return r.setAttribute("x",`${u}`),r.setAttribute("y",`${h}`),r.setAttribute("transform",`rotate(${-(c.rotation||0)} ${u} ${h})`),r.setAttribute("text-anchor","middle"),r.setAttribute("font-size","12"),r.setAttribute("fill","#666"),r.textContent=c.name,t.appendChild(o),t.appendChild(n),t.appendChild(r),t}const K="http://www.w3.org/2000/svg";function Tt(c){const t=document.createElementNS(K,"g"),e=4,i=document.createElementNS(K,"circle");i.setAttribute("cx","0"),i.setAttribute("cy","0"),i.setAttribute("r",`${e}`);let s="#333";y.isSimulationMode&&(s=c.isEnergized?"#4caf50":"#f44336"),i.setAttribute("fill",s);const o=document.createElementNS(K,"circle");return o.setAttribute("cx","0"),o.setAttribute("cy","0"),o.setAttribute("r","10"),o.setAttribute("fill","white"),o.setAttribute("fill-opacity","0"),o.setAttribute("cursor","pointer"),t.appendChild(i),t.appendChild(o),t}const Y="http://www.w3.org/2000/svg";function Bt(c){const t=document.createElementNS(Y,"g"),e=30,i=e/2,s=document.createElementNS(Y,"rect"),o=e+10;s.setAttribute("x",`${-o/2}`),s.setAttribute("y",`${-o/2}`),s.setAttribute("width",`${o}`),s.setAttribute("height",`${o}`),s.setAttribute("fill","white"),s.setAttribute("fill-opacity","0"),s.setAttribute("cursor","pointer"),t.appendChild(s);let n="#333",r="#333";y.isSimulationMode&&(n=c.isEnergized?"#4caf50":"#f44336",r=c.isEnergized?"#4caf50":"#f44336");const a=document.createElementNS(Y,"line");a.setAttribute("x1","0"),a.setAttribute("y1",`${-i}`),a.setAttribute("x2","0"),a.setAttribute("y2",`${i}`),a.setAttribute("stroke",n),a.setAttribute("stroke-width","2");const l=document.createElementNS(Y,"polygon"),u=10,h=10,g=`${-u/2},${i-h} ${u/2},${i-h} 0,${i}`;l.setAttribute("points",g),l.setAttribute("fill",r);const x=document.createElementNS(Y,"text"),b=(c.rotation||0)*(Math.PI/180),f=15*Math.abs(Math.cos(b))+5*Math.abs(Math.sin(b))+15,m=f*Math.sin(b),A=f*Math.cos(b);return x.setAttribute("x",`${m}`),x.setAttribute("y",`${A}`),x.setAttribute("transform",`rotate(${-(c.rotation||0)} ${m} ${A})`),x.setAttribute("text-anchor","middle"),x.setAttribute("font-size","12"),x.setAttribute("fill","#666"),x.textContent=c.name,t.appendChild(a),t.appendChild(l),t.appendChild(x),t}const T="http://www.w3.org/2000/svg";function Nt(c){const t=document.createElementNS(T,"g"),e=15,i=document.createElementNS(T,"rect"),s=e*2*2+10,o=e*2+10;i.setAttribute("x",`${-o/2}`),i.setAttribute("y",`${-s/2}`),i.setAttribute("width",`${o}`),i.setAttribute("height",`${s}`),i.setAttribute("fill","white"),i.setAttribute("fill-opacity","0"),i.setAttribute("cursor","pointer"),t.appendChild(i);let n="#333";y.isSimulationMode&&(n=c.isEnergized?"#4caf50":"#f44336");const r=document.createElementNS(T,"line");r.setAttribute("x1","0"),r.setAttribute("y1",`${-e*2}`),r.setAttribute("x2","0"),r.setAttribute("y2",`${-e/1.5-e}`),r.setAttribute("stroke",n),r.setAttribute("stroke-width","2");const a=document.createElementNS(T,"line");a.setAttribute("x1","0"),a.setAttribute("y1",`${e*2}`),a.setAttribute("x2","0"),a.setAttribute("y2",`${e/1.5+e}`),a.setAttribute("stroke",n),a.setAttribute("stroke-width","2");const l=document.createElementNS(T,"circle");l.setAttribute("cx","0"),l.setAttribute("cy",`${-e/1.5}`),l.setAttribute("r",`${e}`),l.setAttribute("fill","none"),l.setAttribute("stroke",n),l.setAttribute("stroke-width","2");const u=document.createElementNS(T,"circle");u.setAttribute("cx","0"),u.setAttribute("cy",`${e/1.5}`),u.setAttribute("r",`${e}`),u.setAttribute("fill","none"),u.setAttribute("stroke",n),u.setAttribute("stroke-width","2");const h=document.createElementNS(T,"text"),g=(c.rotation||0)*(Math.PI/180),b=e*2*Math.abs(Math.cos(g))+e*Math.abs(Math.sin(g))+15,C=b*Math.sin(g),f=b*Math.cos(g);return h.setAttribute("x",`${C}`),h.setAttribute("y",`${f}`),h.setAttribute("transform",`rotate(${-(c.rotation||0)} ${C} ${f})`),h.setAttribute("text-anchor","middle"),h.setAttribute("font-size","12"),h.setAttribute("fill","#666"),h.textContent=c.name,t.appendChild(r),t.appendChild(a),t.appendChild(l),t.appendChild(u),t.appendChild(h),t}function Z(c){return c instanceof U?Dt:c instanceof E?kt:c instanceof J?Lt:c instanceof st?Tt:c instanceof it?Bt:c instanceof et?Nt:c instanceof w?ot:null}class Vt{constructor(t){d(this,"sceneGroup");d(this,"elementViews",new Map);this.sceneGroup=t,this.bindEvents()}bindEvents(){p.on("element:added",t=>{this.renderElement(t)}),p.on("element:removed",t=>{this.removeElement(t)}),p.on("element:modified",t=>{this.updateElement(t)}),p.on("project:cleared",()=>{this.clearScene()})}renderElement(t){const e=Z(t);if(!e)return;const i=e(t);i.setAttribute("id",t.id),this.applyTransform(i,t),this.sceneGroup.appendChild(i),this.elementViews.set(t.id,i)}updateElement(t){let e=this.elementViews.get(t.id);if(!e){this.renderElement(t);return}const i=Z(t);if(!i)return;const s=i(t);s.setAttribute("id",t.id),this.applyTransform(s,t),this.sceneGroup.replaceChild(s,e),this.elementViews.set(t.id,s)}applyTransform(t,e){t.setAttribute("transform",`translate(${e.x}, ${e.y}) rotate(${e.rotation})`)}removeElement(t){const e=this.elementViews.get(t.id);e&&e.parentElement&&e.parentElement.removeChild(e),this.elementViews.delete(t.id)}clearScene(){for(;this.sceneGroup.firstChild;)this.sceneGroup.removeChild(this.sceneGroup.firstChild);this.elementViews.clear()}getView(t){return this.elementViews.get(t)}updateViewTransform(t,e){const i=this.elementViews.get(t);i&&i.setAttribute("transform",e)}}X.addRule(new Ct);X.addRule(new Mt);X.addRule(new $t);X.addRule(new It);const P=document.getElementById("main-svg"),N="http://www.w3.org/2000/svg";let v={x:0,y:0,scale:1},L,V,D,M;const tt={"btn-bus":(c,t)=>k.create({type:"BusElement",x:c,y:t,length:100}),"btn-breaker":(c,t)=>k.create({type:"BreakerElement",x:c,y:t}),"btn-transformer":(c,t)=>k.create({type:"TransformerElement",x:c,y:t}),"btn-gen":(c,t)=>k.create({type:"GeneratorElement",x:c,y:t}),"btn-load-elem":(c,t)=>k.create({type:"LoadElement",x:c,y:t}),"btn-junction":(c,t)=>k.create({type:"JunctionElement",x:c,y:t})};function zt(c,t){const e=P.getBoundingClientRect(),i=c-e.left,s=t-e.top,o=(i-v.x)/v.scale,n=(s-v.y)/v.scale;return{x:Math.round(o/20)*20,y:Math.round(n/20)*20}}function Ot(){var b,C;if(!P)return;const c=document.createElementNS(N,"defs");D=document.createElementNS(N,"pattern"),D.setAttribute("id","grid-pattern"),D.setAttribute("width","20"),D.setAttribute("height","20"),D.setAttribute("patternUnits","userSpaceOnUse");const t=document.createElementNS(N,"path");t.setAttribute("d","M 20 0 L 0 0 0 20"),t.setAttribute("fill","none"),t.setAttribute("stroke","#e0e0e0"),t.setAttribute("stroke-width","1"),D.appendChild(t),c.appendChild(D),P.appendChild(c);const e=document.createElementNS(N,"rect");e.setAttribute("width","100%"),e.setAttribute("height","100%"),e.setAttribute("fill","url(#grid-pattern)"),e.style.cursor="grab",P.appendChild(e),L=document.createElementNS(N,"g"),L.setAttribute("id","scene-layer"),P.appendChild(L),V=document.createElementNS(N,"g"),V.setAttribute("id","interaction-layer"),V.style.pointerEvents="none",P.appendChild(V);const i=new Vt(L);M=new lt;const s=()=>v,o=document.getElementById("prop-form"),n=document.querySelector(".empty-state"),r=document.getElementById("prop-name"),a=document.getElementById("prop-desc");let l=null;const u=()=>{if(!l||l.name===r.value&&l.description===a.value)return;const f=new At(l,l.name,r.value,l.description,a.value);S.execute(f)};r==null||r.addEventListener("change",u),a==null||a.addEventListener("change",u),(b=document.getElementById("btn-rotate-cw"))==null||b.addEventListener("click",()=>{if(!l||l instanceof w)return;const f=(l.rotation+90)%360,m=new Q(l,f);S.execute(m)}),(C=document.getElementById("btn-rotate-ccw"))==null||C.addEventListener("click",()=>{if(!l||l instanceof w)return;let f=(l.rotation-90)%360;f<0&&(f+=360);const m=new Q(l,f);S.execute(m)}),p.on("selection:changed",f=>{f.length>0?(l=f[0],o.style.display="block",n.style.display="none",r.value=l.name,a.value=l.description):(l=null,o.style.display="none",n.style.display="block")}),p.on("history:changed",()=>{l&&(r.value=l.name,a.value=l.description)}),M.registerTool(new yt(P,V,v,q,i)),M.registerTool(new Et(P,L,s)),M.registerTool(new wt(P,v,q)),P.addEventListener("mousedown",f=>M.onMouseDown(f)),window.addEventListener("mousemove",f=>M.onMouseMove(f)),window.addEventListener("mouseup",f=>M.onMouseUp(f)),P.addEventListener("wheel",Ht,{passive:!1}),P.addEventListener("dragover",f=>{f.preventDefault(),f.dataTransfer.dropEffect="copy"}),P.addEventListener("drop",f=>{f.preventDefault();const m=f.dataTransfer.getData("application/esld-tool");if(!m||!tt[m])return;const{x:A,y:z}=zt(f.clientX,f.clientY),$=tt[m](A,z);if($){const O=new nt($);S.execute(O)}}),window.addEventListener("keydown",f=>{var A;const m=(A=document.activeElement)==null?void 0:A.tagName.toLowerCase();m==="input"||m==="textarea"||((f.ctrlKey||f.metaKey)&&f.key.toLowerCase()==="z"?f.shiftKey?(f.preventDefault(),S.redo()):(f.preventDefault(),S.undo()):(f.ctrlKey||f.metaKey)&&f.key.toLowerCase()==="y"&&(f.preventDefault(),S.redo()))});const h=new Pt("toolbar"),g=new St("library-content");g.addItem({id:"btn-bus",label:"Busbar",category:"Conducting",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='4' y='10' width='16' height='4' rx='1' fill='currentColor'/></svg>"}),g.addItem({id:"btn-junction",label:"Junction",category:"Conducting",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><circle cx='12' cy='12' r='4' fill='currentColor'/></svg>"}),g.addItem({id:"btn-gen",label:"Generator",category:"Sources",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><circle cx='12' cy='12' r='9'/><text x='12' y='16' text-anchor='middle' font-size='12' font-weight='bold' style='fill:currentColor;stroke:none'>G</text></svg>"}),g.addItem({id:"btn-load-elem",label:"Load",category:"Loads",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M12 3v16m-5-5l5 5 5-5'/></svg>"}),g.addItem({id:"btn-breaker",label:"Breaker",category:"Protection",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><rect x='5' y='5' width='14' height='14'/></svg>"}),g.addItem({id:"btn-transformer",label:"Transformer",category:"Equipment",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><circle cx='12' cy='9' r='5'/><circle cx='12' cy='15' r='5'/><line x1='12' y1='4' x2='12' y2='9'/><line x1='12' y1='15' x2='12' y2='20'/></svg>"}),g.render(),h.addItem({id:"btn-select",label:"Select",title:"Select Tool",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z'/></svg>",onClick:()=>M.activateTool("select")}),h.addItem({id:"btn-wire",label:"Wire",title:"Wire Tool",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M4 4h16v2H4zm0 7h16v2H4zm0 7h16v2H4z'/></svg>",onClick:()=>M.activateTool("wire")}),h.addItem({id:"btn-sim",label:"Simulate",title:"Simulation Mode",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M8 5v14l11-7z'/></svg>",onClick:()=>{M.activateTool("simulation"),console.log(M)}}),h.addSeparator(),h.addItem({id:"btn-save",label:"Save",title:"Save Project",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z'/></svg>",onClick:()=>{const f=y.save();localStorage.setItem("esld_project",f),j.show("Project Saved to LocalStorage!","success")}}),h.addItem({id:"btn-load",label:"Load",title:"Load Project",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z'/></svg>",onClick:()=>{const f=localStorage.getItem("esld_project");f?(y.load(f),j.show("Project Loaded Successfully!","success")):j.show("No saved project found!","warning")}}),h.addItem({id:"btn-export",label:"Export",title:"Export as PNG",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z'/></svg>",onClick:Wt}),h.addSeparator(),h.addItem({id:"btn-undo",label:"Undo",title:"Undo Last Action",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z'/></svg>",onClick:()=>S.undo()}),h.addItem({id:"btn-redo",label:"Redo",title:"Redo Last Action",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z'/></svg>",onClick:()=>S.redo()}),h.render();const x={select:"btn-select",wire:"btn-wire",simulation:"btn-sim"};p.on("tool:activated",f=>{const m=x[f];m&&h.setActive(m),f==="simulation"?h.updateItem("btn-sim",{label:"Stop",title:"Stop Simulation",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M6 6h12v12H6z'/></svg>"}):h.updateItem("btn-sim",{label:"Simulate",title:"Start Simulation",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M8 5v14l11-7z'/></svg>"})}),M.activateTool("select")}function Wt(){const c=L.getBBox(),t=50,e=c.width+t*2||800,i=c.height+t*2||600,s=c.x-t||0,o=c.y-t||0,n=L.cloneNode(!0);n.removeAttribute("transform");const r=`
    <svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${i}" viewBox="${s} ${o} ${e} ${i}">
        <style>
            text { font-family: sans-serif; }
        </style>
        <rect x="${s}" y="${o}" width="${e}" height="${i}" fill="white"/>
        ${n.outerHTML}
    </svg>`,a=new Blob([r],{type:"image/svg+xml;charset=utf-8"}),l=URL.createObjectURL(a),u=new Image;u.onload=()=>{const h=document.createElement("canvas");h.width=e,h.height=i;const g=h.getContext("2d");if(g){g.drawImage(u,0,0);const x=h.toDataURL("image/png"),b=document.createElement("a");b.href=x,b.download="diagram.png",document.body.appendChild(b),b.click(),document.body.removeChild(b)}URL.revokeObjectURL(l)},u.src=l}function q(){const c=`translate(${v.x}, ${v.y}) scale(${v.scale})`;L.setAttribute("transform",c),V.setAttribute("transform",c),D.setAttribute("patternTransform",`translate(${v.x%(20*v.scale)}, ${v.y%(20*v.scale)}) scale(${v.scale})`)}function Ht(c){c.preventDefault();const t=.1,e=c.deltaY<0?1:-1,i=Math.exp(e*t),s=P.getBoundingClientRect(),o=c.clientX-s.left,n=c.clientY-s.top,r=v.scale*i;r<.1||r>10||(v.x=o-(o-v.x)*i,v.y=n-(n-v.y)*i,v.scale=r,q())}Ot();
