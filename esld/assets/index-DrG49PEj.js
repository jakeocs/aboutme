var nt=Object.defineProperty;var ot=(c,t,e)=>t in c?nt(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var l=(c,t,e)=>ot(c,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class rt{constructor(){l(this,"activeTool",null);l(this,"tools",new Map)}registerTool(t){this.tools.set(t.name,t)}activateTool(t){var i;const e=this.tools.get(t);if(!e){console.warn(`Tool ${t} not found`);return}this.activeTool&&this.activeTool.deactivate(),this.activeTool=e,this.activeTool.activate(),document.querySelectorAll(".tool-btn").forEach(s=>s.classList.remove("active")),(i=document.getElementById(`btn-${t}`))==null||i.classList.add("active"),console.log(`Switched to tool: ${t}`)}onMouseDown(t){var e;(e=this.activeTool)==null||e.onMouseDown(t)}onMouseMove(t){var e;(e=this.activeTool)==null||e.onMouseMove(t)}onMouseUp(t){var e;(e=this.activeTool)==null||e.onMouseUp(t)}}class ct{constructor(){l(this,"listeners",{})}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}off(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(i=>i!==e))}emit(t,e){this.listeners[t]&&this.listeners[t].forEach(i=>i(e))}}const f=new ct;class L{constructor(t){l(this,"id");l(this,"x");l(this,"y");l(this,"rotation");l(this,"name");l(this,"description");this.id=t.id||crypto.randomUUID(),this.x=t.x,this.y=t.y,this.rotation=t.rotation||0,this.name=t.name||"Element",this.description=t.description||""}getTransformedPoint(t,e){const i=this.rotation*Math.PI/180,s=Math.cos(i),o=Math.sin(i),n=t*s-e*o,r=t*o+e*s;return{x:this.x+n,y:this.y+r}}getPortDirection(t){const e=["top","right","bottom","left"],i=e.indexOf(t);if(i===-1)return t;const s=Math.round(this.rotation/90)%4,o=(i+s)%4;return e[o]}toJSON(){return{id:this.id,x:this.x,y:this.y,rotation:this.rotation,name:this.name,description:this.description,type:this.type}}}class v extends L{constructor(e){super(e);l(this,"type","BusElement");l(this,"length");this.length=e.length||100}getPorts(){const e=[],i=this.length/2,s=20,o=(r,d,a)=>{const g=this.getTransformedPoint(d,0);e.push({id:`${this.id}:${r}`,elementId:this.id,x:g.x,y:g.y,direction:a?this.getPortDirection(a):void 0})};o("left",-i,"left"),o("center",0),o("right",i,"right");const n=Math.floor((i-1)/s);for(let r=1;r<=n;r++)o(`${r*s}`,r*s),o(`${-r*s}`,-r*s);return e}getPreferredPortDirection(e,i){const o=this.getPorts().find(d=>d.id===e);if(!o)return;if(o.direction)return o.direction;const n=(this.rotation%360+360)%360;return n>=45&&n<135||n>=225&&n<315?i.x<o.x?"left":"right":i.y<o.y?"top":"bottom"}toJSON(){return{...super.toJSON(),length:this.length}}}class K extends L{constructor(e){super(e);l(this,"type","BreakerElement")}getPorts(){const i=this.getTransformedPoint(0,-10),s=this.getTransformedPoint(0,20/2);return[{id:`${this.id}:top`,elementId:this.id,x:i.x,y:i.y,direction:this.getPortDirection("top")},{id:`${this.id}:bottom`,elementId:this.id,x:s.x,y:s.y,direction:this.getPortDirection("bottom")}]}}class w extends L{constructor(e){super(e);l(this,"type","WireElement");l(this,"x2");l(this,"y2");l(this,"points",[]);l(this,"sourcePortId",null);l(this,"targetPortId",null);l(this,"sourceDirection",null);l(this,"targetDirection",null);this.x2=e.x2,this.y2=e.y2,this.sourcePortId=e.sourcePortId||null,this.targetPortId=e.targetPortId||null,this.sourceDirection=e.sourceDirection||null,this.targetDirection=e.targetDirection||null}setEnd(e,i,s){this.x2=e,this.y2=i,s?this.targetDirection=s:this.targetDirection=null}getPorts(){return[]}toJSON(){return{...super.toJSON(),x2:this.x2,y2:this.y2,sourcePortId:this.sourcePortId,targetPortId:this.targetPortId,sourceDirection:this.sourceDirection,targetDirection:this.targetDirection}}}class q extends L{constructor(e){super(e);l(this,"type","TransformerElement")}getPorts(){const i=this.getTransformedPoint(0,-30),s=this.getTransformedPoint(0,15*2);return[{id:`${this.id}:top`,elementId:this.id,x:i.x,y:i.y,direction:this.getPortDirection("top")},{id:`${this.id}:bottom`,elementId:this.id,x:s.x,y:s.y,direction:this.getPortDirection("bottom")}]}}class Q extends L{constructor(e){super(e);l(this,"type","GeneratorElement")}getPorts(){const i=this.getTransformedPoint(0,20);return[{id:`${this.id}:bottom`,elementId:this.id,x:i.x,y:i.y,direction:this.getPortDirection("bottom")}]}}class Z extends L{constructor(e){super(e);l(this,"type","LoadElement")}getPorts(){const e=this.getTransformedPoint(0,-15);return[{id:`${this.id}:top`,elementId:this.id,x:e.x,y:e.y,direction:this.getPortDirection("top")}]}}class tt extends L{constructor(e){super(e);l(this,"type","JunctionElement")}getPorts(){return[{id:`${this.id}:center`,elementId:this.id,x:this.x,y:this.y}]}}class k{static create(t){let e=null;switch(t.type){case"BusElement":e=new v({id:t.id,x:t.x,y:t.y,length:t.length});break;case"BreakerElement":e=new K({id:t.id,x:t.x,y:t.y});break;case"TransformerElement":e=new q({id:t.id,x:t.x,y:t.y});break;case"GeneratorElement":e=new Q({id:t.id,x:t.x,y:t.y});break;case"LoadElement":e=new Z({id:t.id,x:t.x,y:t.y});break;case"JunctionElement":e=new tt({id:t.id,x:t.x,y:t.y});break;case"WireElement":e=new w({id:t.id,x:t.x,y:t.y,x2:t.x2,y2:t.y2,sourcePortId:t.sourcePortId,targetPortId:t.targetPortId});break}return e&&(e.rotation=t.rotation||0,e.name=t.name||"Element",e.description=t.description||""),e}}class lt{constructor(){l(this,"elements",new Map)}addElement(t){this.elements.set(t.id,t),f.emit("element:added",t)}removeElement(t){const e=this.elements.get(t);e&&(this.elements.delete(t),f.emit("element:removed",e))}getElement(t){return this.elements.get(t)}getAllElements(){return Array.from(this.elements.values())}save(){const t=Array.from(this.elements.values()).map(e=>e.toJSON());return JSON.stringify(t,null,2)}load(t){this.elements.clear(),f.emit("project:cleared",void 0);try{const e=JSON.parse(t);if(!Array.isArray(e))throw new Error("Invalid format");e.forEach(i=>{const s=k.create(i);s&&this.addElement(s)}),console.log("Project loaded successfully")}catch(e){console.error("Failed to load project",e)}}}const y=new lt;class at{constructor(){l(this,"undoStack",[]);l(this,"redoStack",[])}execute(t){t.execute(),this.undoStack.push(t),this.redoStack=[],console.log("Command executed. Undo stack:",this.undoStack.length),f.emit("history:changed",void 0)}undo(){const t=this.undoStack.pop();t&&(t.undo(),this.redoStack.push(t),console.log("Undone"),f.emit("history:changed",void 0))}redo(){const t=this.redoStack.pop();t&&(t.execute(),this.undoStack.push(t),console.log("Redone"),f.emit("history:changed",void 0))}}const P=new at;class dt{constructor(t,e){l(this,"element");l(this,"secondaryElements");this.element=t,this.secondaryElements=e}execute(){this.remove(this.element),this.secondaryElements.forEach(t=>this.remove(t))}undo(){this.restore(this.element),this.secondaryElements.forEach(t=>this.restore(t))}remove(t){y.removeElement(t.id),f.emit("element:removed",t)}restore(t){y.addElement(t),f.emit("element:added",t)}}class ht{constructor(t,e,i,s,o){l(this,"element");l(this,"oldX");l(this,"oldY");l(this,"newX");l(this,"newY");this.element=t,this.oldX=e,this.oldY=i,this.newX=s,this.newY=o}execute(){this.element.x=this.newX,this.element.y=this.newY,f.emit("element:modified",this.element),this.updateConnectedWires()}undo(){this.element.x=this.oldX,this.element.y=this.oldY,f.emit("element:modified",this.element),this.updateConnectedWires()}updateConnectedWires(){const t=y.getAllElements().filter(n=>n instanceof w),e=n=>n&&n.startsWith(`${this.element.id}:`),i=this.element.getPorts(),s=new Map(i.map(n=>[n.id,n])),o=this.element instanceof v;t.forEach(n=>{let r=!1;if(e(n.sourcePortId)){const d=s.get(n.sourcePortId);if(d){n.x=d.x,n.y=d.y;let a=d.direction;if(!a&&o&&(a=this.element.getPreferredPortDirection(d.id,{x:n.x2,y:n.y2})),n.sourceDirection=a||null,r=!0,n.targetPortId){const g=n.targetPortId.split(":")[0],h=y.getElement(g);if(h&&h instanceof v){const m=h.getPreferredPortDirection(n.targetPortId,{x:n.x,y:n.y});m&&(n.targetDirection=m,r=!0)}}}}if(e(n.targetPortId)){const d=s.get(n.targetPortId);if(d){let a=d.direction;if(!a&&o&&(a=this.element.getPreferredPortDirection(d.id,{x:n.x,y:n.y})),n.setEnd(d.x,d.y,a),r=!0,n.sourcePortId){const g=n.sourcePortId.split(":")[0],h=y.getElement(g);if(h&&h instanceof v){const m=h.getPreferredPortDirection(n.sourcePortId,{x:n.x2,y:n.y2});m&&(n.sourceDirection=m,r=!0)}}}}r&&f.emit("element:modified",n)})}}class ut{constructor(t){l(this,"elements");this.elements=t}execute(){this.elements.forEach(t=>{y.addElement(t)})}undo(){this.elements.forEach(t=>{y.removeElement(t.id)})}}class z{static copy(t){if(t.length===0){this.buffer=null;return}const e=t.map(i=>i.toJSON());this.buffer=JSON.stringify(e),console.log(`Copied ${t.length} elements to clipboard`)}static paste(){if(!this.buffer)return[];try{const t=JSON.parse(this.buffer);if(!Array.isArray(t))return[];const e=new Map,i=[];return t.forEach(s=>{const o=s.id,n=k.create(s);if(n){const r=crypto.randomUUID();n.id=r,n.x+=this.pasteOffset,n.y+=this.pasteOffset,e.set(o,r),i.push(n)}}),i.forEach(s=>{if(s instanceof w){if(s.sourcePortId){const[o,n]=this.parsePortId(s.sourcePortId);if(e.has(o)){const r=e.get(o);s.sourcePortId=n?`${r}:${n}`:r}}if(s.targetPortId){const[o,n]=this.parsePortId(s.targetPortId);if(e.has(o)){const r=e.get(o);s.targetPortId=n?`${r}:${n}`:r}}}}),this.pasteOffset+=20,this.pasteOffset>100&&(this.pasteOffset=20),i}catch(t){return console.error("Failed to paste from clipboard",t),[]}}static parsePortId(t){const e=t.split(":");return e.length>1?[e[0],e.slice(1).join(":")]:[t,null]}}l(z,"buffer",null),l(z,"pasteOffset",20);class gt{constructor(t,e,i,s,o,n,r){l(this,"element");l(this,"oldX");l(this,"oldY");l(this,"oldLength");l(this,"newX");l(this,"newY");l(this,"newLength");this.element=t,this.oldX=e,this.oldY=i,this.oldLength=s,this.newX=o,this.newY=n,this.newLength=r}execute(){this.update(this.newX,this.newY,this.newLength)}undo(){this.update(this.oldX,this.oldY,this.oldLength)}update(t,e,i){this.element.x=t,this.element.y=e,this.element.length=i,f.emit("element:modified",this.element),this.updateConnectedWires()}updateConnectedWires(){const t=y.getAllElements().filter(o=>o instanceof w),e=o=>o&&o.startsWith(`${this.element.id}:`),i=this.element.getPorts(),s=new Map(i.map(o=>[o.id,o]));t.forEach(o=>{let n=!1;if(e(o.sourcePortId)){const r=s.get(o.sourcePortId);if(r){o.x=r.x,o.y=r.y;let d=r.direction;if(d||(d=this.element.getPreferredPortDirection(r.id,{x:o.x2,y:o.y2})),o.sourceDirection=d||null,n=!0,o.targetPortId){const a=o.targetPortId.split(":")[0],g=y.getElement(a);if(g&&g instanceof v){const h=g.getPreferredPortDirection(o.targetPortId,{x:o.x,y:o.y});h&&(o.targetDirection=h,n=!0)}}}}if(e(o.targetPortId)){const r=s.get(o.targetPortId);if(r){let d=r.direction;if(d||(d=this.element.getPreferredPortDirection(r.id,{x:o.x,y:o.y})),o.setEnd(r.x,r.y,d),n=!0,o.sourcePortId){const a=o.sourcePortId.split(":")[0],g=y.getElement(a);if(g&&g instanceof v){const h=g.getPreferredPortDirection(o.sourcePortId,{x:o.x2,y:o.y2});h&&(o.sourceDirection=h,n=!0)}}}}n&&f.emit("element:modified",o)})}}class mt{constructor(t,e,i,s,o){l(this,"name","select");l(this,"isPanning",!1);l(this,"panStartX",0);l(this,"panStartY",0);l(this,"selectedElements",[]);l(this,"isDragging",!1);l(this,"dragStartX",0);l(this,"dragStartY",0);l(this,"elementStartPositions",new Map);l(this,"svg");l(this,"interactionGroup");l(this,"highlightGroup");l(this,"view");l(this,"updateFn");l(this,"projectRenderer");l(this,"isSelecting",!1);l(this,"selectionStartX",0);l(this,"selectionStartY",0);l(this,"selectionBox");l(this,"resizeHandles",[]);l(this,"activeHandle",null);l(this,"initialLength",0);l(this,"initialX",0);l(this,"initialY",0);l(this,"onElementModified",t=>{this.selectedElements.some(e=>e.id===t.id)&&this.updateHighlights()});l(this,"onKeyDown",t=>{var i;const e=(i=document.activeElement)==null?void 0:i.tagName.toLowerCase();if(!(e==="input"||e==="textarea")&&((t.key==="Delete"||t.key==="Backspace")&&this.deleteSelection(),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="c"&&(t.preventDefault(),z.copy(this.selectedElements)),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="v")){t.preventDefault();const s=z.paste();if(s.length>0){const o=new ut(s);P.execute(o),this.selectedElements=s,this.updateHighlights(),f.emit("selection:changed",this.selectedElements)}}});this.svg=t,this.interactionGroup=e,this.view=i,this.updateFn=s,this.projectRenderer=o,this.highlightGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.interactionGroup.appendChild(this.highlightGroup),this.selectionBox=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.selectionBox.setAttribute("fill","rgba(0, 120, 215, 0.1)"),this.selectionBox.setAttribute("stroke","rgba(0, 120, 215, 0.5)"),this.selectionBox.setAttribute("stroke-width","1"),this.selectionBox.setAttribute("display","none"),this.interactionGroup.appendChild(this.selectionBox);for(let n=0;n<2;n++){const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("width","10"),r.setAttribute("height","10"),r.setAttribute("fill","white"),r.setAttribute("stroke","#0078d7"),r.setAttribute("stroke-width","1"),r.setAttribute("display","none"),r.style.cursor="ew-resize",r.style.pointerEvents="all",this.interactionGroup.appendChild(r),this.resizeHandles.push(r)}}activate(){this.svg.style.cursor="default",window.addEventListener("keydown",this.onKeyDown),f.on("element:modified",this.onElementModified)}deactivate(){this.isPanning=!1,this.isDragging=!1,this.isSelecting=!1,this.clearSelection(),window.removeEventListener("keydown",this.onKeyDown),f.off("element:modified",this.onElementModified)}deleteSelection(){if(this.selectedElements.length===0)return;[...this.selectedElements].forEach(e=>{const i=[];e instanceof w||y.getAllElements().filter(n=>n instanceof w).forEach(n=>{e.getPorts().some(r=>n.sourcePortId===r.id||n.targetPortId===r.id)&&i.push(n)});const s=new dt(e,i);P.execute(s)}),this.selectedElements=[],this.updateHighlights(),f.emit("selection:changed",[]),console.log("Deleted elements")}clearSelection(){this.selectedElements=[],this.updateHighlights(),f.emit("selection:changed",[])}updateHighlights(){if(this.highlightGroup.innerHTML="",this.resizeHandles.forEach(t=>t.setAttribute("display","none")),this.selectedElements.forEach(t=>{const e=this.projectRenderer.getView(t.id);if(!e)return;const i=e.getBBox(),s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x",`${i.x-5}`),s.setAttribute("y",`${i.y-5}`),s.setAttribute("width",`${i.width+10}`),s.setAttribute("height",`${i.height+10}`),s.setAttribute("fill","rgba(0, 120, 215, 0.1)"),s.setAttribute("stroke","#0078d7"),s.setAttribute("stroke-width","2"),s.setAttribute("stroke-dasharray","4"),s.style.pointerEvents="none",s.setAttribute("transform",`translate(${t.x}, ${t.y}) rotate(${t.rotation})`),this.highlightGroup.appendChild(s)}),this.selectedElements.length===1&&this.selectedElements[0]instanceof v){const e=this.selectedElements[0].getPorts(),i=e.find(o=>o.id.endsWith(":left")),s=e.find(o=>o.id.endsWith(":right"));if(i&&s){const o=10/this.view.scale,n=o/2,r=(d,a,g)=>{d.setAttribute("width",`${o}`),d.setAttribute("height",`${o}`),d.setAttribute("x",`${a-n}`),d.setAttribute("y",`${g-n}`),d.setAttribute("display","block")};r(this.resizeHandles[0],i.x,i.y),r(this.resizeHandles[1],s.x,s.y)}}}findElementFromTarget(t){if(!(t instanceof Element))return null;let e=t;for(;e&&e!==this.svg;){if(e.tagName==="g"&&e.hasAttribute("id")){const i=e.getAttribute("id");if(i)return y.getElement(i)||null}e=e.parentElement}return null}getWorldPosition(t){const e=this.svg.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top;return{x:(i-this.view.x)/this.view.scale,y:(s-this.view.y)/this.view.scale}}onMouseDown(t){if(t.button===1){this.startPan(t);return}if(t.button===0){if(this.resizeHandles.includes(t.target)){const i=this.resizeHandles.indexOf(t.target);if(this.activeHandle=i===0?"left":"right",this.selectedElements.length===1&&this.selectedElements[0]instanceof v){const s=this.selectedElements[0];this.initialLength=s.length,this.initialX=s.x,this.initialY=s.y}return}const e=this.findElementFromTarget(t.target);if(e){t.shiftKey?(this.selectedElements.includes(e)?this.selectedElements=this.selectedElements.filter(s=>s!==e):this.selectedElements.push(e),this.updateHighlights(),f.emit("selection:changed",this.selectedElements)):this.selectedElements.includes(e)||(this.selectedElements=[e],this.updateHighlights(),f.emit("selection:changed",this.selectedElements)),this.isDragging=!0;const i=this.getWorldPosition(t);this.dragStartX=i.x,this.dragStartY=i.y,this.elementStartPositions.clear(),this.selectedElements.forEach(s=>{this.elementStartPositions.set(s.id,{x:s.x,y:s.y})})}else{t.shiftKey||this.clearSelection(),this.isSelecting=!0;const i=this.getWorldPosition(t);this.selectionStartX=i.x,this.selectionStartY=i.y,this.selectionBox.setAttribute("x",`${i.x}`),this.selectionBox.setAttribute("y",`${i.y}`),this.selectionBox.setAttribute("width","0"),this.selectionBox.setAttribute("height","0"),this.selectionBox.setAttribute("display","block")}}}startPan(t){this.isPanning=!0,this.panStartX=t.clientX,this.panStartY=t.clientY,this.svg.style.cursor="grabbing"}onMouseMove(t){if(this.isPanning){const e=t.clientX-this.panStartX,i=t.clientY-this.panStartY;this.view.x+=e,this.view.y+=i,this.panStartX=t.clientX,this.panStartY=t.clientY,this.updateFn();return}if(this.activeHandle){const e=this.getWorldPosition(t);if(this.selectedElements.length===1&&this.selectedElements[0]instanceof v){const i=this.selectedElements[0],s=i.length,o=i.rotation*Math.PI/180,n=Math.cos(o),r=Math.sin(o),d=s/2;let a=s,g=i.x,h=i.y;if(this.activeHandle==="right"){const m=i.x-d*n,E=i.y-d*r,u=e.x-m,x=e.y-E,p=u*n+x*r,A=Math.max(20,Math.round(p/20)*20);A!==s&&(a=A,g=m+a/2*n,h=E+a/2*r)}else{const m=i.x+d*n,E=i.y+d*r,u=m-e.x,x=E-e.y,p=u*n+x*r,A=Math.max(20,Math.round(p/20)*20);A!==s&&(a=A,g=m-a/2*n,h=E-a/2*r)}(a!==i.length||g!==i.x||h!==i.y)&&(i.length=a,i.x=g,i.y=h,f.emit("element:modified",i),this.updateConnectedWires(i),this.updateHighlights())}return}if(this.isSelecting){const e=this.getWorldPosition(t),i=Math.min(this.selectionStartX,e.x),s=Math.min(this.selectionStartY,e.y),o=Math.abs(e.x-this.selectionStartX),n=Math.abs(e.y-this.selectionStartY);this.selectionBox.setAttribute("x",`${i}`),this.selectionBox.setAttribute("y",`${s}`),this.selectionBox.setAttribute("width",`${o}`),this.selectionBox.setAttribute("height",`${n}`);return}if(this.isDragging&&this.selectedElements.length>0){const e=this.getWorldPosition(t),i=e.x-this.dragStartX,s=e.y-this.dragStartY;this.selectedElements.forEach(o=>{if(o instanceof w)return;const n=this.elementStartPositions.get(o.id);if(!n)return;let r=n.x+i,d=n.y+s;r=Math.round(r/20)*20,d=Math.round(d/20)*20,(r!==o.x||d!==o.y)&&(o.x=r,o.y=d,this.projectRenderer.updateViewTransform(o.id,`translate(${o.x}, ${o.y}) rotate(${o.rotation})`),f.emit("element:modified",o),this.updateConnectedWires(o),this.updateHighlights())})}}updateConnectedWires(t){const e=y.getAllElements().filter(r=>r instanceof w),i=r=>r&&r.startsWith(`${t.id}:`),s=t.getPorts(),o=new Map(s.map(r=>[r.id,r])),n=t instanceof v;e.forEach(r=>{let d=!1;if(i(r.sourcePortId)){const a=o.get(r.sourcePortId);if(a){r.x=a.x,r.y=a.y;let g=a.direction;if(!g&&n&&(g=t.getPreferredPortDirection(a.id,{x:r.x2,y:r.y2})),r.sourceDirection=g||null,d=!0,r.targetPortId){const h=r.targetPortId.split(":")[0],m=y.getElement(h);if(m&&m instanceof v){const E=m.getPreferredPortDirection(r.targetPortId,{x:r.x,y:r.y});E&&(r.targetDirection=E,d=!0)}}}}if(i(r.targetPortId)){const a=o.get(r.targetPortId);if(a){let g=a.direction;if(!g&&n&&(g=t.getPreferredPortDirection(a.id,{x:r.x,y:r.y})),r.setEnd(a.x,a.y,g),d=!0,r.sourcePortId){const h=r.sourcePortId.split(":")[0],m=y.getElement(h);if(m&&m instanceof v){const E=m.getPreferredPortDirection(r.sourcePortId,{x:r.x2,y:r.y2});E&&(r.sourceDirection=E,d=!0)}}}}d&&f.emit("element:modified",r)})}onMouseUp(t){if(this.activeHandle){if(this.activeHandle=null,this.svg.style.cursor="default",this.selectedElements.length===1&&this.selectedElements[0]instanceof v){const e=this.selectedElements[0];if(e.length!==this.initialLength||e.x!==this.initialX||e.y!==this.initialY){const i=new gt(e,this.initialX,this.initialY,this.initialLength,e.x,e.y,e.length);P.execute(i),console.log("Resize recorded")}}this.updateHighlights();return}if(this.isSelecting){this.isSelecting=!1,this.selectionBox.setAttribute("display","none");const e=parseFloat(this.selectionBox.getAttribute("x")||"0"),i=parseFloat(this.selectionBox.getAttribute("y")||"0"),s=parseFloat(this.selectionBox.getAttribute("width")||"0"),o=parseFloat(this.selectionBox.getAttribute("height")||"0"),n=y.getAllElements().filter(r=>{if(r instanceof w){const d=(r.x+r.x2)/2,a=(r.y+r.y2)/2;return d>=e&&d<=e+s&&a>=i&&a<=i+o}return r.x>=e&&r.x<=e+s&&r.y>=i&&r.y<=i+o});t.shiftKey?n.forEach(r=>{this.selectedElements.includes(r)||this.selectedElements.push(r)}):this.selectedElements=n,this.updateHighlights(),f.emit("selection:changed",this.selectedElements)}if(this.isDragging){this.isDragging=!1;let e=!1;this.selectedElements.forEach(i=>{const s=this.elementStartPositions.get(i.id);s&&(i.x!==s.x||i.y!==s.y)&&(e=!0)}),e&&this.selectedElements.forEach(i=>{const s=this.elementStartPositions.get(i.id);if(s&&(i.x!==s.x||i.y!==s.y)){const o=new ht(i,s.x,s.y,i.x,i.y);P.execute(o)}})}this.isPanning=!1,this.svg.style.cursor="default"}}class et{constructor(t){l(this,"element");this.element=t}execute(){y.addElement(this.element)}undo(){y.removeElement(this.element.id)}}class ft{constructor(){l(this,"rules",[])}addRule(t){this.rules.push(t)}validate(t,e,i){for(const s of this.rules){const o=s.validate(t,e,i);if(!o.isValid)return o}return{isValid:!0}}}const Y=new ft,j="http://www.w3.org/2000/svg";function it(c){const t=document.createElementNS(j,"g"),e=20,i=[];i.push({x:0,y:0});let s={x:0,y:0};if(c.sourceDirection){const p=c.sourceDirection==="left"?-e:c.sourceDirection==="right"?e:0,A=c.sourceDirection==="top"?-e:c.sourceDirection==="bottom"?e:0;s={x:s.x+p,y:s.y+A},i.push(s)}const o={x:c.x2-c.x,y:c.y2-c.y};let n={...o};if(c.targetDirection){const p=c.targetDirection==="left"?-e:c.targetDirection==="right"?e:0,A=c.targetDirection==="top"?-e:c.targetDirection==="bottom"?e:0;n={x:n.x+p,y:n.y+A}}const r=p=>p==="left"||p==="right",d=c.sourceDirection?r(c.sourceDirection):!1;let a=!0;c.sourceDirection?a=!d:c.targetDirection&&(r(c.targetDirection)?a=!0:a=!1);const g=40,h=40,m=20;if(a){let p=n.y;(s.y>0&&n.y<0||s.y<0&&n.y>0)&&(p=s.y+(s.y>0?m:-m));const V=c.targetDirection==="top"||c.targetDirection==="bottom";let C=!1;if(V&&(c.targetDirection==="top"&&p>n.y&&(C=!0),c.targetDirection==="bottom"&&p<n.y&&(C=!0)),C){i.push({x:s.x,y:p});const O=Math.abs(s.x-n.x)<g;let D=s.x;O?D=Math.max(s.x,n.x)+h:D=(s.x+n.x)/2,i.push({x:D,y:p});const W=n.y+(c.targetDirection==="top"?-m:m);i.push({x:D,y:W}),i.push({x:n.x,y:W}),i.push({x:n.x,y:n.y})}else i.push({x:s.x,y:p}),i.push({x:n.x,y:p}),i.push({x:n.x,y:n.y})}else{let p=n.x;(s.x>0&&n.x<0||s.x<0&&n.x>0)&&(p=s.x+(s.x>0?m:-m));const V=c.targetDirection==="left"||c.targetDirection==="right";let C=!1;if(V&&(c.targetDirection==="left"&&p>n.x&&(C=!0),c.targetDirection==="right"&&p<n.x&&(C=!0)),C){i.push({x:p,y:s.y});const O=Math.abs(s.y-n.y)<g;let D=s.y;O?D=Math.max(s.y,n.y)+h:D=(s.y+n.y)/2,i.push({x:p,y:D});const W=n.x+(c.targetDirection==="left"?-m:m);i.push({x:W,y:D}),i.push({x:W,y:n.y}),i.push({x:n.x,y:n.y})}else i.push({x:p,y:s.y}),i.push({x:p,y:n.y}),i.push({x:n.x,y:n.y})}i.push(o);const E=i.map((p,A)=>`${A===0?"M":"L"} ${p.x} ${p.y}`).join(" "),u=document.createElementNS(j,"path");u.setAttribute("d",E),u.setAttribute("stroke","black"),u.setAttribute("stroke-width","1.5"),u.setAttribute("fill","none"),u.setAttribute("stroke-linejoin","round");const x=document.createElementNS(j,"path");return x.setAttribute("d",E),x.setAttribute("stroke","white"),x.setAttribute("stroke-opacity","0"),x.setAttribute("stroke-width","10"),x.setAttribute("fill","none"),x.setAttribute("cursor","pointer"),t.appendChild(u),t.appendChild(x),t}const pt="http://www.w3.org/2000/svg";class yt{constructor(t,e,i){l(this,"name","wire");l(this,"svg");l(this,"sceneGroup");l(this,"getView");l(this,"isDrawing",!1);l(this,"activeWire",null);l(this,"activeView",null);l(this,"startPort",null);l(this,"highlightCircle");this.svg=t,this.sceneGroup=e,this.getView=i,this.highlightCircle=document.createElementNS(pt,"circle"),this.highlightCircle.setAttribute("r","5"),this.highlightCircle.setAttribute("fill","rgba(0, 255, 0, 0.5)"),this.highlightCircle.setAttribute("stroke","green"),this.highlightCircle.setAttribute("stroke-width","1"),this.highlightCircle.style.display="none",this.highlightCircle.style.pointerEvents="none"}activate(){this.svg.style.cursor="crosshair",this.svg.appendChild(this.highlightCircle)}deactivate(){this.isDrawing&&this.activeView&&(this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null,this.activeWire=null,this.isDrawing=!1),this.highlightCircle.parentElement&&this.highlightCircle.parentElement.removeChild(this.highlightCircle)}getWorldPosition(t){const e=this.getView(),i=this.svg.getBoundingClientRect(),s=t.clientX-i.left,o=t.clientY-i.top;return{x:(s-e.x)/e.scale,y:(o-e.y)/e.scale}}findNearestPort(t,e){let s=null,o=15;for(const n of y.getAllElements())if(!(n instanceof w))for(const r of n.getPorts()){const d=r.x-t,a=r.y-e,g=Math.sqrt(d*d+a*a);g<o&&(o=g,s=r)}return s}updateHighlight(t){t?(this.highlightCircle.style.display="block",this.highlightCircle.parentElement!==this.sceneGroup&&this.sceneGroup.appendChild(this.highlightCircle),this.highlightCircle.setAttribute("cx",`${t.x}`),this.highlightCircle.setAttribute("cy",`${t.y}`)):this.highlightCircle.style.display="none"}updateActiveView(){this.activeWire&&(this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=it(this.activeWire),this.activeView.setAttribute("transform",`translate(${this.activeWire.x}, ${this.activeWire.y}) rotate(${this.activeWire.rotation})`),this.activeView.style.pointerEvents="none",this.sceneGroup.appendChild(this.activeView))}onMouseDown(t){if(t.button!==0)return;const e=this.getWorldPosition(t),i=this.findNearestPort(e.x,e.y);i&&(this.isDrawing=!0,this.startPort=i,document.body.classList.add("no-select"),this.activeWire=new w({x:i.x,y:i.y,x2:i.x,y2:i.y,sourcePortId:i.id,sourceDirection:i.direction}),this.updateActiveView())}getBusPortDirection(t,e){const i=y.getElement(t.elementId);if(i&&i instanceof v)return i.getPreferredPortDirection(t.id,e)}onMouseMove(t){const e=this.getWorldPosition(t),i=this.findNearestPort(e.x,e.y);if(this.updateHighlight(i),this.isDrawing&&this.activeWire){let s=e.x,o=e.y,n;if(this.startPort&&!this.startPort.direction){const r=this.getBusPortDirection(this.startPort,{x:s,y:o});r&&(this.activeWire.sourceDirection=r)}i&&(s=i.x,o=i.y,n=i.direction,n||(n=this.getBusPortDirection(i,{x:this.activeWire.x,y:this.activeWire.y}))),this.activeWire.setEnd(s,o,n),this.updateActiveView()}}onMouseUp(t){if(!this.isDrawing)return;const e=this.getWorldPosition(t),i=this.findNearestPort(e.x,e.y);if(i&&this.activeWire&&this.startPort&&i.id!==this.startPort.id){const s=Y.validate(this.startPort,i,y);if(!s.isValid){console.warn(s.message),alert(s.message),this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null,this.activeWire=null,this.isDrawing=!1,this.startPort=null,document.body.classList.remove("no-select");return}this.activeWire.targetPortId=i.id;let o=i.direction;o||(o=this.getBusPortDirection(i,{x:this.activeWire.x,y:this.activeWire.y})),this.activeWire.setEnd(i.x,i.y,o),this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null;const n=new et(this.activeWire);P.execute(n),console.log(`Connected ${this.startPort.id} to ${i.id}`)}else this.activeView&&this.activeView.parentElement&&this.activeView.parentElement.removeChild(this.activeView),this.activeView=null;this.activeWire=null,this.isDrawing=!1,this.startPort=null,document.body.classList.remove("no-select")}}class U{constructor(t,e){l(this,"element");l(this,"oldRotation");l(this,"newRotation");this.element=t,this.oldRotation=t.rotation,this.newRotation=e}execute(){this.element.rotation=this.newRotation,f.emit("element:modified",this.element),this.updateConnectedWires()}undo(){this.element.rotation=this.oldRotation,f.emit("element:modified",this.element),this.updateConnectedWires()}updateConnectedWires(){const t=y.getAllElements().filter(n=>n instanceof w),e=n=>n&&n.startsWith(`${this.element.id}:`),i=this.element.getPorts(),s=new Map(i.map(n=>[n.id,n])),o=this.element instanceof v;t.forEach(n=>{let r=!1;if(e(n.sourcePortId)){const d=s.get(n.sourcePortId);if(d){n.x=d.x,n.y=d.y;let a=d.direction;if(!a&&o&&(a=this.element.getPreferredPortDirection(d.id,{x:n.x2,y:n.y2})),n.sourceDirection=a||null,r=!0,n.targetPortId){const g=n.targetPortId.split(":")[0],h=y.getElement(g);if(h&&h instanceof v){const m=h.getPreferredPortDirection(n.targetPortId,{x:n.x,y:n.y});m&&(n.targetDirection=m,r=!0)}}}}if(e(n.targetPortId)){const d=s.get(n.targetPortId);if(d){let a=d.direction;if(!a&&o&&(a=this.element.getPreferredPortDirection(d.id,{x:n.x,y:n.y})),n.setEnd(d.x,d.y,a),r=!0,n.sourcePortId){const g=n.sourcePortId.split(":")[0],h=y.getElement(g);if(h&&h instanceof v){const m=h.getPreferredPortDirection(n.sourcePortId,{x:n.x2,y:n.y2});m&&(n.sourceDirection=m,r=!0)}}}}r&&f.emit("element:modified",n)})}}class xt{constructor(t,e,i,s,o){l(this,"element");l(this,"oldName");l(this,"newName");l(this,"oldDesc");l(this,"newDesc");this.element=t,this.oldName=e,this.newName=i,this.oldDesc=s,this.newDesc=o}execute(){this.element.name=this.newName,this.element.description=this.newDesc,f.emit("element:modified",this.element)}undo(){this.element.name=this.oldName,this.element.description=this.oldDesc,f.emit("element:modified",this.element)}}class bt{constructor(t){l(this,"container");l(this,"items",[]);l(this,"elementMap",new Map);const e=document.getElementById(t);if(!e)throw new Error(`Toolbar container ${t} not found`);this.container=e,this.container.innerHTML=""}addItem(t){this.items.push(t)}addSeparator(){this.items.push({id:`sep-${Math.random()}`,label:"",type:"action",onClick:()=>{},group:"__separator__"})}render(){this.container.innerHTML="",this.elementMap.clear();let t=null;this.items.forEach((e,i)=>{if(e.group==="__separator__"){const n=document.createElement("div");n.className="separator",this.container.appendChild(n),t=null;return}t||(t=document.createElement("div"),t.className="toolbar-group",this.container.appendChild(t));const s=document.createElement("button");s.id=e.id,s.className="tool-btn",e.title?s.title=e.title:e.label&&(s.title=e.label),e.icon?(e.icon.includes("<svg")?s.innerHTML=e.icon:s.textContent=e.icon,s.classList.add("icon-btn")):(s.textContent=e.label,s.classList.add("text-btn")),e.draggable&&(s.draggable=!0,s.addEventListener("dragstart",n=>{n.dataTransfer&&(n.dataTransfer.setData("application/esld-tool",e.id),n.dataTransfer.effectAllowed="copy")})),s.addEventListener("click",()=>{e.onClick(),this.updateActiveState()}),this.elementMap.set(e.id,s),t.appendChild(s);const o=this.items[i+1];o&&o.group==="__separator__"&&(t=null)}),this.updateActiveState()}setActive(t){this.elementMap.forEach(i=>i.classList.remove("active"));const e=this.elementMap.get(t);e&&e.classList.add("active")}updateActiveState(){this.items.forEach(t=>{t.isActive&&t.isActive()&&this.setActive(t.id)})}}class Et{constructor(){l(this,"name","Single Connection Check")}validate(t,e,i){const s=i.getAllElements().filter(o=>o instanceof w);for(const o of s){if(o.sourcePortId===t.id)return{isValid:!1,message:"Source port is already connected."};if(o.targetPortId===t.id)return{isValid:!1,message:"Source port is already connected."};if(o.sourcePortId===e.id)return{isValid:!1,message:"Target port is already connected."};if(o.targetPortId===e.id)return{isValid:!1,message:"Target port is already connected."}}return{isValid:!0}}}class vt{constructor(){l(this,"name","Component Compatibility");l(this,"allowedConnections",{BusElement:["BreakerElement","GeneratorElement","LoadElement","TransformerElement","JunctionElement"],BreakerElement:["BusElement","JunctionElement","TransformerElement","GeneratorElement","LoadElement"],GeneratorElement:["BusElement","TransformerElement","BreakerElement"],LoadElement:["BusElement","BreakerElement","TransformerElement"],TransformerElement:["BusElement","BreakerElement","GeneratorElement","LoadElement","JunctionElement"],JunctionElement:["BusElement","BreakerElement","TransformerElement","GeneratorElement","LoadElement","JunctionElement"]})}validate(t,e,i){const s=i.getElement(t.elementId),o=i.getElement(e.elementId);if(!s||!o)return{isValid:!1,message:"Element not found."};const n=s.type,r=o.type,d=this.allowedConnections[r];if(d&&d.includes(n))return{isValid:!0};const a=this.allowedConnections[n];return a&&a.includes(r)?{isValid:!0}:{isValid:!1,message:`Cannot connect ${n} to ${r}.`}}}class wt{constructor(){l(this,"name","Self-Connection Check")}validate(t,e,i){return t.elementId===e.elementId?{isValid:!1,message:"Cannot connect a component to itself."}:{isValid:!0}}}class At{constructor(){l(this,"name","Topology Restrictions")}validate(t,e,i){const s=i.getElement(t.elementId),o=i.getElement(e.elementId);if(!s||!o)return{isValid:!1};const n=s.type,r=o.type;return n==="GeneratorElement"&&r==="GeneratorElement"?{isValid:!1,message:"Direct Generator-to-Generator connections are not allowed. Use a Bus or Synchronizer."}:n==="LoadElement"&&r==="LoadElement"?{isValid:!1,message:"Direct Load-to-Load connections are not allowed. Connect them to a common Bus."}:{isValid:!0}}}const X="http://www.w3.org/2000/svg";function Pt(c){const t=document.createElementNS(X,"g"),e=20,i=40,s=document.createElementNS(X,"rect");s.setAttribute("x",`${-i/2}`),s.setAttribute("y",`${-i/2}`),s.setAttribute("width",`${i}`),s.setAttribute("height",`${i}`),s.setAttribute("fill","white"),s.setAttribute("fill-opacity","0"),s.setAttribute("cursor","pointer"),t.appendChild(s);const o=document.createElementNS(X,"rect");o.setAttribute("x",`${-e/2}`),o.setAttribute("y",`${-e/2}`),o.setAttribute("width",`${e}`),o.setAttribute("height",`${e}`),o.setAttribute("fill","white"),o.setAttribute("stroke","black"),o.setAttribute("stroke-width","2");const n=document.createElementNS(X,"text");return n.setAttribute("x","0"),n.setAttribute("y",`${e/2+15}`),n.setAttribute("text-anchor","middle"),n.setAttribute("font-size","12"),n.setAttribute("fill","#666"),n.textContent=c.name,t.appendChild(o),t.appendChild(n),t}const R="http://www.w3.org/2000/svg";function St(c){const t=document.createElementNS(R,"g"),e=document.createElementNS(R,"line");e.setAttribute("x1",`${-c.length/2}`),e.setAttribute("y1","0"),e.setAttribute("x2",`${c.length/2}`),e.setAttribute("y2","0"),e.setAttribute("stroke","black"),e.setAttribute("stroke-width","4"),e.setAttribute("stroke-linecap","square");const i=document.createElementNS(R,"line");i.setAttribute("x1",`${-c.length/2}`),i.setAttribute("y1","0"),i.setAttribute("x2",`${c.length/2}`),i.setAttribute("y2","0"),i.setAttribute("stroke","white"),i.setAttribute("stroke-opacity","0"),i.setAttribute("stroke-width","10"),i.setAttribute("cursor","pointer");const s=document.createElementNS(R,"text");return s.setAttribute("x","0"),s.setAttribute("y","-10"),s.setAttribute("text-anchor","middle"),s.setAttribute("font-size","12"),s.setAttribute("fill","#666"),s.textContent=c.name,t.appendChild(e),t.appendChild(i),t.appendChild(s),t}const G="http://www.w3.org/2000/svg";function Ct(c){const t=document.createElementNS(G,"g"),e=20,i=document.createElementNS(G,"rect"),s=e*2+10;i.setAttribute("x",`${-s/2}`),i.setAttribute("y",`${-s/2}`),i.setAttribute("width",`${s}`),i.setAttribute("height",`${s}`),i.setAttribute("fill","white"),i.setAttribute("fill-opacity","0"),i.setAttribute("cursor","pointer"),t.appendChild(i);const o=document.createElementNS(G,"circle");o.setAttribute("cx","0"),o.setAttribute("cy","0"),o.setAttribute("r",`${e}`),o.setAttribute("fill","white"),o.setAttribute("stroke","black"),o.setAttribute("stroke-width","2");const n=document.createElementNS(G,"text");n.setAttribute("x","0"),n.setAttribute("y","5"),n.setAttribute("text-anchor","middle"),n.setAttribute("font-size","20"),n.setAttribute("font-weight","bold"),n.setAttribute("fill","black"),n.textContent="G";const r=document.createElementNS(G,"text");return r.setAttribute("x","0"),r.setAttribute("y",`${e+15}`),r.setAttribute("text-anchor","middle"),r.setAttribute("font-size","12"),r.setAttribute("fill","#666"),r.textContent=c.name,t.appendChild(o),t.appendChild(n),t.appendChild(r),t}const _="http://www.w3.org/2000/svg";function Dt(c){const t=document.createElementNS(_,"g"),e=4,i=document.createElementNS(_,"circle");i.setAttribute("cx","0"),i.setAttribute("cy","0"),i.setAttribute("r",`${e}`),i.setAttribute("fill","black");const s=document.createElementNS(_,"circle");return s.setAttribute("cx","0"),s.setAttribute("cy","0"),s.setAttribute("r","10"),s.setAttribute("fill","white"),s.setAttribute("fill-opacity","0"),s.setAttribute("cursor","pointer"),t.appendChild(i),t.appendChild(s),t}const H="http://www.w3.org/2000/svg";function $t(c){const t=document.createElementNS(H,"g"),e=30,i=e/2,s=document.createElementNS(H,"rect"),o=e+10;s.setAttribute("x",`${-o/2}`),s.setAttribute("y",`${-o/2}`),s.setAttribute("width",`${o}`),s.setAttribute("height",`${o}`),s.setAttribute("fill","white"),s.setAttribute("fill-opacity","0"),s.setAttribute("cursor","pointer"),t.appendChild(s);const n=document.createElementNS(H,"line");n.setAttribute("x1","0"),n.setAttribute("y1",`${-i}`),n.setAttribute("x2","0"),n.setAttribute("y2",`${i}`),n.setAttribute("stroke","black"),n.setAttribute("stroke-width","2");const r=document.createElementNS(H,"polygon"),d=10,a=10,g=`${-d/2},${i-a} ${d/2},${i-a} 0,${i}`;r.setAttribute("points",g),r.setAttribute("fill","black");const h=document.createElementNS(H,"text");return h.setAttribute("x","0"),h.setAttribute("y",`${i+15}`),h.setAttribute("text-anchor","middle"),h.setAttribute("font-size","12"),h.setAttribute("fill","#666"),h.textContent=c.name,t.appendChild(n),t.appendChild(r),t.appendChild(h),t}const B="http://www.w3.org/2000/svg";function It(c){const t=document.createElementNS(B,"g"),e=15,i=document.createElementNS(B,"rect"),s=e*2*2+10,o=e*2+10;i.setAttribute("x",`${-o/2}`),i.setAttribute("y",`${-s/2}`),i.setAttribute("width",`${o}`),i.setAttribute("height",`${s}`),i.setAttribute("fill","white"),i.setAttribute("fill-opacity","0"),i.setAttribute("cursor","pointer"),t.appendChild(i);const n=document.createElementNS(B,"line");n.setAttribute("x1","0"),n.setAttribute("y1",`${-e*2}`),n.setAttribute("x2","0"),n.setAttribute("y2",`${-e/1.5-e}`),n.setAttribute("stroke","black"),n.setAttribute("stroke-width","2");const r=document.createElementNS(B,"line");r.setAttribute("x1","0"),r.setAttribute("y1",`${e*2}`),r.setAttribute("x2","0"),r.setAttribute("y2",`${e/1.5+e}`),r.setAttribute("stroke","black"),r.setAttribute("stroke-width","2");const d=document.createElementNS(B,"circle");d.setAttribute("cx","0"),d.setAttribute("cy",`${-e/1.5}`),d.setAttribute("r",`${e}`),d.setAttribute("fill","none"),d.setAttribute("stroke","black"),d.setAttribute("stroke-width","2");const a=document.createElementNS(B,"circle");a.setAttribute("cx","0"),a.setAttribute("cy",`${e/1.5}`),a.setAttribute("r",`${e}`),a.setAttribute("fill","none"),a.setAttribute("stroke","black"),a.setAttribute("stroke-width","2");const g=document.createElementNS(B,"text");return g.setAttribute("x","0"),g.setAttribute("y",`${e*2+15}`),g.setAttribute("text-anchor","middle"),g.setAttribute("font-size","12"),g.setAttribute("fill","#666"),g.textContent=c.name,t.appendChild(n),t.appendChild(r),t.appendChild(d),t.appendChild(a),t.appendChild(g),t}function J(c){return c instanceof K?Pt:c instanceof v?St:c instanceof Q?Ct:c instanceof tt?Dt:c instanceof Z?$t:c instanceof q?It:c instanceof w?it:null}class kt{constructor(t){l(this,"sceneGroup");l(this,"elementViews",new Map);this.sceneGroup=t,this.bindEvents()}bindEvents(){f.on("element:added",t=>{this.renderElement(t)}),f.on("element:removed",t=>{this.removeElement(t)}),f.on("element:modified",t=>{this.updateElement(t)}),f.on("project:cleared",()=>{this.clearScene()})}renderElement(t){const e=J(t);if(!e)return;const i=e(t);i.setAttribute("id",t.id),this.applyTransform(i,t),this.sceneGroup.appendChild(i),this.elementViews.set(t.id,i)}updateElement(t){let e=this.elementViews.get(t.id);if(!e){this.renderElement(t);return}const i=J(t);if(!i)return;const s=i(t);s.setAttribute("id",t.id),this.applyTransform(s,t),this.sceneGroup.replaceChild(s,e),this.elementViews.set(t.id,s)}applyTransform(t,e){t.setAttribute("transform",`translate(${e.x}, ${e.y}) rotate(${e.rotation})`)}removeElement(t){const e=this.elementViews.get(t.id);e&&e.parentElement&&e.parentElement.removeChild(e),this.elementViews.delete(t.id)}clearScene(){for(;this.sceneGroup.firstChild;)this.sceneGroup.removeChild(this.sceneGroup.firstChild);this.elementViews.clear()}getView(t){return this.elementViews.get(t)}updateViewTransform(t,e){const i=this.elementViews.get(t);i&&i.setAttribute("transform",e)}}Y.addRule(new Et);Y.addRule(new vt);Y.addRule(new wt);Y.addRule(new At);const S=document.getElementById("main-svg"),N="http://www.w3.org/2000/svg";let b={x:0,y:0,scale:1},M,T,I,$;const F={"btn-bus":(c,t)=>k.create({type:"BusElement",x:c,y:t,length:100}),"btn-breaker":(c,t)=>k.create({type:"BreakerElement",x:c,y:t}),"btn-transformer":(c,t)=>k.create({type:"TransformerElement",x:c,y:t}),"btn-gen":(c,t)=>k.create({type:"GeneratorElement",x:c,y:t}),"btn-load-elem":(c,t)=>k.create({type:"LoadElement",x:c,y:t}),"btn-junction":(c,t)=>k.create({type:"JunctionElement",x:c,y:t})};function Mt(c,t){const e=S.getBoundingClientRect(),i=c-e.left,s=t-e.top,o=(i-b.x)/b.scale,n=(s-b.y)/b.scale;return{x:Math.round(o/20)*20,y:Math.round(n/20)*20}}function Bt(){var m,E;if(!S)return;const c=document.createElementNS(N,"defs");I=document.createElementNS(N,"pattern"),I.setAttribute("id","grid-pattern"),I.setAttribute("width","20"),I.setAttribute("height","20"),I.setAttribute("patternUnits","userSpaceOnUse");const t=document.createElementNS(N,"path");t.setAttribute("d","M 20 0 L 0 0 0 20"),t.setAttribute("fill","none"),t.setAttribute("stroke","#e0e0e0"),t.setAttribute("stroke-width","1"),I.appendChild(t),c.appendChild(I),S.appendChild(c);const e=document.createElementNS(N,"rect");e.setAttribute("width","100%"),e.setAttribute("height","100%"),e.setAttribute("fill","url(#grid-pattern)"),e.style.cursor="grab",S.appendChild(e),M=document.createElementNS(N,"g"),M.setAttribute("id","scene-layer"),S.appendChild(M),T=document.createElementNS(N,"g"),T.setAttribute("id","interaction-layer"),T.style.pointerEvents="none",S.appendChild(T);const i=new kt(M);$=new rt;const s=()=>b,o=document.getElementById("prop-form"),n=document.querySelector(".empty-state"),r=document.getElementById("prop-name"),d=document.getElementById("prop-desc");let a=null;const g=()=>{if(!a||a.name===r.value&&a.description===d.value)return;const u=new xt(a,a.name,r.value,a.description,d.value);P.execute(u)};r==null||r.addEventListener("change",g),d==null||d.addEventListener("change",g),(m=document.getElementById("btn-rotate-cw"))==null||m.addEventListener("click",()=>{if(!a||a instanceof w)return;const u=(a.rotation+90)%360,x=new U(a,u);P.execute(x)}),(E=document.getElementById("btn-rotate-ccw"))==null||E.addEventListener("click",()=>{if(!a||a instanceof w)return;let u=(a.rotation-90)%360;u<0&&(u+=360);const x=new U(a,u);P.execute(x)}),f.on("selection:changed",u=>{u.length>0?(a=u[0],o.style.display="block",n.style.display="none",r.value=a.name,d.value=a.description):(a=null,o.style.display="none",n.style.display="block")}),f.on("history:changed",()=>{a&&(r.value=a.name,d.value=a.description)}),$.registerTool(new mt(S,T,b,st,i)),$.registerTool(new yt(S,M,s)),S.addEventListener("mousedown",u=>$.onMouseDown(u)),window.addEventListener("mousemove",u=>$.onMouseMove(u)),window.addEventListener("mouseup",u=>$.onMouseUp(u)),S.addEventListener("wheel",Vt,{passive:!1}),S.addEventListener("dragover",u=>{u.preventDefault(),u.dataTransfer.dropEffect="copy"}),S.addEventListener("drop",u=>{u.preventDefault();const x=u.dataTransfer.getData("application/esld-tool");if(!x||!F[x])return;const{x:p,y:A}=Mt(u.clientX,u.clientY),V=F[x](p,A);if(V){const C=new et(V);P.execute(C)}}),window.addEventListener("keydown",u=>{var p;const x=(p=document.activeElement)==null?void 0:p.tagName.toLowerCase();x==="input"||x==="textarea"||((u.ctrlKey||u.metaKey)&&u.key.toLowerCase()==="z"?u.shiftKey?(u.preventDefault(),P.redo()):(u.preventDefault(),P.undo()):(u.ctrlKey||u.metaKey)&&u.key.toLowerCase()==="y"&&(u.preventDefault(),P.redo()))});const h=new bt("toolbar");h.addItem({id:"btn-select",label:"Select",title:"Select Tool",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z'/></svg>",onClick:()=>$.activateTool("select")}),h.addItem({id:"btn-wire",label:"Wire",title:"Wire Tool",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M4 4h16v2H4zm0 7h16v2H4zm0 7h16v2H4z'/></svg>",onClick:()=>$.activateTool("wire")}),h.addSeparator(),h.addItem({id:"btn-bus",label:"Bus",title:"Busbar Component (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='4' y='10' width='16' height='4' rx='1'/></svg>",draggable:!0,onClick:()=>{}}),h.addItem({id:"btn-breaker",label:"Brk",title:"Circuit Breaker (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='5' y='5' width='14' height='14'/></svg>",draggable:!0,onClick:()=>{}}),h.addItem({id:"btn-transformer",label:"Trafo",title:"Transformer Component (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><circle cx='12' cy='9' r='5'/><circle cx='12' cy='15' r='5'/><line x1='12' y1='4' x2='12' y2='9'/><line x1='12' y1='15' x2='12' y2='20'/></svg>",draggable:!0,onClick:()=>{}}),h.addItem({id:"btn-gen",label:"Gen",title:"Generator Component (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><circle cx='12' cy='12' r='9'/><text x='12' y='16' text-anchor='middle' font-size='12' font-weight='bold' style='fill:currentColor;stroke:none'>G</text></svg>",draggable:!0,onClick:()=>{}}),h.addItem({id:"btn-load-elem",label:"Load",title:"Load Component (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12 3v16m-5-5l5 5 5-5'/></svg>",draggable:!0,onClick:()=>{}}),h.addItem({id:"btn-junction",label:"Node",title:"Junction/Node (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><circle cx='12' cy='12' r='2'/><path d='M12 4v6m0 4v6m8-8h-6m-4 0H4'/></svg>",draggable:!0,onClick:()=>{}}),h.addSeparator(),h.addItem({id:"btn-save",label:"Save",title:"Save Project",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z'/></svg>",onClick:()=>{const u=y.save();localStorage.setItem("esld_project",u),alert("Project Saved to LocalStorage!")}}),h.addItem({id:"btn-load",label:"Load",title:"Load Project",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z'/></svg>",onClick:()=>{const u=localStorage.getItem("esld_project");u?y.load(u):alert("No saved project found!")}}),h.addItem({id:"btn-export",label:"Export",title:"Export as PNG",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z'/></svg>",onClick:Lt}),h.addSeparator(),h.addItem({id:"btn-undo",label:"Undo",title:"Undo Last Action",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z'/></svg>",onClick:()=>P.undo()}),h.addItem({id:"btn-redo",label:"Redo",title:"Redo Last Action",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z'/></svg>",onClick:()=>P.redo()}),h.render(),$.activateTool("select")}function Lt(){const c=M.getBBox(),t=50,e=c.width+t*2||800,i=c.height+t*2||600,s=c.x-t||0,o=c.y-t||0,n=M.cloneNode(!0);n.removeAttribute("transform");const r=`
    <svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${i}" viewBox="${s} ${o} ${e} ${i}">
        <style>
            text { font-family: sans-serif; }
        </style>
        <rect x="${s}" y="${o}" width="${e}" height="${i}" fill="white"/>
        ${n.outerHTML}
    </svg>`,d=new Blob([r],{type:"image/svg+xml;charset=utf-8"}),a=URL.createObjectURL(d),g=new Image;g.onload=()=>{const h=document.createElement("canvas");h.width=e,h.height=i;const m=h.getContext("2d");if(m){m.drawImage(g,0,0);const E=h.toDataURL("image/png"),u=document.createElement("a");u.href=E,u.download="diagram.png",document.body.appendChild(u),u.click(),document.body.removeChild(u)}URL.revokeObjectURL(a)},g.src=a}function st(){const c=`translate(${b.x}, ${b.y}) scale(${b.scale})`;M.setAttribute("transform",c),T.setAttribute("transform",c),I.setAttribute("patternTransform",`translate(${b.x%(20*b.scale)}, ${b.y%(20*b.scale)}) scale(${b.scale})`)}function Vt(c){c.preventDefault();const t=.1,e=c.deltaY<0?1:-1,i=Math.exp(e*t),s=S.getBoundingClientRect(),o=c.clientX-s.left,n=c.clientY-s.top,r=b.scale*i;r<.1||r>10||(b.x=o-(o-b.x)*i,b.y=n-(n-b.y)*i,b.scale=r,st())}Bt();
