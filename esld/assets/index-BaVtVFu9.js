var j=Object.defineProperty;var F=(l,t,e)=>t in l?j(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var c=(l,t,e)=>F(l,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class K{constructor(){c(this,"activeTool",null);c(this,"tools",new Map)}registerTool(t){this.tools.set(t.name,t)}activateTool(t){var s;const e=this.tools.get(t);if(!e){console.warn(`Tool ${t} not found`);return}this.activeTool&&this.activeTool.deactivate(),this.activeTool=e,this.activeTool.activate(),document.querySelectorAll(".tool-btn").forEach(i=>i.classList.remove("active")),(s=document.getElementById(`btn-${t}`))==null||s.classList.add("active"),console.log(`Switched to tool: ${t}`)}onMouseDown(t){var e;(e=this.activeTool)==null||e.onMouseDown(t)}onMouseMove(t){var e;(e=this.activeTool)==null||e.onMouseMove(t)}onMouseUp(t){var e;(e=this.activeTool)==null||e.onMouseUp(t)}}class J{constructor(){c(this,"listeners",{})}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}off(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(s=>s!==e))}emit(t,e){this.listeners[t]&&this.listeners[t].forEach(s=>s(e))}}const m=new J;class M{constructor(t){c(this,"id");c(this,"x");c(this,"y");c(this,"rotation");c(this,"name");c(this,"description");c(this,"group");this.id=t.id||crypto.randomUUID(),this.x=t.x,this.y=t.y,this.rotation=t.rotation||0,this.name=t.name||"Element",this.description=t.description||"";const e="http://www.w3.org/2000/svg";this.group=document.createElementNS(e,"g"),this.group.setAttribute("id",this.id),this.updateTransform()}updateTransform(){this.group.setAttribute("transform",`translate(${this.x}, ${this.y}) rotate(${this.rotation})`)}getTransformedPoint(t,e){const s=this.rotation*Math.PI/180,i=Math.cos(s),n=Math.sin(s),o=t*i-e*n,r=t*n+e*i;return{x:this.x+o,y:this.y+r}}getPortDirection(t){const e=["top","right","bottom","left"],s=e.indexOf(t);if(s===-1)return t;const i=Math.round(this.rotation/90)%4,n=(s+i)%4;return e[n]}mount(t){t.appendChild(this.group)}toJSON(){return{id:this.id,x:this.x,y:this.y,rotation:this.rotation,name:this.name,description:this.description,type:this.constructor.name}}}const G="http://www.w3.org/2000/svg";class T extends M{constructor(e){super(e);c(this,"length");this.length=e.length||100,this.render()}getPorts(){const e=[],s=this.length/2,i=20,n=(r,a,u)=>{const d=this.getTransformedPoint(a,0);e.push({id:`${this.id}:${r}`,elementId:this.id,x:d.x,y:d.y,direction:u?this.getPortDirection(u):void 0})};n("left",-s,"left"),n("center",0,"bottom"),n("right",s,"right");const o=Math.floor((s-1)/i);for(let r=1;r<=o;r++)n(`${r*i}`,r*i,"bottom"),n(`${-r*i}`,-r*i,"bottom");return e}render(){for(;this.group.firstChild;)this.group.removeChild(this.group.firstChild);const e=document.createElementNS(G,"line");e.setAttribute("x1",`${-this.length/2}`),e.setAttribute("y1","0"),e.setAttribute("x2",`${this.length/2}`),e.setAttribute("y2","0"),e.setAttribute("stroke","black"),e.setAttribute("stroke-width","4"),e.setAttribute("stroke-linecap","square");const s=document.createElementNS(G,"line");s.setAttribute("x1",`${-this.length/2}`),s.setAttribute("y1","0"),s.setAttribute("x2",`${this.length/2}`),s.setAttribute("y2","0"),s.setAttribute("stroke","transparent"),s.setAttribute("stroke-width","10"),s.setAttribute("cursor","pointer");const i=document.createElementNS(G,"text");i.setAttribute("x","0"),i.setAttribute("y","-10"),i.setAttribute("text-anchor","middle"),i.setAttribute("font-size","12"),i.setAttribute("fill","#666"),i.textContent=this.name,this.group.appendChild(e),this.group.appendChild(s),this.group.appendChild(i)}toJSON(){return{...super.toJSON(),length:this.length}}}const X="http://www.w3.org/2000/svg";class q extends M{constructor(t){super(t),this.render()}getPorts(){const e=this.getTransformedPoint(0,-10),s=this.getTransformedPoint(0,20/2);return[{id:`${this.id}:top`,elementId:this.id,x:e.x,y:e.y,direction:this.getPortDirection("top")},{id:`${this.id}:bottom`,elementId:this.id,x:s.x,y:s.y,direction:this.getPortDirection("bottom")}]}render(){for(;this.group.firstChild;)this.group.removeChild(this.group.firstChild);const t=20,e=document.createElementNS(X,"rect");e.setAttribute("x",`${-t/2}`),e.setAttribute("y",`${-t/2}`),e.setAttribute("width",`${t}`),e.setAttribute("height",`${t}`),e.setAttribute("fill","white"),e.setAttribute("stroke","black"),e.setAttribute("stroke-width","2");const s=document.createElementNS(X,"text");s.setAttribute("x","0"),s.setAttribute("y",`${t/2+15}`),s.setAttribute("text-anchor","middle"),s.setAttribute("font-size","12"),s.setAttribute("fill","#666"),s.textContent=this.name,this.group.appendChild(e),this.group.appendChild(s)}}const z="http://www.w3.org/2000/svg";class E extends M{constructor(e){super(e);c(this,"x2");c(this,"y2");c(this,"points",[]);c(this,"sourcePortId",null);c(this,"targetPortId",null);c(this,"sourceDirection",null);c(this,"targetDirection",null);this.x2=e.x2,this.y2=e.y2,this.sourcePortId=e.sourcePortId||null,this.targetPortId=e.targetPortId||null,this.sourceDirection=e.sourceDirection||null,this.targetDirection=e.targetDirection||null,this.render()}setEnd(e,s,i){this.x2=e,this.y2=s,i?this.targetDirection=i:this.targetDirection=null,this.render()}getPorts(){return[]}render(){for(;this.group.firstChild;)this.group.removeChild(this.group.firstChild);const e=20,s=[];s.push({x:0,y:0});let i={x:0,y:0};if(this.sourceDirection){const y=this.sourceDirection==="left"?-e:this.sourceDirection==="right"?e:0,C=this.sourceDirection==="top"?-e:this.sourceDirection==="bottom"?e:0;i={x:i.x+y,y:i.y+C},s.push(i)}const n={x:this.x2-this.x,y:this.y2-this.y};let o={...n};if(this.targetDirection){const y=this.targetDirection==="left"?-e:this.targetDirection==="right"?e:0,C=this.targetDirection==="top"?-e:this.targetDirection==="bottom"?e:0;o={x:o.x+y,y:o.y+C}}const r=y=>y==="left"||y==="right",a=this.sourceDirection?r(this.sourceDirection):!1;let u=!0;this.sourceDirection?u=!a:this.targetDirection&&(r(this.targetDirection)?u=!0:u=!1);const d=40,f=40,w=20;if(u){const y=i.y>0&&o.y<0||i.y<0&&o.y>0,C=Math.abs(i.x-o.x)<d;if(y&&C){const b=i.y+(i.y>0?w:-w);s.push({x:i.x,y:b});const N=i.x+f;s.push({x:N,y:b}),s.push({x:N,y:o.y}),s.push({x:o.x,y:o.y})}else{let b=o.y;y&&(b=i.y+(i.y>0?w:-w)),s.push({x:i.x,y:b}),s.push({x:o.x,y:b}),s.push({x:o.x,y:o.y})}}else{const y=i.x>0&&o.x<0||i.x<0&&o.x>0,C=Math.abs(i.y-o.y)<d;if(y&&C){const b=i.x+(i.x>0?w:-w);s.push({x:b,y:i.y});const N=i.y+f;s.push({x:b,y:N}),s.push({x:o.x,y:N}),s.push({x:o.x,y:o.y})}else{let b=o.x;y&&(b=i.x+(i.x>0?w:-w)),s.push({x:b,y:i.y}),s.push({x:b,y:o.y}),s.push({x:o.x,y:o.y})}}s.push(n);const h=s.map((y,C)=>`${C===0?"M":"L"} ${y.x} ${y.y}`).join(" "),g=document.createElementNS(z,"path");g.setAttribute("d",h),g.setAttribute("stroke","black"),g.setAttribute("stroke-width","1.5"),g.setAttribute("fill","none"),g.setAttribute("stroke-linejoin","round");const S=document.createElementNS(z,"path");S.setAttribute("d",h),S.setAttribute("stroke","transparent"),S.setAttribute("stroke-width","10"),S.setAttribute("fill","none"),S.setAttribute("cursor","pointer"),this.group.appendChild(g),this.group.appendChild(S)}toJSON(){return{...super.toJSON(),x2:this.x2,y2:this.y2,sourcePortId:this.sourcePortId,targetPortId:this.targetPortId,sourceDirection:this.sourceDirection,targetDirection:this.targetDirection}}}const W="http://www.w3.org/2000/svg";class Q extends M{constructor(t){super(t),this.render()}getPorts(){const e=this.getTransformedPoint(0,-30),s=this.getTransformedPoint(0,15*2);return[{id:`${this.id}:top`,elementId:this.id,x:e.x,y:e.y,direction:this.getPortDirection("top")},{id:`${this.id}:bottom`,elementId:this.id,x:s.x,y:s.y,direction:this.getPortDirection("bottom")}]}render(){for(;this.group.firstChild;)this.group.removeChild(this.group.firstChild);const t=15,e=document.createElementNS(W,"circle");e.setAttribute("cx","0"),e.setAttribute("cy",`${-t/1.5}`),e.setAttribute("r",`${t}`),e.setAttribute("fill","white"),e.setAttribute("stroke","black"),e.setAttribute("stroke-width","2");const s=document.createElementNS(W,"circle");s.setAttribute("cx","0"),s.setAttribute("cy",`${t/1.5}`),s.setAttribute("r",`${t}`),s.setAttribute("fill","none"),s.setAttribute("fill","white"),s.setAttribute("stroke","black"),s.setAttribute("stroke-width","2");const i=document.createElementNS(W,"text");i.setAttribute("x","0"),i.setAttribute("y",`${t*2+15}`),i.setAttribute("text-anchor","middle"),i.setAttribute("font-size","12"),i.setAttribute("fill","#666"),i.textContent=this.name,this.group.appendChild(e),this.group.appendChild(s),this.group.appendChild(i)}}const H="http://www.w3.org/2000/svg";class Z extends M{constructor(t){super(t),this.render()}getPorts(){const e=this.getTransformedPoint(0,20);return[{id:`${this.id}:bottom`,elementId:this.id,x:e.x,y:e.y,direction:this.getPortDirection("bottom")}]}render(){for(;this.group.firstChild;)this.group.removeChild(this.group.firstChild);const t=20,e=document.createElementNS(H,"circle");e.setAttribute("cx","0"),e.setAttribute("cy","0"),e.setAttribute("r",`${t}`),e.setAttribute("fill","white"),e.setAttribute("stroke","black"),e.setAttribute("stroke-width","2");const s=document.createElementNS(H,"text");s.setAttribute("x","0"),s.setAttribute("y","5"),s.setAttribute("text-anchor","middle"),s.setAttribute("font-size","20"),s.setAttribute("font-weight","bold"),s.setAttribute("fill","black"),s.textContent="G";const i=document.createElementNS(H,"text");i.setAttribute("x","0"),i.setAttribute("y",`${t+15}`),i.setAttribute("text-anchor","middle"),i.setAttribute("font-size","12"),i.setAttribute("fill","#666"),i.textContent=this.name,this.group.appendChild(e),this.group.appendChild(s),this.group.appendChild(i)}}const Y="http://www.w3.org/2000/svg";class tt extends M{constructor(t){super(t),this.render()}getPorts(){const t=this.getTransformedPoint(0,-15);return[{id:`${this.id}:top`,elementId:this.id,x:t.x,y:t.y,direction:this.getPortDirection("top")}]}render(){for(;this.group.firstChild;)this.group.removeChild(this.group.firstChild);const e=30/2,s=document.createElementNS(Y,"polygon"),i=`${-e},${-e} ${e},${-e} 0,${e}`;s.setAttribute("points",i),s.setAttribute("fill","white"),s.setAttribute("stroke","black"),s.setAttribute("stroke-width","2");const n=document.createElementNS(Y,"text");n.setAttribute("x","0"),n.setAttribute("y",`${e+15}`),n.setAttribute("text-anchor","middle"),n.setAttribute("font-size","12"),n.setAttribute("fill","#666"),n.textContent=this.name,this.group.appendChild(s),this.group.appendChild(n)}}const O="http://www.w3.org/2000/svg";class et extends M{constructor(t){super(t),this.render()}getPorts(){return[{id:`${this.id}:center`,elementId:this.id,x:this.x,y:this.y}]}render(){for(;this.group.firstChild;)this.group.removeChild(this.group.firstChild);const t=4,e=document.createElementNS(O,"circle");e.setAttribute("cx","0"),e.setAttribute("cy","0"),e.setAttribute("r",`${t}`),e.setAttribute("fill","black");const s=document.createElementNS(O,"circle");s.setAttribute("cx","0"),s.setAttribute("cy","0"),s.setAttribute("r","10"),s.setAttribute("fill","transparent"),s.setAttribute("cursor","pointer"),this.group.appendChild(e),this.group.appendChild(s)}}class D{static create(t){let e=null;switch(t.type){case"BusElement":e=new T({id:t.id,x:t.x,y:t.y,length:t.length});break;case"BreakerElement":e=new q({id:t.id,x:t.x,y:t.y});break;case"TransformerElement":e=new Q({id:t.id,x:t.x,y:t.y});break;case"GeneratorElement":e=new Z({id:t.id,x:t.x,y:t.y});break;case"LoadElement":e=new tt({id:t.id,x:t.x,y:t.y});break;case"JunctionElement":e=new et({id:t.id,x:t.x,y:t.y});break;case"WireElement":e=new E({id:t.id,x:t.x,y:t.y,x2:t.x2,y2:t.y2,sourcePortId:t.sourcePortId,targetPortId:t.targetPortId});break}return e&&(e.rotation=t.rotation||0,e.name=t.name||"Element",e.description=t.description||""),e}}class st{constructor(){c(this,"elements",new Map);c(this,"sceneGroup",null)}setSceneGroup(t){this.sceneGroup=t}addElement(t){this.elements.set(t.id,t)}removeElement(t){this.elements.delete(t)}getElement(t){return this.elements.get(t)}getAllElements(){return Array.from(this.elements.values())}save(){const t=Array.from(this.elements.values()).map(e=>e.toJSON());return JSON.stringify(t,null,2)}load(t){if(!this.sceneGroup){console.error("Scene group not set in Project");return}this.elements.forEach(e=>{e.group.parentElement&&e.group.parentElement.removeChild(e.group)}),this.elements.clear(),m.emit("project:cleared",void 0);try{const e=JSON.parse(t);if(!Array.isArray(e))throw new Error("Invalid format");e.forEach(s=>{const i=D.create(s);i&&(i.updateTransform(),i.render(),i.mount(this.sceneGroup),this.addElement(i),m.emit("element:added",i))}),console.log("Project loaded successfully")}catch(e){console.error("Failed to load project",e)}}}const x=new st;class it{constructor(){c(this,"undoStack",[]);c(this,"redoStack",[])}execute(t){t.execute(),this.undoStack.push(t),this.redoStack=[],console.log("Command executed. Undo stack:",this.undoStack.length),m.emit("history:changed",void 0)}undo(){const t=this.undoStack.pop();t&&(t.undo(),this.redoStack.push(t),console.log("Undone"),m.emit("history:changed",void 0))}redo(){const t=this.redoStack.pop();t&&(t.execute(),this.undoStack.push(t),console.log("Redone"),m.emit("history:changed",void 0))}}const v=new it;class nt{constructor(t,e,s){c(this,"element");c(this,"secondaryElements");c(this,"sceneGroup");this.element=t,this.secondaryElements=e,this.sceneGroup=s}execute(){this.remove(this.element),this.secondaryElements.forEach(t=>this.remove(t))}undo(){this.restore(this.element),this.secondaryElements.forEach(t=>this.restore(t))}remove(t){t.group.parentElement&&t.group.parentElement.removeChild(t.group),x.removeElement(t.id),m.emit("element:removed",t)}restore(t){t.group.parentElement||t.mount(this.sceneGroup),x.addElement(t),m.emit("element:added",t)}}class ot{constructor(t,e,s,i,n){c(this,"element");c(this,"oldX");c(this,"oldY");c(this,"newX");c(this,"newY");this.element=t,this.oldX=e,this.oldY=s,this.newX=i,this.newY=n}execute(){this.element.x=this.newX,this.element.y=this.newY,this.element.updateTransform(),this.updateConnectedWires()}undo(){this.element.x=this.oldX,this.element.y=this.oldY,this.element.updateTransform(),this.updateConnectedWires()}updateConnectedWires(){const t=x.getAllElements().filter(n=>n instanceof E),e=n=>n&&n.startsWith(`${this.element.id}:`),s=this.element.getPorts(),i=new Map(s.map(n=>[n.id,n]));t.forEach(n=>{if(e(n.sourcePortId)){const o=i.get(n.sourcePortId);o&&(n.x=o.x,n.y=o.y,n.sourceDirection=o.direction||null,n.updateTransform(),n.render())}if(e(n.targetPortId)){const o=i.get(n.targetPortId);o&&n.setEnd(o.x,o.y,o.direction)}})}}class rt{constructor(t,e){c(this,"elements");c(this,"sceneGroup");this.elements=t,this.sceneGroup=e}execute(){this.elements.forEach(t=>{t.group.parentElement||t.mount(this.sceneGroup),x.addElement(t),m.emit("element:added",t)})}undo(){this.elements.forEach(t=>{t.group.parentElement&&t.group.parentElement.removeChild(t.group),x.removeElement(t.id),m.emit("element:removed",t)})}}class B{static copy(t){if(t.length===0){this.buffer=null;return}const e=t.map(s=>s.toJSON());this.buffer=JSON.stringify(e),console.log(`Copied ${t.length} elements to clipboard`)}static paste(){if(!this.buffer)return[];try{const t=JSON.parse(this.buffer);if(!Array.isArray(t))return[];const e=new Map,s=[];return t.forEach(i=>{const n=i.id,o=D.create(i);if(o){const r=crypto.randomUUID();o.id=r,o.group.setAttribute("id",r),o.x+=this.pasteOffset,o.y+=this.pasteOffset,o.updateTransform(),e.set(n,r),s.push(o)}}),s.forEach(i=>{if(i instanceof E){if(i.sourcePortId){const[n,o]=this.parsePortId(i.sourcePortId);if(e.has(n)){const r=e.get(n);i.sourcePortId=o?`${r}:${o}`:r}}if(i.targetPortId){const[n,o]=this.parsePortId(i.targetPortId);if(e.has(n)){const r=e.get(n);i.targetPortId=o?`${r}:${o}`:r}}}}),this.pasteOffset+=20,this.pasteOffset>100&&(this.pasteOffset=20),s}catch(t){return console.error("Failed to paste from clipboard",t),[]}}static parsePortId(t){const e=t.split(":");return e.length>1?[e[0],e.slice(1).join(":")]:[t,null]}}c(B,"buffer",null),c(B,"pasteOffset",20);class ct{constructor(t,e,s,i,n){c(this,"element");c(this,"oldX");c(this,"oldLength");c(this,"newX");c(this,"newLength");this.element=t,this.oldX=e,this.oldLength=s,this.newX=i,this.newLength=n}execute(){this.update(this.newX,this.newLength)}undo(){this.update(this.oldX,this.oldLength)}update(t,e){this.element.x=t,this.element.length=e,this.element.render(),this.element.updateTransform(),this.updateConnectedWires()}updateConnectedWires(){const t=x.getAllElements().filter(n=>n instanceof E),e=n=>n&&n.startsWith(`${this.element.id}:`),s=this.element.getPorts(),i=new Map(s.map(n=>[n.id,n]));t.forEach(n=>{if(e(n.sourcePortId)){const o=i.get(n.sourcePortId);o&&(n.x=o.x,n.y=o.y,n.updateTransform(),n.render())}if(e(n.targetPortId)){const o=i.get(n.targetPortId);o&&n.setEnd(o.x,o.y)}})}}class lt{constructor(t,e,s,i,n){c(this,"name","select");c(this,"isPanning",!1);c(this,"panStartX",0);c(this,"panStartY",0);c(this,"selectedElements",[]);c(this,"isDragging",!1);c(this,"dragStartX",0);c(this,"dragStartY",0);c(this,"elementStartPositions",new Map);c(this,"svg");c(this,"sceneGroup");c(this,"interactionGroup");c(this,"highlightGroup");c(this,"view");c(this,"updateFn");c(this,"isSelecting",!1);c(this,"selectionStartX",0);c(this,"selectionStartY",0);c(this,"selectionBox");c(this,"resizeHandles",[]);c(this,"activeHandle",null);c(this,"initialLength",0);c(this,"initialX",0);c(this,"onKeyDown",t=>{var s;const e=(s=document.activeElement)==null?void 0:s.tagName.toLowerCase();if(!(e==="input"||e==="textarea")&&((t.key==="Delete"||t.key==="Backspace")&&this.deleteSelection(),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="c"&&(t.preventDefault(),B.copy(this.selectedElements)),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="v")){t.preventDefault();const i=B.paste();if(i.length>0){const n=new rt(i,this.sceneGroup);v.execute(n),this.selectedElements=i,this.updateHighlights(),m.emit("selection:changed",this.selectedElements)}}});this.svg=t,this.sceneGroup=e,this.interactionGroup=s,this.view=i,this.updateFn=n,this.highlightGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.interactionGroup.appendChild(this.highlightGroup),this.selectionBox=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.selectionBox.setAttribute("fill","rgba(0, 120, 215, 0.1)"),this.selectionBox.setAttribute("stroke","rgba(0, 120, 215, 0.5)"),this.selectionBox.setAttribute("stroke-width","1"),this.selectionBox.setAttribute("display","none"),this.interactionGroup.appendChild(this.selectionBox);for(let o=0;o<2;o++){const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("width","10"),r.setAttribute("height","10"),r.setAttribute("fill","white"),r.setAttribute("stroke","#0078d7"),r.setAttribute("stroke-width","1"),r.setAttribute("display","none"),r.style.cursor="ew-resize",r.style.pointerEvents="all",this.interactionGroup.appendChild(r),this.resizeHandles.push(r)}}activate(){this.svg.style.cursor="default",window.addEventListener("keydown",this.onKeyDown)}deactivate(){this.isPanning=!1,this.isDragging=!1,this.isSelecting=!1,this.clearSelection(),window.removeEventListener("keydown",this.onKeyDown)}deleteSelection(){if(this.selectedElements.length===0)return;[...this.selectedElements].forEach(e=>{const s=[];e instanceof E||x.getAllElements().filter(o=>o instanceof E).forEach(o=>{e.getPorts().some(r=>o.sourcePortId===r.id||o.targetPortId===r.id)&&s.push(o)});const i=new nt(e,s,this.sceneGroup);v.execute(i)}),this.selectedElements=[],this.updateHighlights(),m.emit("selection:changed",[]),console.log("Deleted elements")}clearSelection(){this.selectedElements=[],this.updateHighlights(),m.emit("selection:changed",[])}updateHighlights(){if(this.highlightGroup.innerHTML="",this.resizeHandles.forEach(t=>t.setAttribute("display","none")),this.selectedElements.forEach(t=>{const e=t.group.getBBox(),s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x",`${e.x-5}`),s.setAttribute("y",`${e.y-5}`),s.setAttribute("width",`${e.width+10}`),s.setAttribute("height",`${e.height+10}`),s.setAttribute("fill","rgba(0, 120, 215, 0.1)"),s.setAttribute("stroke","#0078d7"),s.setAttribute("stroke-width","2"),s.setAttribute("stroke-dasharray","4"),s.style.pointerEvents="none",s.setAttribute("transform",`translate(${t.x}, ${t.y}) rotate(${t.rotation})`),this.highlightGroup.appendChild(s)}),this.selectedElements.length===1&&this.selectedElements[0]instanceof T){const e=this.selectedElements[0].getPorts(),s=e.find(n=>n.id.endsWith(":left")),i=e.find(n=>n.id.endsWith(":right"));if(s&&i){const n=10/this.view.scale,o=n/2,r=(a,u,d)=>{a.setAttribute("width",`${n}`),a.setAttribute("height",`${n}`),a.setAttribute("x",`${u-o}`),a.setAttribute("y",`${d-o}`),a.setAttribute("display","block")};r(this.resizeHandles[0],s.x,s.y),r(this.resizeHandles[1],i.x,i.y)}}}findElementFromTarget(t){if(!(t instanceof Element))return null;let e=t;for(;e&&e!==this.svg;){if(e.tagName==="g"&&e.hasAttribute("id")){const s=e.getAttribute("id");if(s)return x.getElement(s)||null}e=e.parentElement}return null}getWorldPosition(t){const e=this.svg.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;return{x:(s-this.view.x)/this.view.scale,y:(i-this.view.y)/this.view.scale}}onMouseDown(t){if(t.button===1){this.startPan(t);return}if(t.button===0){if(this.resizeHandles.includes(t.target)){const s=this.resizeHandles.indexOf(t.target);if(this.activeHandle=s===0?"left":"right",this.selectedElements.length===1&&this.selectedElements[0]instanceof T){const i=this.selectedElements[0];this.initialLength=i.length,this.initialX=i.x}return}const e=this.findElementFromTarget(t.target);if(e){t.shiftKey?(this.selectedElements.includes(e)?this.selectedElements=this.selectedElements.filter(i=>i!==e):this.selectedElements.push(e),this.updateHighlights(),m.emit("selection:changed",this.selectedElements)):this.selectedElements.includes(e)||(this.selectedElements=[e],this.updateHighlights(),m.emit("selection:changed",this.selectedElements)),this.isDragging=!0;const s=this.getWorldPosition(t);this.dragStartX=s.x,this.dragStartY=s.y,this.elementStartPositions.clear(),this.selectedElements.forEach(i=>{this.elementStartPositions.set(i.id,{x:i.x,y:i.y})})}else{t.shiftKey||this.clearSelection(),this.isSelecting=!0;const s=this.getWorldPosition(t);this.selectionStartX=s.x,this.selectionStartY=s.y,this.selectionBox.setAttribute("x",`${s.x}`),this.selectionBox.setAttribute("y",`${s.y}`),this.selectionBox.setAttribute("width","0"),this.selectionBox.setAttribute("height","0"),this.selectionBox.setAttribute("display","block")}}}startPan(t){this.isPanning=!0,this.panStartX=t.clientX,this.panStartY=t.clientY,this.svg.style.cursor="grabbing"}onMouseMove(t){if(this.isPanning){const e=t.clientX-this.panStartX,s=t.clientY-this.panStartY;this.view.x+=e,this.view.y+=s,this.panStartX=t.clientX,this.panStartY=t.clientY,this.updateFn();return}if(this.activeHandle){const e=this.getWorldPosition(t);if(this.selectedElements.length===1&&this.selectedElements[0]instanceof T){const s=this.selectedElements[0],i=s.length,n=s.x,o=i/2;let r=i,a=n;if(this.activeHandle==="right"){const u=n-o,d=e.x,f=Math.round(d/20)*20;f>u&&(r=f-u,a=u+r/2)}else{const u=n+o,d=e.x,f=Math.round(d/20)*20;f<u&&(r=u-f,a=f+r/2)}r>0&&(r!==s.length||a!==s.x)&&(s.length=r,s.x=a,s.render(),s.updateTransform(),this.updateConnectedWires(s),this.updateHighlights())}return}if(this.isSelecting){const e=this.getWorldPosition(t),s=Math.min(this.selectionStartX,e.x),i=Math.min(this.selectionStartY,e.y),n=Math.abs(e.x-this.selectionStartX),o=Math.abs(e.y-this.selectionStartY);this.selectionBox.setAttribute("x",`${s}`),this.selectionBox.setAttribute("y",`${i}`),this.selectionBox.setAttribute("width",`${n}`),this.selectionBox.setAttribute("height",`${o}`);return}if(this.isDragging&&this.selectedElements.length>0){const e=this.getWorldPosition(t),s=e.x-this.dragStartX,i=e.y-this.dragStartY;this.selectedElements.forEach(n=>{if(n instanceof E)return;const o=this.elementStartPositions.get(n.id);if(!o)return;let r=o.x+s,a=o.y+i;r=Math.round(r/20)*20,a=Math.round(a/20)*20,(r!==n.x||a!==n.y)&&(n.x=r,n.y=a,n.updateTransform(),this.updateConnectedWires(n),this.updateHighlights())})}}updateConnectedWires(t){const e=x.getAllElements().filter(o=>o instanceof E),s=o=>o&&o.startsWith(`${t.id}:`),i=t.getPorts(),n=new Map(i.map(o=>[o.id,o]));e.forEach(o=>{if(s(o.sourcePortId)){const r=n.get(o.sourcePortId);r&&(o.x=r.x,o.y=r.y,o.sourceDirection=r.direction||null,o.updateTransform(),o.render())}if(s(o.targetPortId)){const r=n.get(o.targetPortId);r&&o.setEnd(r.x,r.y,r.direction)}})}onMouseUp(t){if(this.activeHandle){if(this.activeHandle=null,this.svg.style.cursor="default",this.selectedElements.length===1&&this.selectedElements[0]instanceof T){const e=this.selectedElements[0];if(e.length!==this.initialLength||e.x!==this.initialX){const s=new ct(e,this.initialX,this.initialLength,e.x,e.length);v.execute(s),console.log("Resize recorded")}}this.updateHighlights();return}if(this.isSelecting){this.isSelecting=!1,this.selectionBox.setAttribute("display","none");const e=parseFloat(this.selectionBox.getAttribute("x")||"0"),s=parseFloat(this.selectionBox.getAttribute("y")||"0"),i=parseFloat(this.selectionBox.getAttribute("width")||"0"),n=parseFloat(this.selectionBox.getAttribute("height")||"0"),o=x.getAllElements().filter(r=>{if(r instanceof E){const a=(r.x+r.x2)/2,u=(r.y+r.y2)/2;return a>=e&&a<=e+i&&u>=s&&u<=s+n}return r.x>=e&&r.x<=e+i&&r.y>=s&&r.y<=s+n});t.shiftKey?o.forEach(r=>{this.selectedElements.includes(r)||this.selectedElements.push(r)}):this.selectedElements=o,this.updateHighlights(),m.emit("selection:changed",this.selectedElements)}if(this.isDragging){this.isDragging=!1;let e=!1;this.selectedElements.forEach(s=>{const i=this.elementStartPositions.get(s.id);i&&(s.x!==i.x||s.y!==i.y)&&(e=!0)}),e&&this.selectedElements.forEach(s=>{const i=this.elementStartPositions.get(s.id);if(i&&(s.x!==i.x||s.y!==i.y)){const n=new ot(s,i.x,i.y,s.x,s.y);v.execute(n)}})}this.isPanning=!1,this.svg.style.cursor="default"}}class U{constructor(t,e){c(this,"element");c(this,"sceneGroup");this.element=t,this.sceneGroup=e}execute(){this.element.group.parentElement||this.element.mount(this.sceneGroup),x.addElement(this.element),m.emit("element:added",this.element)}undo(){this.element.group.parentElement&&this.element.group.parentElement.removeChild(this.element.group),x.removeElement(this.element.id),m.emit("element:removed",this.element)}}const at="http://www.w3.org/2000/svg";class ht{constructor(t,e,s){c(this,"name","wire");c(this,"svg");c(this,"sceneGroup");c(this,"getView");c(this,"isDrawing",!1);c(this,"activeWire",null);c(this,"startPort",null);c(this,"highlightCircle");this.svg=t,this.sceneGroup=e,this.getView=s,this.highlightCircle=document.createElementNS(at,"circle"),this.highlightCircle.setAttribute("r","5"),this.highlightCircle.setAttribute("fill","rgba(0, 255, 0, 0.5)"),this.highlightCircle.setAttribute("stroke","green"),this.highlightCircle.setAttribute("stroke-width","1"),this.highlightCircle.style.display="none",this.highlightCircle.style.pointerEvents="none"}activate(){this.svg.style.cursor="crosshair",this.svg.appendChild(this.highlightCircle)}deactivate(){this.isDrawing&&this.activeWire&&(this.sceneGroup.removeChild(this.activeWire.group),this.activeWire=null,this.isDrawing=!1),this.highlightCircle.parentElement&&this.highlightCircle.parentElement.removeChild(this.highlightCircle)}getWorldPosition(t){const e=this.getView(),s=this.svg.getBoundingClientRect(),i=t.clientX-s.left,n=t.clientY-s.top;return{x:(i-e.x)/e.scale,y:(n-e.y)/e.scale}}findNearestPort(t,e){let i=null,n=15;for(const o of x.getAllElements())if(!(o instanceof E))for(const r of o.getPorts()){const a=r.x-t,u=r.y-e,d=Math.sqrt(a*a+u*u);d<n&&(n=d,i=r)}return i}updateHighlight(t){t?(this.highlightCircle.style.display="block",this.highlightCircle.parentElement!==this.sceneGroup&&this.sceneGroup.appendChild(this.highlightCircle),this.highlightCircle.setAttribute("cx",`${t.x}`),this.highlightCircle.setAttribute("cy",`${t.y}`)):this.highlightCircle.style.display="none"}onMouseDown(t){if(t.button!==0)return;const e=this.getWorldPosition(t),s=this.findNearestPort(e.x,e.y);s&&(this.isDrawing=!0,this.startPort=s,document.body.classList.add("no-select"),this.activeWire=new E({x:s.x,y:s.y,x2:s.x,y2:s.y,sourcePortId:s.id,sourceDirection:s.direction}),this.activeWire.mount(this.sceneGroup))}onMouseMove(t){const e=this.getWorldPosition(t),s=this.findNearestPort(e.x,e.y);if(this.updateHighlight(s),this.isDrawing&&this.activeWire){let i=e.x,n=e.y,o;s&&(i=s.x,n=s.y,o=s.direction),this.activeWire.setEnd(i,n,o)}}onMouseUp(t){if(!this.isDrawing)return;const e=this.getWorldPosition(t),s=this.findNearestPort(e.x,e.y);if(s&&this.activeWire&&this.startPort&&s.id!==this.startPort.id){this.activeWire.targetPortId=s.id,this.activeWire.setEnd(s.x,s.y,s.direction),this.activeWire.group.parentElement&&this.activeWire.group.parentElement.removeChild(this.activeWire.group);const i=new U(this.activeWire,this.sceneGroup);v.execute(i),console.log(`Connected ${this.startPort.id} to ${s.id}`)}else this.activeWire&&this.sceneGroup.removeChild(this.activeWire.group);this.activeWire=null,this.isDrawing=!1,this.startPort=null,document.body.classList.remove("no-select")}}class R{constructor(t,e){c(this,"element");c(this,"oldRotation");c(this,"newRotation");this.element=t,this.oldRotation=t.rotation,this.newRotation=e}execute(){this.element.rotation=this.newRotation,this.element.updateTransform(),this.updateConnectedWires()}undo(){this.element.rotation=this.oldRotation,this.element.updateTransform(),this.updateConnectedWires()}updateConnectedWires(){const t=x.getAllElements().filter(n=>n instanceof E),e=n=>n&&n.startsWith(`${this.element.id}:`),s=this.element.getPorts(),i=new Map(s.map(n=>[n.id,n]));t.forEach(n=>{if(e(n.sourcePortId)){const o=i.get(n.sourcePortId);o&&(n.x=o.x,n.y=o.y,n.sourceDirection=o.direction||null,n.updateTransform(),n.render())}if(e(n.targetPortId)){const o=i.get(n.targetPortId);o&&n.setEnd(o.x,o.y,o.direction)}})}}class dt{constructor(t,e,s,i,n){c(this,"element");c(this,"oldName");c(this,"newName");c(this,"oldDesc");c(this,"newDesc");this.element=t,this.oldName=e,this.newName=s,this.oldDesc=i,this.newDesc=n}execute(){this.element.name=this.newName,this.element.description=this.newDesc,this.element.render()}undo(){this.element.name=this.oldName,this.element.description=this.oldDesc,this.element.render()}}class ut{constructor(t){c(this,"container");c(this,"items",[]);c(this,"elementMap",new Map);const e=document.getElementById(t);if(!e)throw new Error(`Toolbar container ${t} not found`);this.container=e,this.container.innerHTML=""}addItem(t){this.items.push(t)}addSeparator(){this.items.push({id:`sep-${Math.random()}`,label:"",type:"action",onClick:()=>{},group:"__separator__"})}render(){this.container.innerHTML="",this.elementMap.clear();let t=null;this.items.forEach((e,s)=>{if(e.group==="__separator__"){const o=document.createElement("div");o.className="separator",this.container.appendChild(o),t=null;return}t||(t=document.createElement("div"),t.className="toolbar-group",this.container.appendChild(t));const i=document.createElement("button");i.id=e.id,i.className="tool-btn",e.title?i.title=e.title:e.label&&(i.title=e.label),e.icon?(e.icon.includes("<svg")?i.innerHTML=e.icon:i.textContent=e.icon,i.classList.add("icon-btn")):(i.textContent=e.label,i.classList.add("text-btn")),e.draggable&&(i.draggable=!0,i.addEventListener("dragstart",o=>{o.dataTransfer&&(o.dataTransfer.setData("application/esld-tool",e.id),o.dataTransfer.effectAllowed="copy")})),i.addEventListener("click",()=>{e.onClick(),this.updateActiveState()}),this.elementMap.set(e.id,i),t.appendChild(i);const n=this.items[s+1];n&&n.group==="__separator__"&&(t=null)}),this.updateActiveState()}setActive(t){this.elementMap.forEach(s=>s.classList.remove("active"));const e=this.elementMap.get(t);e&&e.classList.add("active")}updateActiveState(){this.items.forEach(t=>{t.isActive&&t.isActive()&&this.setActive(t.id)})}}const A=document.getElementById("main-svg"),I="http://www.w3.org/2000/svg";let p={x:0,y:0,scale:1},P,L,k,$;const _={"btn-bus":(l,t)=>D.create({type:"BusElement",x:l,y:t,length:100}),"btn-breaker":(l,t)=>D.create({type:"BreakerElement",x:l,y:t}),"btn-transformer":(l,t)=>D.create({type:"TransformerElement",x:l,y:t}),"btn-gen":(l,t)=>D.create({type:"GeneratorElement",x:l,y:t}),"btn-load-elem":(l,t)=>D.create({type:"LoadElement",x:l,y:t}),"btn-junction":(l,t)=>D.create({type:"JunctionElement",x:l,y:t})};function gt(l,t){const e=A.getBoundingClientRect(),s=l-e.left,i=t-e.top,n=(s-p.x)/p.scale,o=(i-p.y)/p.scale;return{x:Math.round(n/20)*20,y:Math.round(o/20)*20}}function pt(){var f,w;if(!A)return;const l=document.createElementNS(I,"defs");k=document.createElementNS(I,"pattern"),k.setAttribute("id","grid-pattern"),k.setAttribute("width","20"),k.setAttribute("height","20"),k.setAttribute("patternUnits","userSpaceOnUse");const t=document.createElementNS(I,"path");t.setAttribute("d","M 20 0 L 0 0 0 20"),t.setAttribute("fill","none"),t.setAttribute("stroke","#e0e0e0"),t.setAttribute("stroke-width","1"),k.appendChild(t),l.appendChild(k),A.appendChild(l);const e=document.createElementNS(I,"rect");e.setAttribute("width","100%"),e.setAttribute("height","100%"),e.setAttribute("fill","url(#grid-pattern)"),e.style.cursor="grab",A.appendChild(e),P=document.createElementNS(I,"g"),P.setAttribute("id","scene-layer"),A.appendChild(P),L=document.createElementNS(I,"g"),L.setAttribute("id","interaction-layer"),L.style.pointerEvents="none",A.appendChild(L),x.setSceneGroup(P),$=new K;const s=()=>p,i=document.getElementById("prop-form"),n=document.querySelector(".empty-state"),o=document.getElementById("prop-name"),r=document.getElementById("prop-desc");let a=null;const u=()=>{if(!a||a.name===o.value&&a.description===r.value)return;const h=new dt(a,a.name,o.value,a.description,r.value);v.execute(h)};o==null||o.addEventListener("change",u),r==null||r.addEventListener("change",u),(f=document.getElementById("btn-rotate-cw"))==null||f.addEventListener("click",()=>{if(!a||a instanceof E)return;const h=(a.rotation+90)%360,g=new R(a,h);v.execute(g)}),(w=document.getElementById("btn-rotate-ccw"))==null||w.addEventListener("click",()=>{if(!a||a instanceof E)return;let h=(a.rotation-90)%360;h<0&&(h+=360);const g=new R(a,h);v.execute(g)}),m.on("selection:changed",h=>{h.length>0?(a=h[0],i.style.display="block",n.style.display="none",o.value=a.name,r.value=a.description):(a=null,i.style.display="none",n.style.display="block")}),m.on("history:changed",()=>{a&&(o.value=a.name,r.value=a.description)}),$.registerTool(new lt(A,P,L,p,V)),$.registerTool(new ht(A,P,s)),A.addEventListener("mousedown",h=>$.onMouseDown(h)),window.addEventListener("mousemove",h=>$.onMouseMove(h)),window.addEventListener("mouseup",h=>$.onMouseUp(h)),A.addEventListener("wheel",ft,{passive:!1}),A.addEventListener("dragover",h=>{h.preventDefault(),h.dataTransfer.dropEffect="copy"}),A.addEventListener("drop",h=>{h.preventDefault();const g=h.dataTransfer.getData("application/esld-tool");if(!g||!_[g])return;const{x:S,y}=gt(h.clientX,h.clientY),C=_[g](S,y);if(C){const b=new U(C,P);v.execute(b)}}),window.addEventListener("keydown",h=>{var S;const g=(S=document.activeElement)==null?void 0:S.tagName.toLowerCase();g==="input"||g==="textarea"||((h.ctrlKey||h.metaKey)&&h.key.toLowerCase()==="z"?h.shiftKey?(h.preventDefault(),v.redo()):(h.preventDefault(),v.undo()):(h.ctrlKey||h.metaKey)&&h.key.toLowerCase()==="y"&&(h.preventDefault(),v.redo()))});const d=new ut("toolbar");d.addItem({id:"btn-select",label:"Select",title:"Select Tool",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z'/></svg>",onClick:()=>$.activateTool("select")}),d.addItem({id:"btn-wire",label:"Wire",title:"Wire Tool",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M4 4h16v2H4zm0 7h16v2H4zm0 7h16v2H4z'/></svg>",onClick:()=>$.activateTool("wire")}),d.addSeparator(),d.addItem({id:"btn-bus",label:"Bus",title:"Busbar Component (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='4' y='10' width='16' height='4' rx='1'/></svg>",draggable:!0,onClick:()=>{}}),d.addItem({id:"btn-breaker",label:"Brk",title:"Circuit Breaker (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M4 12h6l2-2 2 2h6v2h-6l-2 2-2-2H4z'/></svg>",draggable:!0,onClick:()=>{}}),d.addItem({id:"btn-transformer",label:"Trafo",title:"Transformer Component (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><circle cx='8' cy='12' r='3'/><circle cx='16' cy='12' r='3'/><path d='M11 12h2'/></svg>",draggable:!0,onClick:()=>{}}),d.addItem({id:"btn-gen",label:"Gen",title:"Generator Component (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><circle cx='12' cy='12' r='4'/><path d='M12 2v6m0 8v6m11-7h-6m-8 0H1'/></svg>",draggable:!0,onClick:()=>{}}),d.addItem({id:"btn-load-elem",label:"Load",title:"Load Component (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12 2l2 7h7l-5.5 4 2 7L12 16l-5.5 4 2-7L3 9h7z'/></svg>",draggable:!0,onClick:()=>{}}),d.addItem({id:"btn-junction",label:"Node",title:"Junction/Node (Drag to add)",type:"tool",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><circle cx='12' cy='12' r='2'/><path d='M12 4v6m0 4v6m8-8h-6m-4 0H4'/></svg>",draggable:!0,onClick:()=>{}}),d.addSeparator(),d.addItem({id:"btn-save",label:"Save",title:"Save Project",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z'/></svg>",onClick:()=>{const h=x.save();localStorage.setItem("esld_project",h),alert("Project Saved to LocalStorage!")}}),d.addItem({id:"btn-load",label:"Load",title:"Load Project",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z'/></svg>",onClick:()=>{const h=localStorage.getItem("esld_project");h?x.load(h):alert("No saved project found!")}}),d.addItem({id:"btn-export",label:"Export",title:"Export as PNG",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z'/></svg>",onClick:mt}),d.addSeparator(),d.addItem({id:"btn-undo",label:"Undo",title:"Undo Last Action",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z'/></svg>",onClick:()=>v.undo()}),d.addItem({id:"btn-redo",label:"Redo",title:"Redo Last Action",type:"action",icon:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z'/></svg>",onClick:()=>v.redo()}),d.render(),$.activateTool("select")}function mt(){const l=P.getBBox(),t=50,e=l.width+t*2||800,s=l.height+t*2||600,i=l.x-t||0,n=l.y-t||0,o=P.cloneNode(!0);o.removeAttribute("transform");const r=`
    <svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${s}" viewBox="${i} ${n} ${e} ${s}">
        <style>
            text { font-family: sans-serif; }
        </style>
        <rect x="${i}" y="${n}" width="${e}" height="${s}" fill="white"/>
        ${o.outerHTML}
    </svg>`,a=new Blob([r],{type:"image/svg+xml;charset=utf-8"}),u=URL.createObjectURL(a),d=new Image;d.onload=()=>{const f=document.createElement("canvas");f.width=e,f.height=s;const w=f.getContext("2d");if(w){w.drawImage(d,0,0);const h=f.toDataURL("image/png"),g=document.createElement("a");g.href=h,g.download="diagram.png",document.body.appendChild(g),g.click(),document.body.removeChild(g)}URL.revokeObjectURL(u)},d.src=u}function V(){const l=`translate(${p.x}, ${p.y}) scale(${p.scale})`;P.setAttribute("transform",l),L.setAttribute("transform",l),k.setAttribute("patternTransform",`translate(${p.x%(20*p.scale)}, ${p.y%(20*p.scale)}) scale(${p.scale})`)}function ft(l){l.preventDefault();const t=.1,e=l.deltaY<0?1:-1,s=Math.exp(e*t),i=A.getBoundingClientRect(),n=l.clientX-i.left,o=l.clientY-i.top,r=p.scale*s;r<.1||r>10||(p.x=n-(n-p.x)*s,p.y=o-(o-p.y)*s,p.scale=r,V())}pt();
